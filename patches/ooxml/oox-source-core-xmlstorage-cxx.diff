--- /dev/null	
+++ oox/source/core/xmlstorage.cxx	
@@ -0,0 +1,176 @@
+/*************************************************************************
+ *
+ *  OpenOffice.org - a multi-platform office productivity suite
+ *
+ *  $RCSfile: xmlstorage.cxx,v $
+ *
+ *  $Revision: 1.1.2.4 $
+ *
+ *  last change: $Author: dr $ $Date: 2007/06/06 13:06:09 $
+ *
+ *  The Contents of this file are made available subject to
+ *  the terms of GNU Lesser General Public License Version 2.1.
+ *
+ *
+ *    GNU Lesser General Public License Version 2.1
+ *    =============================================
+ *    Copyright 2005 by Sun Microsystems, Inc.
+ *    901 San Antonio Road, Palo Alto, CA 94303, USA
+ *
+ *    This library is free software; you can redistribute it and/or
+ *    modify it under the terms of the GNU Lesser General Public
+ *    License version 2.1, as published by the Free Software Foundation.
+ *
+ *    This library is distributed in the hope that it will be useful,
+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *    Lesser General Public License for more details.
+ *
+ *    You should have received a copy of the GNU Lesser General Public
+ *    License along with this library; if not, write to the Free Software
+ *    Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+ *    MA  02111-1307  USA
+ *
+ ************************************************************************/
+
+#include "oox/core/xmlstorage.hxx"
+#include <com/sun/star/lang/XMultiServiceFactory.hpp>
+#include <com/sun/star/embed/XStorage.hpp>
+#include <com/sun/star/io/XInputStream.hpp>
+#include <com/sun/star/io/XOutputStream.hpp>
+#include <comphelper/storagehelper.hxx>
+#include "oox/core/helper.hxx"
+
+using ::rtl::OUString;
+using ::com::sun::star::uno::Any;
+using ::com::sun::star::uno::Reference;
+using ::com::sun::star::uno::Sequence;
+using ::com::sun::star::uno::Exception;
+using ::com::sun::star::uno::UNO_QUERY;
+using ::com::sun::star::lang::XMultiServiceFactory;
+using ::com::sun::star::embed::XStorage;
+using ::com::sun::star::io::XInputStream;
+using ::com::sun::star::io::XOutputStream;
+
+namespace oox {
+namespace core {
+
+// ============================================================================
+
+XmlStorage::XmlStorage(
+        const Reference< XMultiServiceFactory >& rxFactory,
+        const Reference< XInputStream >& rxInStream ) :
+    StorageBase( rxInStream, false )
+{
+    OSL_ENSURE( rxFactory.is(), "XmlStorage::XmlStorage - missing service factory" );
+    // create base storage object
+    try
+    {
+        mxStorage = ::comphelper::OStorageHelper::GetStorageFromInputStream( rxInStream, rxFactory );
+    }
+    catch( Exception& )
+    {
+        OSL_ENSURE( false, "XmlStorage::XmlStorage - cannot open input storage" );
+    }
+}
+
+XmlStorage::XmlStorage(
+        const Reference< XMultiServiceFactory >& rxFactory,
+        const Reference< XOutputStream >& rxOutStream ) :
+    StorageBase( rxOutStream, false )
+{
+    OSL_ENSURE( rxFactory.is(), "XmlStorage::XmlStorage - missing service factory" );
+    (void)rxFactory;   // prevent compiler warning
+    OSL_ENSURE( false, "XmlStorage::XmlStorage - not implemented" );
+}
+
+XmlStorage::XmlStorage( const XmlStorage& rParentStorage, const Reference< XStorage >& rxStorage, const OUString& rElementName ) :
+    StorageBase( rParentStorage, rElementName ),
+    mxStorage( rxStorage )
+{
+    OSL_ENSURE( mxStorage.is(), "XmlStorage::XmlStorage - missing storage" );
+}
+
+XmlStorage::~XmlStorage()
+{
+}
+
+bool XmlStorage::implIsStorage() const
+{
+    return mxStorage.is();
+}
+
+Reference< XStorage > XmlStorage::implGetXStorage() const
+{
+    return mxStorage;
+}
+
+void XmlStorage::implGetElementNames( ::std::vector< OUString >& orElementNames ) const
+{
+    Sequence< OUString > aNames;
+    if( mxStorage.is() ) try
+    {
+        aNames = mxStorage->getElementNames();
+        if( aNames.getLength() > 0 )
+            orElementNames.insert( orElementNames.end(), aNames.getConstArray(), aNames.getConstArray() + aNames.getLength() );
+    }
+    catch( Exception& )
+    {
+    }
+}
+
+StorageRef XmlStorage::implOpenSubStorage( const OUString& rElementName, bool bCreate )
+{
+    OSL_ENSURE( !bCreate, "XmlStorage::implOpenSubStorage - creating new sub storages not implemented" );
+    (void)bCreate;  // prevent compiler warning
+
+    Reference< XStorage > xSubXStorage;
+    try
+    {
+        // XStorage::isStorageElement may throw various exceptions...
+        if( mxStorage->isStorageElement( rElementName ) )
+            xSubXStorage = mxStorage->openStorageElement(
+                rElementName, ::com::sun::star::embed::ElementModes::READ );
+    }
+    catch( Exception& )
+    {
+    }
+
+    StorageRef xSubStorage;
+    if( xSubXStorage.is() )
+        xSubStorage.reset( new XmlStorage( *this, xSubXStorage, rElementName ) );
+    return xSubStorage;
+}
+
+Reference< XInputStream > XmlStorage::implOpenInputStream( const OUString& rElementName )
+{
+    Reference< XInputStream > xInStream;
+    if( mxStorage.is() ) try
+    {
+        xInStream.set( mxStorage->openStreamElement( rElementName, ::com::sun::star::embed::ElementModes::READ ), UNO_QUERY );
+    }
+    catch( Exception& )
+    {
+    }
+    return xInStream;
+}
+
+Reference< XOutputStream > XmlStorage::implOpenOutputStream( const OUString& rElementName )
+{
+    Reference< XOutputStream > xOutStream;
+    if( mxStorage.is() ) try
+    {
+        (void)rElementName;
+        OSL_ENSURE( false, "XmlStorage::implOpenOutputStream - not implemented" );
+    }
+    catch( Exception& )
+    {
+    }
+    return xOutStream;
+}
+
+// ============================================================================
+
+} // namespace core
+} // namespace oox
+
