Index: xmloff/source/draw/animimp.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/draw/animimp.cxx,v
retrieving revision 1.13
retrieving revision 1.13.76.1
diff -u -p -u -p -r1.13 -r1.13.76.1
--- xmloff/source/draw/animimp.cxx	26 Nov 2004 19:31:39 -0000	1.13
+++ xmloff/source/draw/animimp.cxx	22 Feb 2005 15:17:32 -0000	1.13.76.1
@@ -405,7 +405,6 @@ class AnimImpImpl
 {
 public:
 	Reference< XPropertySet > mxLastShape;
-	sal_Int32 mnPresOrder;
 	OUString maLastShapeId;
 
 	OUString msDimColor;
@@ -423,8 +422,7 @@ public:
 	OUString msIsAnimation;
 
 	AnimImpImpl()
-	:	mnPresOrder( 0 ),
-		msDimColor( RTL_CONSTASCII_USTRINGPARAM( "DimColor" ) ),
+	:	msDimColor( RTL_CONSTASCII_USTRINGPARAM( "DimColor" ) ),
 		msDimHide( RTL_CONSTASCII_USTRINGPARAM( "DimHide" ) ),
 		msDimPrev( RTL_CONSTASCII_USTRINGPARAM( "DimPrevious" ) ),
 		msEffect( RTL_CONSTASCII_USTRINGPARAM( "Effect" ) ),
@@ -666,9 +664,6 @@ void XMLAnimationsEffectContext::EndElem
 
 					mpImpl->maLastShapeId = maShapeId;
 					mpImpl->mxLastShape = xSet;
-
-					aAny <<= mpImpl->mnPresOrder++;
-					xSet->setPropertyValue( mpImpl->msPresOrder, aAny );
 				}
 			}
 			else
Index: xmloff/source/draw/shapeexport2.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/draw/shapeexport2.cxx,v
retrieving revision 1.43
retrieving revision 1.43.18.1
diff -u -p -u -p -r1.43 -r1.43.18.1
--- xmloff/source/draw/shapeexport2.cxx	27 Jan 2005 11:09:19 -0000	1.43
+++ xmloff/source/draw/shapeexport2.cxx	14 Feb 2005 09:42:57 -0000	1.43.18.1
@@ -594,7 +594,11 @@ void XMLShapeExport::ImpExportEvents( co
 			{
 				SvXMLElementExport aEventsElemt(rExport, XML_NAMESPACE_OFFICE, XML_EVENT_LISTENERS, sal_True, sal_True);
 
-				rExport.AddAttribute( XML_NAMESPACE_SCRIPT, XML_LANGUAGE, OUString( RTL_CONSTASCII_USTRINGPARAM( "starbasic" ) ) );
+				rExport.AddAttribute( XML_NAMESPACE_SCRIPT, XML_LANGUAGE, 
+							rExport.GetNamespaceMap().GetQNameByKey(
+							 	XML_NAMESPACE_OOO, 
+							 	OUString( RTL_CONSTASCII_USTRINGPARAM( 
+												"starbasic" ) ) ) );
 				OUString aEventQName(
 					rExport.GetNamespaceMap().GetQNameByKey(
 							XML_NAMESPACE_DOM, OUString( RTL_CONSTASCII_USTRINGPARAM( "click" ) ) ) );
@@ -628,13 +632,17 @@ void XMLShapeExport::ImpExportEvents( co
 		{
 			if( nFound & FOUND_MACRO )
 			{
-				SvXMLElementExport aEventsElemt(rExport, XML_NAMESPACE_OFFICE, XML_EVENTS, sal_True, sal_True);
+				SvXMLElementExport aEventsElemt(rExport, XML_NAMESPACE_OFFICE, XML_EVENT_LISTENERS, sal_True, sal_True);
 
-				rExport.AddAttribute( XML_NAMESPACE_SCRIPT, XML_LANGUAGE, XML_SCRIPT );
-				rExport.AddAttribute( XML_NAMESPACE_SCRIPT, XML_EVENT_NAME, OUString( RTL_CONSTASCII_USTRINGPARAM( "on-click" ) ) );
+				rExport.AddAttribute( XML_NAMESPACE_SCRIPT, XML_LANGUAGE, rExport.GetNamespaceMap().GetQNameByKey(
+							 XML_NAMESPACE_OOO, GetXMLToken(XML_SCRIPT) ) );
+				OUString aEventQName(
+					rExport.GetNamespaceMap().GetQNameByKey(
+							XML_NAMESPACE_DOM, OUString( RTL_CONSTASCII_USTRINGPARAM( "click" ) ) ) );
+				rExport.AddAttribute( XML_NAMESPACE_SCRIPT, XML_EVENT_NAME, aEventQName );
 				rExport.AddAttribute( XML_NAMESPACE_XLINK, XML_HREF, aStrMacro );
 
-				SvXMLElementExport aEventElemt(rExport, XML_NAMESPACE_SCRIPT, XML_EVENT, sal_True, sal_True);
+				SvXMLElementExport aEventElemt(rExport, XML_NAMESPACE_SCRIPT, XML_EVENT_LISTENER, sal_True, sal_True);
 			}
 		}
 	}
Index: xmloff/source/transform/Oasis2OOo.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/transform/Oasis2OOo.cxx,v
retrieving revision 1.13
retrieving revision 1.13.20.1
diff -u -p -u -p -r1.13 -r1.13.20.1
--- xmloff/source/transform/Oasis2OOo.cxx	27 Jan 2005 11:28:40 -0000	1.13
+++ xmloff/source/transform/Oasis2OOo.cxx	11 Feb 2005 16:26:07 -0000	1.13.20.1
@@ -463,7 +463,7 @@ static XMLTransformerActionInit aActionT
 				OASIS_TEXT_STYLE_REF_ACTIONS ), /* generated entry */
 	ENTRY1( TEXT, INDEX_ENTRY_LINK_END, XML_ETACTION_PROC_ATTRS,
 				OASIS_TEXT_STYLE_REF_ACTIONS ), /* generated entry */
-	ENTRY1( DRAW, MASTER_PAGE, XML_ETACTION_PROC_ATTRS,
+	ENTRY1( DRAW, PAGE, XML_ETACTION_PROC_ATTRS,
 				OASIS_MASTER_PAGE_REF_ACTIONS ), /* generated entry */
     // --> OD 2005-01-10 #i40011#, #i40015#
     // - conversion of attribute <table:style-name> for <table:table-row> and
Index: sd/inc/CustomAnimationEffect.hxx
===================================================================
RCS file: /cvs/graphics/sd/inc/CustomAnimationEffect.hxx,v
retrieving revision 1.4
retrieving revision 1.4.24.2
diff -u -p -u -p -r1.4 -r1.4.24.2
--- sd/inc/CustomAnimationEffect.hxx	25 Jan 2005 15:32:27 -0000	1.4
+++ sd/inc/CustomAnimationEffect.hxx	21 Feb 2005 15:44:55 -0000	1.4.24.2
@@ -74,6 +74,9 @@
 #ifndef _COM_SUN_STAR_DRAWING_XSHAPE_HPP_
 #include <com/sun/star/drawing/XShape.hpp>
 #endif
+#ifndef _COM_SUN_STAR_UTIL_XCHANGESLISTENER_HPP_
+#include <com/sun/star/util/XChangesListener.hpp>
+#endif
 
 #ifndef _STRING_HXX
 #include <tools/string.hxx>
@@ -87,6 +90,10 @@
 #include <comphelper/stl_types.hxx>
 #endif
 
+#ifndef _SV_TIMER_HXX
+#include <vcl/timer.hxx>
+#endif
+
 #include <list>
 #include <map>
 
@@ -321,7 +328,7 @@ public:
 	EffectSequenceHelper( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XTimeContainer >& xSequenceRoot );
 	virtual ~EffectSequenceHelper();
 
-	::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode > getRootNode() const;
+	virtual ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode > getRootNode();
 
 	CustomAnimationEffectPtr append( const CustomAnimationPresetPtr& pDescriptor, const ::com::sun::star::uno::Any& rTarget, double fDuration = -1.0 );
 	void append( const CustomAnimationEffectPtr& pEffect );
@@ -335,7 +342,7 @@ public:
 	void processAfterEffect( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode >& xNode );
 	void createEffects( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode >& xNode );
 
-	virtual void disposeShape( const com::sun::star::uno::Reference< com::sun::star::drawing::XShape >& xShape );
+	virtual bool disposeShape( const com::sun::star::uno::Reference< com::sun::star::drawing::XShape >& xShape );
 	virtual void insertTextRange( const com::sun::star::uno::Any& aTarget );
 	virtual void disposeTextRange( const com::sun::star::uno::Any& aTarget );
 	virtual bool hasEffect( const com::sun::star::uno::Reference< com::sun::star::drawing::XShape >& xShape );
@@ -398,6 +405,7 @@ friend class MainSequence;
 public:
 	InteractiveSequence( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XTimeContainer >& xSequenceRoot, MainSequence* pMainSequence );
 
+	/** this method rebuilds the animation nodes */
 	virtual void rebuild();
 
 	::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape > getTriggerShape() const { return mxEventSource; }
@@ -416,13 +424,21 @@ typedef std::list< InteractiveSequencePt
 class MainSequence : public EffectSequenceHelper, public ISequenceListener
 {
 	friend class UndoAnimation;
+	friend class MainSequenceRebuildGuard;
+
 public:
 	MainSequence();
 	MainSequence( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode >& xTimingRootNode );
+	~MainSequence();
+
+	virtual ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode > getRootNode();
 
+	void reset( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode >& xTimingRootNode );
+
+	/** this method rebuilds the animation nodes */
 	virtual void rebuild();
 
-	virtual void disposeShape( const com::sun::star::uno::Reference< com::sun::star::drawing::XShape >& xShape );
+	virtual bool disposeShape( const com::sun::star::uno::Reference< com::sun::star::drawing::XShape >& xShape );
 	virtual void insertTextRange( const com::sun::star::uno::Any& aTarget );
 	virtual void disposeTextRange( const com::sun::star::uno::Any& aTarget );
 	virtual bool hasEffect( const com::sun::star::uno::Reference< com::sun::star::drawing::XShape >& xShape );
@@ -434,19 +450,53 @@ public:
 
 	bool setTrigger( const CustomAnimationEffectPtr& pEffect, const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape >& xTriggerShape );
 
+	/** starts a timer that recreates the internal structure from the API core after 1 second */
+	void startRecreateTimer();
+
+	/** starts a timer that rebuilds the API core from the internal structure after 1 second */
+	void startRebuildTimer();
+
 protected:
+	/** permits rebuilds until unlockRebuilds() is called. All rebuild calls during a locked sequence are
+		process after unlockRebuilds() call. lockRebuilds() and unlockRebuilds() calls can be nested. */
+	void lockRebuilds();
+	void unlockRebuilds();
+
+	DECL_LINK( onTimerHdl, Timer * );
+
 	virtual void implRebuild();
 
-	void init( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode >& xTimingRootNode );
+	void init();
+
+	void create();
 	virtual void reset();
 
 	InteractiveSequencePtr createInteractiveSequence( const ::com::sun::star::uno::Reference< ::com::sun::star::drawing::XShape >& xShape );
 
 	InteractiveSequenceList maInteractiveSequenceList;
+
+	::com::sun::star::uno::Reference< ::com::sun::star::util::XChangesListener > mxChangesListener;
+	::com::sun::star::uno::Reference< ::com::sun::star::animations::XTimeContainer > mxTimingRootNode;
+	Timer maTimer;
+	bool mbTimerMode;
+	bool mbRebuilding;
+
+	long mnRebuildLockGuard;
+	bool mbPendingRebuildRequest;
 };
 
 typedef boost::shared_ptr< MainSequence > MainSequencePtr;
 
+class MainSequenceRebuildGuard
+{
+public:
+	MainSequenceRebuildGuard( const MainSequencePtr& pMainSequence );
+	~MainSequenceRebuildGuard();
+
+private:
+	MainSequencePtr mpMainSequence;
+};
+
 }
 
 #endif // _SD_CUSTOMANIMATIONEFFECT_HXX
Index: sd/source/core/CustomAnimationEffect.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/core/CustomAnimationEffect.cxx,v
retrieving revision 1.5
retrieving revision 1.5.14.3
diff -u -p -u -p -r1.5 -r1.5.14.3
--- sd/source/core/CustomAnimationEffect.cxx	28 Jan 2005 15:53:17 -0000	1.5
+++ sd/source/core/CustomAnimationEffect.cxx	21 Feb 2005 15:48:25 -0000	1.5.14.3
@@ -130,6 +130,9 @@
 #ifndef _COM_SUN_STAR_BEANS_XPROPERTYSET_HPP_
 #include <com/sun/star/beans/XPropertySet.hpp>
 #endif
+#ifndef _COM_SUN_STAR_UTIL_XCHANGESNOTIFIER_HPP_
+#include <com/sun/star/util/XChangesNotifier.hpp>
+#endif
 
 #ifndef _COMPHELPER_PROCESSFACTORY_HXX_
 #include <comphelper/processfactory.hxx>
@@ -156,6 +159,8 @@
 
 #include <algorithm>
 
+#include <cppuhelper/implbase1.hxx>
+
 #ifndef _SD_CUSTOMANIMATIONEFFECT_HXX
 #include "CustomAnimationEffect.hxx"
 #endif
@@ -180,6 +185,7 @@ using ::com::sun::star::uno::UNO_QUERY_T
 using ::com::sun::star::uno::Any;
 using ::com::sun::star::uno::makeAny;
 using ::com::sun::star::uno::Exception;
+using ::com::sun::star::uno::RuntimeException;
 using ::com::sun::star::container::XEnumerationAccess;
 using ::com::sun::star::container::XEnumeration;
 using ::com::sun::star::beans::NamedValue;
@@ -195,6 +201,8 @@ using ::com::sun::star::beans::XProperty
 using ::com::sun::star::lang::XMultiServiceFactory;
 using ::com::sun::star::util::XCloneable;
 using ::com::sun::star::lang::Locale;
+using ::com::sun::star::util::XChangesNotifier;
+using ::com::sun::star::util::XChangesListener;
 
 namespace sd
 {
@@ -358,7 +366,7 @@ sal_Int32 CustomAnimationEffect::getNumb
 			ParagraphTarget aParaTarget;
 			if( aTarget >>= aParaTarget )
 			{
-				xShape.query( aParaTarget.Shape );
+				xShape.set( aParaTarget.Shape, UNO_QUERY );
 				nOnlyPara = aParaTarget.Paragraph;
 			}
 		}
@@ -878,12 +886,14 @@ void CustomAnimationEffect::replaceNode(
 	Reference< XAudio > xAudio( mxAudio );
 	sal_Int16 nIterateType = mnIterateType;
 	double fIterateInterval = mfIterateInterval;
+	sal_Int16 nSubItem = mnTargetSubItem;
 
 	setNode( xNode );
 
 	mxAudio = xAudio;
 	setNodeType( nNodeType );
 	setTarget( aTarget );
+	setTargetSubItem( nSubItem );
 	setDuration( fDuration );
 	setBegin( fBegin );
 
@@ -1657,7 +1667,7 @@ void EffectSequenceHelper::reset()
 	maEffects.clear();
 }
 
-Reference< XAnimationNode > EffectSequenceHelper::getRootNode() const
+Reference< XAnimationNode > EffectSequenceHelper::getRootNode()
 {
 	Reference< XAnimationNode > xRoot( mxSequenceRoot, UNO_QUERY );
 	return xRoot;
@@ -2099,7 +2109,7 @@ EffectSequence::iterator EffectSequenceH
 
 // --------------------------------------------------------------------
 
-void EffectSequenceHelper::disposeShape( const Reference< XShape >& xShape )
+bool EffectSequenceHelper::disposeShape( const Reference< XShape >& xShape )
 {
 	bool bChanges = false;
 
@@ -2118,8 +2128,7 @@ void EffectSequenceHelper::disposeShape(
 		}
 	}
 
-	if( bChanges )
-		rebuild();
+	return bChanges;
 }
 
 // --------------------------------------------------------------------
@@ -2997,33 +3006,111 @@ double EffectSequenceHelper::calculateIt
 */
 // ====================================================================
 
+class AnimationChangeListener : public cppu::WeakImplHelper1< XChangesListener >
+{
+public:
+	AnimationChangeListener( MainSequence* pMainSequence ) : mpMainSequence( pMainSequence ) {}
+
+    virtual void SAL_CALL changesOccurred( const ::com::sun::star::util::ChangesEvent& Event ) throw (RuntimeException);
+    virtual void SAL_CALL disposing( const ::com::sun::star::lang::EventObject& Source ) throw (RuntimeException);
+private:
+	MainSequence* mpMainSequence;
+};
+
+void SAL_CALL AnimationChangeListener::changesOccurred( const ::com::sun::star::util::ChangesEvent& Event ) throw (RuntimeException)
+{
+	if( mpMainSequence )
+		mpMainSequence->startRecreateTimer();
+}
+
+void SAL_CALL AnimationChangeListener::disposing( const ::com::sun::star::lang::EventObject& Source ) throw (RuntimeException)
+{
+}
+
+// ====================================================================
+
 MainSequence::MainSequence()
+: mxTimingRootNode( ::comphelper::getProcessServiceFactory()->createInstance(OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.animations.SequenceTimeContainer"))), UNO_QUERY )
+, mbRebuilding( false )
+, mnRebuildLockGuard( 0 )
+, mbPendingRebuildRequest( false )
 {
-	Reference< XAnimationNode > xNode(::comphelper::getProcessServiceFactory()->createInstance(OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.animations.SequenceTimeContainer"))), UNO_QUERY);
-	if( xNode.is() )
+	if( mxTimingRootNode.is() )
 	{
 		Sequence< ::com::sun::star::beans::NamedValue > aUserData( 1 );
 		aUserData[0].Name = OUString( RTL_CONSTASCII_USTRINGPARAM( "node-type" ) );
 		aUserData[0].Value <<= ::com::sun::star::presentation::EffectNodeType::MAIN_SEQUENCE;
-		xNode->setUserData( aUserData );
+		mxTimingRootNode->setUserData( aUserData );
 	}
-	init( xNode );
+	init();
 }
 
+// --------------------------------------------------------------------
+
 MainSequence::MainSequence( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode >& xNode )
+: mxTimingRootNode( xNode, UNO_QUERY )
+, mbRebuilding( false )
+, mnRebuildLockGuard( 0 )
+, mbPendingRebuildRequest( false )
 {
-	init( xNode );
+	init();
 }
 
-void MainSequence::init( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode >& xNode )
+// --------------------------------------------------------------------
+
+MainSequence::~MainSequence()
+{
+	reset();
+}
+
+// --------------------------------------------------------------------
+
+void MainSequence::init()
 {
 	mnSequenceType = EffectNodeType::MAIN_SEQUENCE;
 
-	if( xNode.is() ) try
+	maTimer.SetTimeoutHdl( LINK(this, MainSequence, onTimerHdl) );
+	maTimer.SetTimeout(500);
+
+	mxChangesListener.set( new AnimationChangeListener( this ) );
+
+	create();
+}
+
+// --------------------------------------------------------------------
+
+void MainSequence::reset( const ::com::sun::star::uno::Reference< ::com::sun::star::animations::XAnimationNode >& xTimingRootNode )
+{
+	reset();
+
+	mxTimingRootNode.set( xTimingRootNode, UNO_QUERY );
+
+	create();
+}
+
+// --------------------------------------------------------------------
+
+Reference< ::com::sun::star::animations::XAnimationNode > MainSequence::getRootNode()
+{
+	DBG_ASSERT( mnRebuildLockGuard == 0, "MainSequence::getRootNode(), rebuild is locked, ist this really what you want?" );
+
+	if( maTimer.IsActive() && mbTimerMode )
 	{
-		reset();
+		// force a rebuild NOW if one is pending
+		maTimer.Stop();
+		implRebuild();
+	}
 
-		Reference< XEnumerationAccess > xEnumerationAccess( xNode, UNO_QUERY_THROW );
+	return EffectSequenceHelper::getRootNode();
+}
+
+// --------------------------------------------------------------------
+
+void MainSequence::create()
+{
+	if( mxTimingRootNode.is() ) try
+	{
+		Reference< XEnumerationAccess > xEnumerationAccess( mxTimingRootNode, UNO_QUERY_THROW );
 		Reference< XEnumeration > xEnumeration( xEnumerationAccess->createEnumeration(), UNO_QUERY_THROW );
 		while( xEnumeration->hasMoreElements() )
 		{
@@ -3032,7 +3119,7 @@ void MainSequence::init( const ::com::su
 			if( nNodeType == EffectNodeType::MAIN_SEQUENCE )
 			{
 				mxSequenceRoot.set( xChildNode, UNO_QUERY );
-				create( xChildNode );
+				EffectSequenceHelper::create( xChildNode );
 			}
 			else if( nNodeType == EffectNodeType::INTERACTIVE_SEQUENCE )
 			{
@@ -3060,23 +3147,26 @@ void MainSequence::init( const ::com::su
                 mxSequenceRoot->setDuration( makeAny((double)0.0) );
 
 				Reference< XAnimationNode > xMainSequenceNode( mxSequenceRoot, UNO_QUERY_THROW );
-				Reference< XTimeContainer > xParent( xNode, UNO_QUERY_THROW );
-				xParent->appendChild( xMainSequenceNode );
+				mxTimingRootNode->appendChild( xMainSequenceNode );
 			}
 		}
 
 		updateTextGroups();
 
 		notify_listeners();
+
+		Reference< XChangesNotifier > xNotifier( mxTimingRootNode, UNO_QUERY );
+		if( xNotifier.is() )
+			xNotifier->addChangesListener( mxChangesListener );
 	}
 	catch( Exception& e )
 	{
 		(void)e;
-		DBG_ERROR( "sd::MainSequence::MainSequence(), exception cought!" );
+		DBG_ERROR( "sd::MainSequence::create(), exception cought!" );
 		return;
 	}
 
-	DBG_ASSERT( mxSequenceRoot.is(), "sd::MainSequence::MainSequence(), found no main sequence!" );
+	DBG_ASSERT( mxSequenceRoot.is(), "sd::MainSequence::create(), found no main sequence!" );
 }
 
 // --------------------------------------------------------------------
@@ -3089,6 +3179,17 @@ void MainSequence::reset()
 	for( aIter = maInteractiveSequenceList.begin(); aIter != maInteractiveSequenceList.end(); aIter++ )
 		(*aIter)->reset();
 	maInteractiveSequenceList.clear();
+
+	try
+	{
+		Reference< XChangesNotifier > xNotifier( mxTimingRootNode, UNO_QUERY );
+		if( xNotifier.is() )
+			xNotifier->removeChangesListener( mxChangesListener );
+	}
+	catch( Exception& )
+	{
+		// ...
+	}
 }
 
 // --------------------------------------------------------------------
@@ -3121,9 +3222,9 @@ InteractiveSequencePtr MainSequence::cre
 
 // --------------------------------------------------------------------
 
-void MainSequence::disposeShape( const Reference< XShape >& xShape )
+bool MainSequence::disposeShape( const Reference< XShape >& xShape )
 {
-	EffectSequenceHelper::disposeShape( xShape );
+	bool bChanges = EffectSequenceHelper::disposeShape( xShape );
 
 	InteractiveSequenceList::iterator aIter;
 	for( aIter = maInteractiveSequenceList.begin(); aIter != maInteractiveSequenceList.end();  )
@@ -3131,12 +3232,18 @@ void MainSequence::disposeShape( const R
 		if( (*aIter)->getTriggerShape() == xShape )
 		{
 			aIter = maInteractiveSequenceList.erase( aIter );
+			bChanges = true;
 		}
 		else
 		{		
-			(*aIter++)->disposeShape( xShape );
+			bChanges |= (*aIter++)->disposeShape( xShape );
 		}
 	}
+
+	if( bChanges )
+		startRebuildTimer();
+
+	return bChanges;
 }
 
 // --------------------------------------------------------------------
@@ -3219,11 +3326,43 @@ void EffectSequenceHelper::onTextChanged
 
 void MainSequence::rebuild()
 {
-	implRebuild();
+	startRebuildTimer();
+}
+
+// --------------------------------------------------------------------
+
+void MainSequence::lockRebuilds()
+{
+	mnRebuildLockGuard++;
+}
+
+// --------------------------------------------------------------------
+
+void MainSequence::unlockRebuilds()
+{
+	DBG_ASSERT( mnRebuildLockGuard, "sd::MainSequence::unlockRebuilds(), no corresponding lockRebuilds() call!" );
+	if( mnRebuildLockGuard )
+		mnRebuildLockGuard--;
+
+	if( (mnRebuildLockGuard == 0) && mbPendingRebuildRequest )
+	{
+		mbPendingRebuildRequest = false;
+		startRebuildTimer();
+	}
 }
 
+// --------------------------------------------------------------------
+
 void MainSequence::implRebuild()
 {
+	if( mnRebuildLockGuard )
+	{
+		mbPendingRebuildRequest = true;
+		return;
+	}
+
+	mbRebuilding = true;
+
 	EffectSequenceHelper::implRebuild();
 
 	InteractiveSequenceList::iterator aIter( maInteractiveSequenceList.begin() );
@@ -3249,6 +3388,7 @@ void MainSequence::implRebuild()
 	}
 
 	notify_listeners();
+	mbRebuilding = false;
 }
 
 // --------------------------------------------------------------------
@@ -3301,6 +3441,44 @@ bool MainSequence::setTrigger( const Cus
 
 }
 
+// --------------------------------------------------------------------
+
+IMPL_LINK( MainSequence, onTimerHdl, Timer *, EMPTYARG )
+{
+	if( mbTimerMode )
+	{
+		implRebuild();
+	}
+	else
+	{
+		reset();
+		create();
+	}
+
+	return 0;
+}
+
+// --------------------------------------------------------------------
+
+/** starts a timer that recreates the internal structure from the API core after 1 second */
+void MainSequence::startRecreateTimer()
+{
+	if( !mbRebuilding )
+	{
+		mbTimerMode = false;
+		maTimer.Start();
+	}
+}
+
+// --------------------------------------------------------------------
+
+/** starts a timer that rebuilds the API core from the internal structure after 1 second */
+void MainSequence::startRebuildTimer()
+{
+	mbTimerMode = true;
+	maTimer.Start();
+}
+
 // ====================================================================
 
 InteractiveSequence::InteractiveSequence( const Reference< XTimeContainer >& xSequenceRoot, MainSequence* pMainSequence )
@@ -3344,4 +3522,20 @@ void InteractiveSequence::implRebuild()
 	EffectSequenceHelper::implRebuild();
 }
 
+// --------------------------------------------------------------------
+
+MainSequenceRebuildGuard::MainSequenceRebuildGuard( const MainSequencePtr& pMainSequence )
+: mpMainSequence( pMainSequence )
+{
+	if( mpMainSequence.get() )
+		mpMainSequence->lockRebuilds();
+}
+
+MainSequenceRebuildGuard::~MainSequenceRebuildGuard()
+{
+	if( mpMainSequence.get() )
+		mpMainSequence->unlockRebuilds();
+}
+
+
 };
Index: sd/source/core/undoanim.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/core/undoanim.cxx,v
retrieving revision 1.3
retrieving revision 1.3.30.1
diff -u -p -u -p -r1.3 -r1.3.30.1
--- sd/source/core/undoanim.cxx	21 Jan 2005 18:17:47 -0000	1.3
+++ sd/source/core/undoanim.cxx	17 Feb 2005 11:42:03 -0000	1.3.30.1
@@ -131,7 +131,7 @@ void UndoAnimation::Undo()
 
 		mpImpl->mpPage->mxAnimationNode = xClone;
 		if( mpImpl->mpPage->mpMainSequence.get() )
-			mpImpl->mpPage->mpMainSequence->init( xClone );
+			mpImpl->mpPage->mpMainSequence->reset( xClone );
 	}
 	catch( Exception& e )
 	{
@@ -147,7 +147,7 @@ void UndoAnimation::Redo()
 		Reference< XCloneable > xCloneAble( mpImpl->mxNewNode, UNO_QUERY_THROW );
 		mpImpl->mpPage->mxAnimationNode.set( xCloneAble->createClone(), UNO_QUERY_THROW );
 		if( mpImpl->mpPage->mpMainSequence.get() )
-			mpImpl->mpPage->mpMainSequence->init( mpImpl->mpPage->mxAnimationNode );
+			mpImpl->mpPage->mpMainSequence->reset( mpImpl->mpPage->mxAnimationNode );
 	}
 	catch( Exception& e )
 	{
Index: sd/source/filter/xml/sdxmlwrp.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/filter/xml/sdxmlwrp.cxx,v
retrieving revision 1.52
retrieving revision 1.52.50.1
diff -u -p -u -p -r1.52 -r1.52.50.1
--- sd/source/filter/xml/sdxmlwrp.cxx	11 Jan 2005 12:10:20 -0000	1.52
+++ sd/source/filter/xml/sdxmlwrp.cxx	17 Feb 2005 13:34:22 -0000	1.52.50.1
@@ -842,6 +842,12 @@ sal_Bool SdXMLFilter::Export()
 			{ MAP_LEN( "StreamName" ), 0,
 				  &::getCppuType( (OUString *)0 ),
 				  ::com::sun::star::beans::PropertyAttribute::MAYBEVOID, 0 },
+            { MAP_LEN( "StyleNames" ), 0,
+                  &::getCppuType( (Sequence<OUString>*)0 ),
+                  ::com::sun::star::beans::PropertyAttribute::MAYBEVOID, 0 },
+            { MAP_LEN( "StyleFamilies" ), 0,
+                  &::getCppuType( (Sequence<sal_Int32>*)0 ),
+                  ::com::sun::star::beans::PropertyAttribute::MAYBEVOID, 0 },
 			{ NULL, 0, 0, NULL, 0, 0 }
 		};
 
Index: sd/source/ui/animations/CustomAnimationDialog.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/animations/CustomAnimationDialog.cxx,v
retrieving revision 1.4
retrieving revision 1.4.14.1
diff -u -p -u -p -r1.4 -r1.4.14.1
--- sd/source/ui/animations/CustomAnimationDialog.cxx	28 Jan 2005 15:39:14 -0000	1.4
+++ sd/source/ui/animations/CustomAnimationDialog.cxx	15 Feb 2005 16:13:40 -0000	1.4.14.1
@@ -1497,7 +1497,12 @@ CustomAnimationEffectTabPage::CustomAnim
 				}
 
 				if( nPos == 0 )
-					nPos = LISTBOX_ENTRY_NOTFOUND;
+				{
+					nPos = (USHORT)maSoundList.Count()+2;
+					maSoundList.Insert( new String( aTmp ), LIST_APPEND );
+					INetURLObject aURL( aTmp );
+					nPos = mpLBSound->InsertEntry( aURL.GetBase() );
+				}
 			}
 		}
 
Index: sd/source/ui/animations/CustomAnimationList.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/animations/CustomAnimationList.cxx,v
retrieving revision 1.3
retrieving revision 1.3.30.2
diff -u -p -u -p -r1.3 -r1.3.30.2
--- sd/source/ui/animations/CustomAnimationList.cxx	21 Jan 2005 18:18:28 -0000	1.3
+++ sd/source/ui/animations/CustomAnimationList.cxx	24 Feb 2005 15:39:51 -0000	1.3.30.2
@@ -552,7 +552,8 @@ void CustomAnimationTriggerEntryItem::Cl
 
 CustomAnimationList::CustomAnimationList( ::Window* pParent, const ResId& rResId, ICustomAnimationListController* pController )
 : SvTreeListBox( pParent, rResId ), mpLastParentEntry(0),
-  mpController( pController )
+  mpController( pController ),
+  mbIgnorePaint( false )
 {
 	SetWindowBits( WinBits( WB_TABSTOP | WB_BORDER | WB_HASLINES | WB_HASBUTTONS | WB_HASBUTTONSATROOT ) );
 
@@ -628,6 +629,12 @@ void CustomAnimationList::select( Custom
 		}
 		pEntry = static_cast< CustomAnimationListEntry* >(Next( pEntry ));
 	}
+
+	if( !pEntry && bSelect )
+	{
+		append( pEffect );
+		select( pEffect );
+	}
 }
 
 // --------------------------------------------------------------------
@@ -671,6 +678,8 @@ void stl_append_effect_func::operator()(
 
 void CustomAnimationList::update()
 {
+	mbIgnorePaint = true;
+
 	CustomAnimationListEntry* pEntry = 0;
 
 	std::list< CustomAnimationEffectPtr > aExpanded;
@@ -759,6 +768,7 @@ void CustomAnimationList::update()
 		}
 	}
 
+	mbIgnorePaint = false;
 	Invalidate();
 }
 
@@ -1055,6 +1065,9 @@ void CustomAnimationList::notify_change(
 
 void CustomAnimationList::Paint( const Rectangle& rRect )
 {
+	if( mbIgnorePaint )
+		return;
+
 	SvTreeListBox::Paint( rRect );
 
 	// draw help text if list box is still empty
Index: sd/source/ui/animations/CustomAnimationList.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/animations/CustomAnimationList.hxx,v
retrieving revision 1.2
retrieving revision 1.2.96.1
diff -u -p -u -p -r1.2 -r1.2.96.1
--- sd/source/ui/animations/CustomAnimationList.hxx	26 Nov 2004 19:54:56 -0000	1.2
+++ sd/source/ui/animations/CustomAnimationList.hxx	17 Feb 2005 11:44:31 -0000	1.2.96.1
@@ -145,6 +145,8 @@ public:
 	bool isExpanded( const CustomAnimationEffectPtr& pEffect ) const;
 
 private:
+	bool	mbIgnorePaint;
+
 	/** appends the given effect to the list*/
 	void append( CustomAnimationEffectPtr pEffect );
 
Index: sd/source/ui/animations/CustomAnimationPane.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/animations/CustomAnimationPane.cxx,v
retrieving revision 1.7
retrieving revision 1.7.14.2
diff -u -p -u -p -r1.7 -r1.7.14.2
--- sd/source/ui/animations/CustomAnimationPane.cxx	28 Jan 2005 15:39:26 -0000	1.7
+++ sd/source/ui/animations/CustomAnimationPane.cxx	21 Feb 2005 15:50:28 -0000	1.7.14.2
@@ -352,7 +352,8 @@ CustomAnimationPane::CustomAnimationPane
 	// get current controller and initialize listeners
 	try
 	{
-		mxView = Reference< XDrawView >::query( mxModel->getCurrentController() );
+		mxView = Reference< XDrawView >::query( static_cast<drawing::XDrawView*>(mrBase.GetMainViewShell()->GetController()));
+/*		mxView = Reference< XDrawView >::query( mxModel->getCurrentController() );*/
 		addListener();
 	}
 	catch( Exception& e )
@@ -936,6 +937,8 @@ void CustomAnimationPane::updateControls
 		
 		if( bEnableUp || bEnableDown )
 		{
+			MainSequenceRebuildGuard aGuard( mpMainSequence );
+
 			EffectSequenceHelper* pSequence = 0;
 			EffectSequence::iterator aIter( maListSelection.begin() );
 			const EffectSequence::iterator aEnd( maListSelection.end() );
@@ -1222,9 +1225,9 @@ STLPropertySet* CustomAnimationPane::cre
 		addValue( pSet, nHandleIterateType, makeAny( pEffect->getIterateType() ) );
 
 		// convert absolute time to percentage value
-		float fIterateInterval = pEffect->getIterateInterval();
+		float fIterateInterval = (float)pEffect->getIterateInterval();
 		if( pEffect->getDuration() )
-			fIterateInterval = fIterateInterval / pEffect->getDuration();
+			fIterateInterval = (float)( fIterateInterval / pEffect->getDuration() );
 		fIterateInterval *= 100.0;
 		addValue( pSet, nHandleIterateInterval, makeAny( (double)fIterateInterval ) );
 
@@ -1313,6 +1316,8 @@ void CustomAnimationPane::changeSelectio
 	// change selected effect
 	bool bChanged = false;
 	
+	MainSequenceRebuildGuard aGuard( mpMainSequence );
+
 	EffectSequence::iterator aIter( maListSelection.begin() );
 	const EffectSequence::iterator aEnd( maListSelection.end() );
 	while( aIter != aEnd )
@@ -1832,6 +1837,8 @@ void CustomAnimationPane::onChange( bool
 			}
 			else
 			{
+				MainSequenceRebuildGuard aGuard( mpMainSequence );
+
 				// get selected effect
 				EffectSequence::iterator aIter( maListSelection.begin() );
 				const EffectSequence::iterator aEnd( maListSelection.end() );
@@ -1865,6 +1872,8 @@ void CustomAnimationPane::onRemove()
 	{
 		addUndo();
 
+		MainSequenceRebuildGuard aGuard( mpMainSequence );
+
 		EffectSequence aList( maListSelection );
 
 		EffectSequence::iterator aIter( aList.begin() );
@@ -1903,6 +1912,8 @@ void CustomAnimationPane::onChangeStart(
 {
 	addUndo();
 
+	MainSequenceRebuildGuard aGuard( mpMainSequence );
+
 	bool bNeedRebuild = false;
 
 	EffectSequence::iterator aIter( maListSelection.begin() );
@@ -1931,6 +1942,8 @@ void CustomAnimationPane::onChangeProper
 	{
 		addUndo();
 
+		MainSequenceRebuildGuard aGuard( mpMainSequence );
+
 		const Any aValue( mpLBProperty->getSubControl()->getValue() );
 
 		bool bNeedUpdate = false;
@@ -1963,6 +1976,8 @@ void CustomAnimationPane::onChangeSpeed(
 	{
 		addUndo();
 
+		MainSequenceRebuildGuard aGuard( mpMainSequence );
+
 		double fDuration;
 
 		USHORT nPos= mpCBSpeed->GetSelectEntryPos();
@@ -2051,6 +2066,7 @@ void CustomAnimationPane::moveSelection(
 
 	bool bChanged = false;
 
+	MainSequenceRebuildGuard aGuard( mpMainSequence );
 	EffectSequence& rEffectSequence = pSequence->getSequence();
 
 	if( bUp )
Index: sd/source/ui/func/futext.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/func/futext.cxx,v
retrieving revision 1.47
retrieving revision 1.47.178.1
diff -u -p -u -p -r1.47 -r1.47.178.1
--- sd/source/ui/func/futext.cxx	31 Aug 2004 13:49:12 -0000	1.47
+++ sd/source/ui/func/futext.cxx	18 Feb 2005 15:38:45 -0000	1.47.178.1
@@ -1417,8 +1417,6 @@ BOOL FuText::DeleteDefaultText()
 
 void FuText::ObjectChanged()
 {
-	if (pTextObj)
-		pTextObj->SetEmptyPresObj(FALSE);
 }
 
 /*************************************************************************
Index: sd/source/ui/slideshow/slideshowimpl.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/slideshow/slideshowimpl.cxx,v
retrieving revision 1.9
retrieving revision 1.9.14.5
diff -u -p -u -p -r1.9 -r1.9.14.5
--- sd/source/ui/slideshow/slideshowimpl.cxx	28 Jan 2005 15:53:08 -0000	1.9
+++ sd/source/ui/slideshow/slideshowimpl.cxx	24 Feb 2005 13:23:29 -0000	1.9.14.5
@@ -239,7 +239,7 @@ private:
 };
 
 AnimationPageList::AnimationPageList( SdDrawDocument* pDoc )
-: mpDoc( pDoc ), mnCurrentPageIndex(0), mnStartPageNumber(0)
+        : mnStartPageNumber(0), mpDoc( pDoc ), mnCurrentPageIndex(0)
 {
 	mnPageCount = mpDoc->GetSdPageCount( PK_STANDARD );
 }
@@ -342,11 +342,11 @@ SlideshowImpl::SlideshowImpl(
 	::sd::View* pView,
 	SdDrawDocument* pDoc )
 :	SlideshowImpl_base( m_aMutex ),
+	mxModel(pDoc->getUnoModel(),UNO_QUERY_THROW),
 	mpView(pView),
 	mpViewShell(pViewSh),
 	mpDocSh(pDoc->GetDocSh()),
 	mpDoc(pDoc),
-	mxModel(pDoc->getUnoModel(),UNO_QUERY_THROW),
 	mpShowWindow(0),
 	mpTimeButton(0),
 	mpSaveOptions( new SvtSaveOptions ),
@@ -465,7 +465,6 @@ bool SlideshowImpl::startPreview( 
 			nPropertyCount++;
 
 		Sequence< beans::PropertyValue > aProperties(nPropertyCount);
-		beans::PropertyValue* p = aProperties.getArray();
 		aProperties[0].Name = ::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM("AutomaticAdvancement") );
 		aProperties[0].Value = uno::makeAny( (double)1.0 ); // one second timeout
 
@@ -705,7 +704,6 @@ bool SlideshowImpl::startShow( Presentat
 		bRet = startShowImpl( aSlides, aRootNodes,
                               Sequence<beans::PropertyValue>(
                                   &aProperties[0], aProperties.size() ) ); 
-
 	}
 	catch( Exception& e )
 	{
@@ -1323,6 +1321,7 @@ void SAL_CALL SlideshowImpl::click( cons
 			DBG_ERROR("sd::SlideshowImpl::click(), exception caught!" );
 		}
 	}
+	break;
 
 	case ClickAction_DOCUMENT:
     {
@@ -1398,7 +1397,6 @@ sal_Int32 SlideshowImpl::getPageNumberFo
 {
 	BOOL bIsMasterPage;
 	USHORT nPgNum = mpDoc->GetPageByName( rStrBookmark, bIsMasterPage );
-	SdrObject* pObj = NULL;
 
 	if( nPgNum == SDRPAGE_NOTFOUND )
 	{
@@ -1742,7 +1740,7 @@ void SlideshowImpl::createPageList( bool
 		{
 			sal_Int32 nFirstPage = 0;
 
-			// normale Präsentation
+			// normale Praesentation
 			if( !bAll )
 			{
 				if( rPresPage.Len() )
@@ -1870,8 +1868,6 @@ void SlideshowImpl::resize( const Size& 
 
     if( mpShowWindow && (ANIMATIONMODE_VIEW != meAnimationMode) )
     {
-	    const Size aOldSize( mpShowWindow->GetSizePixel() );
-
 	    mpShowWindow->SetSizePixel( maPresSize );
 	    mpShowWindow->Show();
 
Index: sd/source/ui/toolpanel/controls/MasterPagesSelector.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/toolpanel/controls/MasterPagesSelector.cxx,v
retrieving revision 1.6
retrieving revision 1.6.14.1
diff -u -p -u -p -r1.6 -r1.6.14.1
--- sd/source/ui/toolpanel/controls/MasterPagesSelector.cxx	31 Jan 2005 14:54:49 -0000	1.6
+++ sd/source/ui/toolpanel/controls/MasterPagesSelector.cxx	17 Feb 2005 12:49:34 -0000	1.6.14.1
@@ -555,7 +555,7 @@ SdPage* MasterPagesSelector::AddMasterPa
 
         // Adapt the size of the new master page to that of the pages in the
         // document.
-        Size aNewSize (pTargetDocument->GetSdPage(0, PK_STANDARD)->GetSize());
+        Size aNewSize (pTargetDocument->GetSdPage(0, pMasterPage->GetPageKind())->GetSize());
 		Rectangle aBorders (
             pClonedMasterPage->GetLftBorder(),
             pClonedMasterPage->GetUppBorder(),
Index: sd/source/ui/unoidl/SdUnoDrawView.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/unoidl/SdUnoDrawView.cxx,v
retrieving revision 1.23
retrieving revision 1.23.24.1
diff -u -p -u -p -r1.23 -r1.23.24.1
--- sd/source/ui/unoidl/SdUnoDrawView.cxx	27 Jan 2005 14:18:28 -0000	1.23
+++ sd/source/ui/unoidl/SdUnoDrawView.cxx	17 Feb 2005 14:53:39 -0000	1.23.24.1
@@ -396,6 +396,7 @@ sal_Bool SAL_CALL SdUnoDrawView::support
             break;
 
         case ViewShell::ST_IMPRESS:
+		case ViewShell::ST_DRAW:
             bServiceIsSupported = ServiceName.equalsAscii(pImplSdUnoDrawViewService );
             break;
             
@@ -418,18 +419,17 @@ Sequence<OUString> SAL_CALL SdUnoDrawVie
         || (meViewShellType == ViewShell::ST_HANDOUT)
         || (meViewShellType == ViewShell::ST_PRESENTATION)
            ? 2 : 1);
-	OUString* pServices = aServices.getArray();
     
     int nIndex = 0;
 	switch (meViewShellType)
 	{
         case ViewShell::ST_NOTES:
-            pServices[nIndex++] = OUString(
+            aServices[nIndex++] = OUString(
                 RTL_CONSTASCII_USTRINGPARAM(pImplSdUnoNotesViewService));
             break;
 
         case ViewShell::ST_HANDOUT:
-            pServices[nIndex++] = OUString(
+            aServices[nIndex++] = OUString(
                 RTL_CONSTASCII_USTRINGPARAM(pImplSdUnoHandoutViewService));
 		break;
 	}
@@ -439,8 +439,10 @@ Sequence<OUString> SAL_CALL SdUnoDrawVie
         case ViewShell::ST_NOTES:
         case ViewShell::ST_HANDOUT:
         case ViewShell::ST_IMPRESS:
-            pServices[nIndex] = OUString(
-                RTL_CONSTASCII_USTRINGPARAM(pImplSdUnoDrawViewService));
+		case ViewShell::ST_DRAW:
+            aServices[nIndex] = OUString(
+				   RTL_CONSTASCII_USTRINGPARAM(pImplSdUnoDrawViewService));
+			break;
     }
 
 	return aServices;
Index: sd/source/ui/unoidl/unoobj.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/unoidl/unoobj.cxx,v
retrieving revision 1.44
retrieving revision 1.44.14.3
diff -u -p -u -p -r1.44 -r1.44.14.3
--- sd/source/ui/unoidl/unoobj.cxx	28 Jan 2005 15:42:39 -0000	1.44
+++ sd/source/ui/unoidl/unoobj.cxx	24 Feb 2005 15:09:55 -0000	1.44.14.3
@@ -562,17 +562,21 @@ void SAL_CALL SdXShape::setPropertyValue
 				case WID_PLAYFULL:
 					pInfo->bPlayFull = ::cppu::any2bool(aValue);
 					break;
+*/
 				case WID_SOUNDFILE:
 				{
 					OUString aString;
 					if(!(aValue >>= aString))
 						throw lang::IllegalArgumentException();
 					pInfo->aSoundFile = aString;
+					updateOldSoundEffect(pInfo);
 					break;
 				}
 				case WID_SOUNDON:
 					pInfo->bSoundOn = ::cppu::any2bool(aValue);
+					updateOldSoundEffect(pInfo);
 					break;
+/*
 				case WID_BLUESCREEN:
 				{
 					sal_Int32 nColor;
@@ -1859,9 +1863,9 @@ struct deprecated_AnimationEffect_conver
 deprecated_AnimationEffect_conversion_table[] =
 {
 	{ AnimationEffect_FADE_FROM_LEFT, "ooo-entrance-wipe","from-left" },
-	{ AnimationEffect_FADE_FROM_TOP, "ooo-entrance-wipe","from-top" },
+	{ AnimationEffect_FADE_FROM_TOP, "ooo-entrance-wipe","from-bottom" },
 	{ AnimationEffect_FADE_FROM_RIGHT, "ooo-entrance-wipe","from-right" },
-	{ AnimationEffect_FADE_FROM_BOTTOM, "ooo-entrance-wipe","from-bottom" },
+	{ AnimationEffect_FADE_FROM_BOTTOM, "ooo-entrance-wipe","from-top" },
 	{ AnimationEffect_FADE_TO_CENTER, "ooo-entrance-box","in" },
 	{ AnimationEffect_FADE_FROM_CENTER, "ooo-entrance-box","out" },
 	{ AnimationEffect_MOVE_FROM_LEFT, "ooo-entrance-fly-in","from-left" },
@@ -1870,8 +1874,8 @@ deprecated_AnimationEffect_conversion_ta
 	{ AnimationEffect_MOVE_FROM_BOTTOM, "ooo-entrance-fly-in","from-bottom" },
 	{ AnimationEffect_VERTICAL_STRIPES, "ooo-entrance-venetian-blinds","horizontal" },
 	{ AnimationEffect_HORIZONTAL_STRIPES, "ooo-entrance-venetian-blinds","vertical" },
-	{ AnimationEffect_CLOCKWISE, "ooo-entrance-checkerboard","downward" },
-	{ AnimationEffect_COUNTERCLOCKWISE, "ooo-entrance-checkerboard","across" },
+	{ AnimationEffect_CLOCKWISE, "ooo-entrance-clock-wipe","clockwise" },
+	{ AnimationEffect_COUNTERCLOCKWISE, "ooo-entrance-clock-wipe","counter-clockwise" },
 	{ AnimationEffect_FADE_FROM_UPPERLEFT, "ooo-entrance-diagonal-squares","right-to-bottom" },
 	{ AnimationEffect_FADE_FROM_UPPERRIGHT, "ooo-entrance-diagonal-squares","left-to-bottom" },
 	{ AnimationEffect_FADE_FROM_LOWERLEFT, "ooo-entrance-diagonal-squares","right-to-top" },
@@ -1885,15 +1889,15 @@ deprecated_AnimationEffect_conversion_ta
 	{ AnimationEffect_MOVE_TO_TOP, "ooo-entrance-random",0 },
 	{ AnimationEffect_MOVE_TO_RIGHT, "ooo-entrance-random",0 },
 	{ AnimationEffect_MOVE_TO_BOTTOM, "ooo-entrance-random",0 },
-	{ AnimationEffect_SPIRALIN_LEFT, "ooo-entrance-spiral-in",0 },
-	{ AnimationEffect_SPIRALIN_RIGHT, "ooo-entrance-spiral-in",0 },
-	{ AnimationEffect_SPIRALOUT_LEFT, "ooo-entrance-spiral-in",0 },
-	{ AnimationEffect_SPIRALOUT_RIGHT, "ooo-entrance-spiral-in",0 },
+	{ AnimationEffect_SPIRALIN_LEFT, "ooo-entrance-spiral-wipe", "from-top-left-clockwise" },
+	{ AnimationEffect_SPIRALIN_RIGHT, "ooo-entrance-spiral-wipe", "from-top-right-counter-clockwise" },
+	{ AnimationEffect_SPIRALOUT_LEFT, "ooo-entrance-spiral-wipe", "from-center-clockwise" },
+	{ AnimationEffect_SPIRALOUT_RIGHT, "ooo-entrance-spiral-wipe", "from-center-counter-clockwise" },
 	{ AnimationEffect_DISSOLVE, "ooo-entrance-dissolve-in",0 },
-	{ AnimationEffect_WAVYLINE_FROM_LEFT, "ooo-entrance-wipe","from-left" },
-	{ AnimationEffect_WAVYLINE_FROM_TOP, "ooo-entrance-wipe","from-top" },
-	{ AnimationEffect_WAVYLINE_FROM_RIGHT, "ooo-entrance-wipe","from-right" },
-	{ AnimationEffect_WAVYLINE_FROM_BOTTOM, "ooo-entrance-wipe","from-bottom" },
+	{ AnimationEffect_WAVYLINE_FROM_LEFT, "ooo-entrance-snake-wipe","from-top-left-vertical" },
+	{ AnimationEffect_WAVYLINE_FROM_TOP, "ooo-entrance-snake-wipe","from-top-left-horizontal" },
+	{ AnimationEffect_WAVYLINE_FROM_RIGHT, "ooo-entrance-snake-wipe","from-bottom-right-vertical" },
+	{ AnimationEffect_WAVYLINE_FROM_BOTTOM, "ooo-entrance-snake-wipe","from-bottom-right-horizontal" },
 	{ AnimationEffect_RANDOM, "ooo-entrance-random",0 },
 	{ AnimationEffect_VERTICAL_LINES, "ooo-entrance-random-bars","horizontal" },
 	{ AnimationEffect_HORIZONTAL_LINES, "ooo-entrance-random-bars","vertical" },
@@ -1906,7 +1910,7 @@ deprecated_AnimationEffect_conversion_ta
 	{ AnimationEffect_LASER_FROM_LOWERLEFT, "ooo-entrance-fly-in","from-bottom-left" },
 	{ AnimationEffect_LASER_FROM_LOWERRIGHT, "ooo-entrance-fly-in","from-bottom-right" },
 	{ AnimationEffect_APPEAR, "ooo-entrance-appear",0 },
-	{ AnimationEffect_HIDE, "ooo-entrance-random",0 },
+	{ AnimationEffect_HIDE, "ooo-exit-disappear",0 },
 	{ AnimationEffect_MOVE_FROM_UPPERLEFT, "ooo-entrance-fly-in","from-top-left" },
 	{ AnimationEffect_MOVE_FROM_UPPERRIGHT, "ooo-entrance-fly-in","from-top-right" },
 	{ AnimationEffect_MOVE_FROM_LOWERRIGHT, "ooo-entrance-fly-in","from-bottom-right" },
@@ -1934,17 +1938,17 @@ deprecated_AnimationEffect_conversion_ta
 	{ AnimationEffect_VERTICAL_CHECKERBOARD, "ooo-entrance-checkerboard","downward" },
 	{ AnimationEffect_HORIZONTAL_CHECKERBOARD, "ooo-entrance-checkerboard","across" },
 	{ AnimationEffect_HORIZONTAL_ROTATE, "ooo-entrance-swivel","vertical" },
-	{ AnimationEffect_VERTICAL_ROTATE, "ooo-entrance-swivel","vertical" },
+	{ AnimationEffect_VERTICAL_ROTATE, "ooo-entrance-swivel","horizontal" },
 	{ AnimationEffect_HORIZONTAL_STRETCH, "ooo-entrance-stretchy","across" },
-	{ AnimationEffect_VERTICAL_STRETCH, "ooo-entrance-stretchy","across" },
+	{ AnimationEffect_VERTICAL_STRETCH, "ooo-entrance-stretchy","downward" },
 	{ AnimationEffect_STRETCH_FROM_LEFT, "ooo-entrance-stretchy","from-left" },
-	{ AnimationEffect_STRETCH_FROM_UPPERLEFT, "ooo-entrance-stretchy","from-left" },
+	{ AnimationEffect_STRETCH_FROM_UPPERLEFT, "ooo-entrance-stretchy","from-top-left" },
 	{ AnimationEffect_STRETCH_FROM_TOP, "ooo-entrance-stretchy","from-top" },
-	{ AnimationEffect_STRETCH_FROM_UPPERRIGHT, "ooo-entrance-stretchy","from-top" },
+	{ AnimationEffect_STRETCH_FROM_UPPERRIGHT, "ooo-entrance-stretchy","from-top-right" },
 	{ AnimationEffect_STRETCH_FROM_RIGHT, "ooo-entrance-stretchy","from-right" },
-	{ AnimationEffect_STRETCH_FROM_LOWERRIGHT, "ooo-entrance-stretchy","from-right" },
+	{ AnimationEffect_STRETCH_FROM_LOWERRIGHT, "ooo-entrance-stretchy","from-bottom-right" },
 	{ AnimationEffect_STRETCH_FROM_BOTTOM, "ooo-entrance-stretchy","from-bottom" },
-	{ AnimationEffect_STRETCH_FROM_LOWERLEFT, "ooo-entrance-stretchy","from-bottom" },
+	{ AnimationEffect_STRETCH_FROM_LOWERLEFT, "ooo-entrance-stretchy","from-bottom-left" },
 	{ AnimationEffect_ZOOM_IN, "ooo-entrance-zoom","in" },
 	{ AnimationEffect_ZOOM_IN_SMALL, "ooo-entrance-zoom","in-slightly" },
 	{ AnimationEffect_ZOOM_IN_SPIRAL, "ooo-entrance-zoom","in-slightly" },
@@ -2112,6 +2116,13 @@ void SdXShape::setOldTextEffect( const c
 	if( !p->mpPresetId )
 		throw lang::IllegalArgumentException();
 
+	SdrObject* pObj = mpShape->GetSdrObject();
+	SdrTextObj* pTextObj = dynamic_cast< SdrTextObj* >( pObj );
+
+	// ignore old text effects on shape without text
+	if( (pTextObj == 0) || (!pTextObj->HasText()) )
+		return;
+
 	const CustomAnimationPresets& rPresets = CustomAnimationPresets::getCustomAnimationPresets();
 
 	// create an effect from this preset
@@ -2119,7 +2130,6 @@ void SdXShape::setOldTextEffect( const c
 	const OUString aPresetSubType( OUString::createFromAscii( p->mpPresetSubType ) );
 	CustomAnimationPresetPtr pPreset( rPresets.getEffectDescriptor( aPresetId ) );
 
-	SdrObject* pObj = mpShape->GetSdrObject();
 	sd::MainSequencePtr pMainSequence = static_cast<SdPage*>(pObj->GetPage())->getMainSequence();
 
 	if( pPreset.get() && pMainSequence.get() )
@@ -2139,11 +2149,11 @@ void SdXShape::setOldTextEffect( const c
 				pGroup = pMainSequence->findGroup( nGroupId );
 		}
 
+		CustomAnimationEffectPtr pShapeEffect;
+
 		// if there is not yet a group, create it
 		if( pGroup.get() == 0 )
 		{
-			CustomAnimationEffectPtr pShapeEffect;
-
 			EffectSequence::iterator aIterOnlyBackground( ImplFindEffect( pMainSequence, xShape, ShapeAnimationSubType::ONLY_BACKGROUND ) );
 			if( aIterOnlyBackground != aEnd )
 			{
@@ -2201,7 +2211,7 @@ void SdXShape::setOldTextEffect( const c
 					if( bLaserEffect )
                     {
 						(*aIter)->setIterateType( TextAnimationType::BY_LETTER );
-						(*aIter)->setIterateInterval( 20.0 );// TODO:
+						(*aIter)->setIterateInterval( 0.5 );// TODO:
                                                              // Determine
                                                              // interval
                                                              // according
@@ -2213,6 +2223,10 @@ void SdXShape::setOldTextEffect( const c
 				}
 			}
 		}
+
+		if( pShapeEffect.get() )
+			pShapeEffect->setDuration( 0.1 );
+
 		pMainSequence->rebuild();
 	}
 }
@@ -2246,7 +2260,8 @@ void SdXShape::setOldSpeed( const com::s
 		CustomAnimationEffectPtr pEffect( (*aIter) );
 		if( pEffect->getTargetShape() == xShape )
 		{
-			pEffect->setDuration( fDuration );
+			if( pEffect->getDuration() != 0.1 )
+				pEffect->setDuration( fDuration );
 			bNeedRebuild = true;
 		}
 	}
@@ -2438,3 +2453,41 @@ void SdXShape::setOldPresOrder( const co
 		}
 	}
 }
+
+void SdXShape::updateOldSoundEffect( SdAnimationInfo* pInfo )
+{
+	if( pInfo )
+	{
+		SdrObject* pObj = mpShape->GetSdrObject();
+		sd::MainSequencePtr pMainSequence = static_cast<SdPage*>(pObj->GetPage())->getMainSequence();
+
+		const Reference< XShape > xShape( mpShape );
+
+		EffectSequence::iterator aIter;
+		bool bNeedRebuild = false;
+		
+		OUString aSoundFile;
+		if( pInfo->bSoundOn )
+			aSoundFile = pInfo->aSoundFile;
+
+		for( aIter = pMainSequence->getBegin(); aIter != pMainSequence->getEnd(); aIter++ )
+		{
+			CustomAnimationEffectPtr pEffect( (*aIter) );
+			if( pEffect->getTargetShape() == xShape )
+			{
+				if( aSoundFile.getLength() )
+				{
+					pEffect->createAudio( makeAny( aSoundFile ) );
+				}
+				else
+				{
+					pEffect->removeAudio();
+				}
+				bNeedRebuild = true;
+			}
+		}
+
+		if( bNeedRebuild )
+			pMainSequence->rebuild();
+	}
+}
Index: sd/source/ui/unoidl/unoobj.hxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/unoidl/unoobj.hxx,v
retrieving revision 1.8
retrieving revision 1.8.96.1
diff -u -p -u -p -r1.8 -r1.8.96.1
--- sd/source/ui/unoidl/unoobj.hxx	26 Nov 2004 20:28:52 -0000	1.8
+++ sd/source/ui/unoidl/unoobj.hxx	15 Feb 2005 16:19:13 -0000	1.8.96.1
@@ -171,6 +171,7 @@ private:
 	void setOldDimHide( const com::sun::star::uno::Any& aValue );
 	void setOldDimPrevious( const com::sun::star::uno::Any& aValue );
 	void setOldPresOrder( const com::sun::star::uno::Any& aValue );
+	void updateOldSoundEffect( SdAnimationInfo* pInfo );
 
 
 };
Index: sd/source/ui/view/sdview.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/view/sdview.cxx,v
retrieving revision 1.37
retrieving revision 1.37.14.1
diff -u -p -u -p -r1.37 -r1.37.14.1
--- sd/source/ui/view/sdview.cxx	31 Jan 2005 09:05:05 -0000	1.37
+++ sd/source/ui/view/sdview.cxx	18 Feb 2005 15:42:31 -0000	1.37.14.1
@@ -773,11 +773,20 @@ SdrEndTextEditKind View::EndTextEdit(BOO
 		BOOL bDefaultTextRestored = ( (FuText*) pFunc)->RestoreDefaultText();
 		eKind = FmFormView::EndTextEdit(bDontDeleteReally);
 
-		if( bDefaultTextRestored )
-			pTextObj->SetEmptyPresObj( TRUE );
-
 		pTextObj = ( (FuText*) pFunc)->GetTextObj();
 
+		if( pTextObj )
+		{
+			if( bDefaultTextRestored )
+			{
+				pTextObj->SetEmptyPresObj( TRUE );
+			}
+			else if( pTextObj->IsEmptyPresObj() && (pTextObj->GetEditOutlinerParaObject() == 0) )
+			{
+				pTextObj->SetEmptyPresObj( FALSE );
+			}
+		}
+
 		if (eKind == SDRENDTEXTEDIT_CHANGED && !bDefaultTextRestored)
 			( (FuText*) pFunc)->ObjectChanged();
 
Index: sd/xml/effects.xml
===================================================================
RCS file: /cvs/graphics/sd/xml/effects.xml,v
retrieving revision 1.3
retrieving revision 1.3.24.1
diff -u -p -u -p -r1.3 -r1.3.24.1
--- sd/xml/effects.xml	25 Jan 2005 15:20:31 -0000	1.3
+++ sd/xml/effects.xml	15 Feb 2005 16:10:52 -0000	1.3.24.1
@@ -354,6 +354,22 @@
     </anim:par>
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-clock-wipe" pres:preset-sub-type="clockwise">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="2" smil:type="clockWipe" smil:subtype="clockwiseTwelve"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-clock-wipe" pres:preset-sub-type="counter-clockwise">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="2" smil:type="clockWipe" smil:subtype="clockwiseTwelve" smil:direction="reverse"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
     <anim:par pres:preset-property="Spokes" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-wheel" pres:preset-sub-type="1">
         <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
         <anim:transitionFilter smil:dur="2" smil:type="pinWheelWipe" smil:subtype="oneBlade"/>
@@ -392,6 +408,76 @@
     </anim:par>
     </anim:par>
     </anim:par>
+
+<!-- ooo-entrance-snake-wipe -->
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-snake-wipe" pres:preset-sub-type="from-top-left-horizontal">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="0.5" smil:type="snakeWipe" smil:subtype="topLeftHorizontal"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-snake-wipe" pres:preset-sub-type="from-top-left-vertical">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="0.5" smil:type="snakeWipe" smil:subtype="topLeftVertical"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-snake-wipe" pres:preset-sub-type="from-bottom-right-vertical">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+		<anim:transitionFilter smil:dur="0.5" smil:type="snakeWipe" smil:subtype="topLeftVertical" smil:direction="reverse"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-snake-wipe" pres:preset-sub-type="from-bottom-right-horizontal">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="0.5" smil:type="snakeWipe" smil:subtype="topLeftHorizontal" smil:direction="reverse"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+
+<!-- ooo-entrance-spiral-wipe -->
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-spiral-wipe" pres:preset-sub-type="from-top-left-clockwise">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="0.5" smil:type="spiralWipe" smil:subtype="topLeftClockwise"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-spiral-wipe" pres:preset-sub-type="from-top-right-counter-clockwise">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="0.5" smil:type="spiralWipe" smil:subtype="topRightCounterClockwise"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-spiral-wipe" pres:preset-sub-type="from-center-clockwise">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="0.5" smil:type="spiralWipe" smil:subtype="topLeftClockwise" smil:direction="reverse"/>/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-spiral-wipe" pres:preset-sub-type="from-center-counter-clockwise">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:transitionFilter smil:dur="0.5" smil:type="spiralWipe" smil:subtype="topRightCounterClockwise" smil:direction="reverse"/>/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+
+<!-- ooo-entrance-wipe -->
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
     <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-wipe" pres:preset-sub-type="from-bottom">
@@ -568,6 +654,15 @@
     </anim:par>
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-stretchy" pres:preset-sub-type="downward">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="width" smil:values="width;width" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="height" smil:values="0;height" smil:keyTimes="0;1" pres:additive="base"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>    
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
     <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-stretchy" pres:preset-sub-type="from-bottom">
         <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
         <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="x" smil:values="x;x" smil:keyTimes="0;1" pres:additive="base"/>
@@ -612,6 +707,50 @@
     </anim:par>
     <anim:par smil:begin="indefinite" smil:fill="hold">
     <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-stretchy" pres:preset-sub-type="from-top-right">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="x" smil:values="x+width/2;x" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="y" smil:values="y-height/2;y" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="width" smil:values="0;width" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="height" smil:values="0;height" smil:keyTimes="0;1" pres:additive="base"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-stretchy" pres:preset-sub-type="from-bottom-right">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="x" smil:values="x+width/2;x" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="y" smil:values="y+height/2;y" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="width" smil:values="0;width" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="height" smil:values="0;height" smil:keyTimes="0;1" pres:additive="base"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-stretchy" pres:preset-sub-type="from-top-left">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="x" smil:values="x-width/2;x" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="y" smil:values="y-height/2;y" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="width" smil:values="0;width" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="height" smil:values="0;height" smil:keyTimes="0;1" pres:additive="base"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
+    <anim:par pres:preset-property="Direction" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-stretchy" pres:preset-sub-type="from-bottom-left">
+        <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="x" smil:values="x-width/2;x" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="y" smil:values="y+height/2;y" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="width" smil:values="0;width" smil:keyTimes="0;1" pres:additive="base"/>
+        <anim:animate smil:dur="0.5" smil:fill="hold" smil:attributeName="height" smil:values="0;height" smil:keyTimes="0;1" pres:additive="base"/>
+    </anim:par>
+    </anim:par>
+    </anim:par>   
+    <anim:par smil:begin="indefinite" smil:fill="hold">
+    <anim:par smil:begin="0" smil:fill="hold">
     <anim:iterate pres:text-only="true" smil:begin="0" smil:fill="hold" pres:node-type="on-click" pres:preset-class="entrance" pres:preset-id="ooo-entrance-unfold" anim:iterate-type="by-letter" anim:iterate-interval="0.1s">
         <anim:set smil:begin="0" smil:dur="0.001" smil:fill="hold" smil:attributeName="visibility" smil:to="visible"/>
         <anim:transitionFilter smil:dur="1" smil:type="fade" smil:subtype="crossfade"/>
Index: animations/source/animcore/animcore.cxx
===================================================================
RCS file: /cvs/graphics/animations/source/animcore/animcore.cxx,v
retrieving revision 1.2
retrieving revision 1.2.2.1
diff -u -p -u -p -r1.2 -r1.2.2.1
--- animations/source/animcore/animcore.cxx	29 Nov 2004 10:36:49 -0000	1.2
+++ animations/source/animcore/animcore.cxx	17 Feb 2005 11:35:10 -0000	1.2.2.1
@@ -134,6 +134,15 @@
 #ifndef _COM_SUN_STAR_BEANS_NAMEDVALUE_HPP_
 #include <com/sun/star/beans/NamedValue.hpp>
 #endif
+#ifndef _COM_SUN_STAR_UTIL_XCHANGESNOTIFIER_HPP_
+#include <com/sun/star/util/XChangesNotifier.hpp>
+#endif
+#ifndef _COM_SUN_STAR_LANG_XUNOTUNNEL_HPP_
+#include <com/sun/star/lang/XUnoTunnel.hpp>
+#endif
+#ifndef _CPPUHELPER_INTERFACECONTAINER_HXX_
+#include <cppuhelper/interfacecontainer.hxx>
+#endif
 
 #include <cppuhelper/implbase1.hxx>
 
@@ -148,6 +157,8 @@
 using ::osl::Mutex;
 using ::osl::Guard;
 using ::rtl::OUString;
+using ::cppu::OInterfaceContainerHelper;
+using ::cppu::OInterfaceIteratorHelper;
 using ::com::sun::star::uno::Any;
 using ::com::sun::star::uno::UNO_QUERY;
 using ::com::sun::star::uno::XInterface;
@@ -171,6 +182,11 @@ using ::com::sun::star::container::XEnum
 using ::com::sun::star::container::XEnumerationAccess;
 using ::com::sun::star::beans::NamedValue;
 using ::com::sun::star::util::XCloneable;
+using ::com::sun::star::lang::XUnoTunnel;
+using ::com::sun::star::util::XChangesNotifier;
+using ::com::sun::star::util::XChangesListener;
+using ::com::sun::star::util::ElementChange;
+using ::com::sun::star::util::ChangesEvent;
 
 using ::cppu::OWeakObject;
 
@@ -186,19 +202,28 @@ typedef ::std::list< Reference< XAnimati
 
 // ====================================================================
 
-class AnimationNode :	public XAnimateMotion,
-						public XAnimateColor,
-						public XTransitionFilter,
-						public XAnimateSet,
-						public XAnimateTransform,
-						public XIterateContainer,
-						public XEnumerationAccess,
-						public XServiceInfo,
-						public XTypeProvider,
-						public XAudio,
-						public XCommand,
-						public XCloneable,
-						public OWeakObject
+class AnimationNodeBase :	public XAnimateMotion,
+							public XAnimateColor,
+							public XTransitionFilter,
+							public XAnimateSet,
+							public XAnimateTransform,
+							public XIterateContainer,
+							public XEnumerationAccess,
+							public XServiceInfo,
+							public XTypeProvider,
+							public XAudio,
+							public XCommand,
+							public XCloneable,
+							public XChangesNotifier,
+							public XUnoTunnel,
+							public OWeakObject
+{
+public:
+	// our first, last and only protection from mutli-threads!
+	Mutex maMutex;
+};
+
+class AnimationNode : public AnimationNodeBase
 {
 public:
 	AnimationNode( sal_Int16 nNodeType );
@@ -350,7 +375,19 @@ public:
     virtual double SAL_CALL getIterateInterval() throw (RuntimeException);
     virtual void SAL_CALL setIterateInterval( double _iterateinterval ) throw (RuntimeException);
 
+	// XChangesNotifier
+    virtual void SAL_CALL addChangesListener( const Reference< XChangesListener >& aListener ) throw (RuntimeException);
+    virtual void SAL_CALL removeChangesListener( const Reference< XChangesListener >& aListener ) throw (RuntimeException);
+
+    // XUnoTunnel
+    virtual ::sal_Int64 SAL_CALL getSomething( const Sequence< ::sal_Int8 >& aIdentifier ) throw (RuntimeException);
+
+	static const Sequence< sal_Int8 > & getUnoTunnelId();
+	void fireChangeListener();
+
 private:
+	OInterfaceContainerHelper	maChangeListener;
+
 	static void initTypeProvider( sal_Int16 nNodeType ) throw();
 
 	const sal_Int16 mnNodeType;
@@ -359,9 +396,6 @@ private:
 	static Sequence< Type >* mpTypes[10];
 	static Sequence< sal_Int8 >* mpId[10];
 
-	// our first, last and only protection from mutli-threads!
-	Mutex maMutex;
-
 	// attributes for the XAnimationNode interface implementation
 	Any maBegin, maDuration, maEnd, maEndSync, maRepeatCount, maRepeatDuration;
 	sal_Int16 mnFill, mnFillDefault, mnRestart, mnRestartDefault;
@@ -371,6 +405,7 @@ private:
 
 	// parent interface for XChild interface implementation
 	Reference<XInterface>	mxParent;
+	AnimationNode*			mpParent;
 
 	// attributes for XAnimate
 	Any	maTarget;
@@ -495,7 +530,9 @@ AnimationNode::AnimationNode( sal_Int16 
 	mfVolume(1.0),
     mnCommand(0),
     mnIterateType( ::com::sun::star::presentation::ShapeAnimationSubType::AS_WHOLE ),
-    mfIterateInterval(0.0)
+    mfIterateInterval(0.0),
+	maChangeListener(maMutex),
+	mpParent(0)
 {
 }
 
@@ -560,7 +597,9 @@ AnimationNode::AnimationNode( const Anim
 
 	// XIterateContainer
 	mnIterateType( rNode.mnIterateType ),
-	mfIterateInterval( rNode.mfIterateInterval )
+	mfIterateInterval( rNode.mfIterateInterval ),
+	maChangeListener(maMutex),
+	mpParent(0)
 {
 }
 
@@ -611,7 +650,9 @@ Any SAL_CALL AnimationNode::queryInterfa
 		static_cast< XCloneable* >( this ),
 		static_cast< XAnimationNode* >( static_cast< XTimeContainer * >(this) ),
 		static_cast< XInterface* >(static_cast< OWeakObject * >(this)),
-		static_cast< XWeak* >(static_cast< OWeakObject * >(this)) ) );
+		static_cast< XWeak* >(static_cast< OWeakObject * >(this)),
+		static_cast< XChangesNotifier* >( this ),
+		static_cast< XUnoTunnel* >( this ) ) );
 
 	if(!aRet.hasValue())
 	{
@@ -698,18 +739,18 @@ void AnimationNode::initTypeProvider( sa
 
 		static sal_Int32 type_numbers[] = 
 		{
-			5, // CUSTOM
-			7, // PAR
-			7, // SEQ
-			7, // ITERATE
-			6, // ANIMATE
-			6, // SET
-			6, // ANIMATEMOTION
-			6, // ANIMATECOLOR
-			6, // ANIMATETRANSFORM
-			6, // TRANSITIONFILTER
-			6, // AUDIO
-			6, // COMMAND
+			7, // CUSTOM
+			9, // PAR
+			9, // SEQ
+			9, // ITERATE
+			8, // ANIMATE
+			8, // SET
+			8, // ANIMATEMOTION
+			8, // ANIMATECOLOR
+			8, // ANIMATETRANSFORM
+			8, // TRANSITIONFILTER
+			8, // AUDIO
+			8, // COMMAND
 		};
 
 		// collect types
@@ -722,6 +763,8 @@ void AnimationNode::initTypeProvider( sa
 		pTypeAr[nPos++] = ::getCppuType( (const Reference< XCloneable > *)0 );
 		pTypeAr[nPos++] = ::getCppuType( (const Reference< XTypeProvider > *)0 );
 		pTypeAr[nPos++] = ::getCppuType( (const Reference< XServiceInfo > *)0 );
+		pTypeAr[nPos++] = ::getCppuType( (const Reference< XUnoTunnel > *)0 );
+		pTypeAr[nPos++] = ::getCppuType( (const Reference< XChangesNotifier> *)0 );
 
 		switch( nNodeType )
 		{
@@ -899,7 +942,11 @@ Any SAL_CALL AnimationNode::getBegin() t
 void SAL_CALL AnimationNode::setBegin( const Any& _begin ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maBegin = _begin;
+	if( _begin != maBegin )
+	{
+		maBegin = _begin;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -917,7 +964,11 @@ Any SAL_CALL AnimationNode::getDuration(
 void SAL_CALL AnimationNode::setDuration( const Any& _duration ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maDuration = _duration;
+	if( _duration != maDuration )
+	{
+		maDuration = _duration;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -935,7 +986,11 @@ Any SAL_CALL AnimationNode::getEnd() thr
 void SAL_CALL AnimationNode::setEnd( const Any& _end ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maEnd = _end;
+	if( _end != maEnd )
+	{
+		maEnd = _end;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -953,7 +1008,11 @@ Any SAL_CALL AnimationNode::getEndSync()
 void SAL_CALL AnimationNode::setEndSync( const Any& _endsync ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maEndSync = _endsync;
+	if( _endsync != maEndSync )
+	{
+		maEndSync = _endsync;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -971,7 +1030,11 @@ Any SAL_CALL AnimationNode::getRepeatCou
 void SAL_CALL AnimationNode::setRepeatCount( const Any& _repeatcount ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maRepeatCount = _repeatcount;
+	if( _repeatcount != maRepeatCount )
+	{
+		maRepeatCount = _repeatcount;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -989,7 +1052,11 @@ Any SAL_CALL AnimationNode::getRepeatDur
 void SAL_CALL AnimationNode::setRepeatDuration( const Any& _repeatduration ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maRepeatDuration = _repeatduration;
+	if( _repeatduration != maRepeatDuration )
+	{
+		maRepeatDuration = _repeatduration;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1007,7 +1074,11 @@ sal_Int16 SAL_CALL AnimationNode::getFil
 void SAL_CALL AnimationNode::setFill( sal_Int16 _fill ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnFill = _fill;
+	if( _fill != mnFill )
+	{
+		mnFill = _fill;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1025,7 +1096,11 @@ sal_Int16 SAL_CALL AnimationNode::getFil
 void SAL_CALL AnimationNode::setFillDefault( sal_Int16 _filldefault ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnFillDefault = _filldefault;
+	if( _filldefault != mnFillDefault )
+	{
+		mnFillDefault = _filldefault;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1043,7 +1118,11 @@ sal_Int16 SAL_CALL AnimationNode::getRes
 void SAL_CALL AnimationNode::setRestart( sal_Int16 _restart ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnRestart = _restart;
+	if( _restart != mnRestart )
+	{
+		mnRestart = _restart;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1061,7 +1140,11 @@ sal_Int16 SAL_CALL AnimationNode::getRes
 void SAL_CALL AnimationNode::setRestartDefault( sal_Int16 _restartdefault ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnRestartDefault = _restartdefault;
+	if( _restartdefault != mnRestartDefault )
+	{
+		mnRestartDefault = _restartdefault;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1079,7 +1162,11 @@ double SAL_CALL AnimationNode::getAccele
 void SAL_CALL AnimationNode::setAcceleration( double _acceleration ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mfAcceleration = _acceleration;
+	if( _acceleration != mfAcceleration )
+	{
+		mfAcceleration = _acceleration;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1097,7 +1184,11 @@ double SAL_CALL AnimationNode::getDecele
 void SAL_CALL AnimationNode::setDecelerate( double _decelerate ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mfDecelerate = _decelerate;
+	if( _decelerate != mfDecelerate )
+	{
+		mfDecelerate = _decelerate;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1115,7 +1206,11 @@ sal_Bool SAL_CALL AnimationNode::getAuto
 void SAL_CALL AnimationNode::setAutoReverse( sal_Bool _autoreverse ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mbAutoReverse = _autoreverse;
+	if( _autoreverse != mbAutoReverse )
+	{
+		mbAutoReverse = _autoreverse;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1132,6 +1227,7 @@ void SAL_CALL AnimationNode::setUserData
 {
 	Guard< Mutex > aGuard( maMutex );
 	maUserData = _userdata;
+	fireChangeListener();
 }
 
 // --------------------------------------------------------------------
@@ -1149,7 +1245,17 @@ Reference< XInterface > SAL_CALL Animati
 void SAL_CALL AnimationNode::setParent( const Reference< XInterface >& Parent ) throw (NoSupportException, RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mxParent = Parent;
+	if( Parent != mxParent )
+	{
+		mxParent = Parent;
+
+		mpParent = 0;
+		Reference< XUnoTunnel > xTunnel( mxParent, UNO_QUERY );
+		if( xTunnel.is() )
+			mpParent = ( AnimationNode* )xTunnel->getSomething( getUnoTunnelId() );
+
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1209,7 +1315,11 @@ void SAL_CALL AnimationNode::setTarget( 
 	throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maTarget= _target;
+	if( _target != maTarget )
+	{
+		maTarget= _target;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1228,7 +1338,11 @@ void SAL_CALL AnimationNode::setAttribut
 	throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maAttributeName = _attribute;
+	if( _attribute != maAttributeName )
+	{
+		maAttributeName = _attribute;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1249,6 +1363,7 @@ void SAL_CALL AnimationNode::setValues( 
 {
 	Guard< Mutex > aGuard( maMutex );
 	maValues = _values;
+	fireChangeListener();
 }
 
 // --------------------------------------------------------------------
@@ -1266,7 +1381,11 @@ sal_Int16 SAL_CALL AnimationNode::getSub
 void SAL_CALL AnimationNode::setSubItem( sal_Int16 _subitem ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnSubItem = _subitem;
+	if( _subitem != mnSubItem )
+	{
+		mnSubItem = _subitem;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1285,6 +1404,7 @@ void SAL_CALL AnimationNode::setKeyTimes
 {
 	Guard< Mutex > aGuard( maMutex );
 	maKeyTimes = _keytimes;
+	fireChangeListener();
 }
 
 // --------------------------------------------------------------------
@@ -1301,7 +1421,11 @@ sal_Int16 SAL_CALL AnimationNode::getVal
 void SAL_CALL AnimationNode::setValueType( sal_Int16 _valuetype ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnValueType = _valuetype;
+	if( _valuetype != mnValueType )
+	{
+		mnValueType = _valuetype;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1321,7 +1445,11 @@ void SAL_CALL AnimationNode::setCalcMode
 	throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnCalcMode = _calcmode;
+	if( _calcmode != mnCalcMode )
+	{
+		mnCalcMode = _calcmode;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1341,7 +1469,11 @@ void SAL_CALL AnimationNode::setAccumula
 	throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mbAccumulate = _accumulate;
+	if( _accumulate != mbAccumulate )
+	{
+		mbAccumulate = _accumulate;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1361,7 +1493,11 @@ void SAL_CALL AnimationNode::setAdditive
 	throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnAdditive = _additive;
+	if( _additive != mnAdditive )
+	{
+		mnAdditive = _additive;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1381,7 +1517,11 @@ void SAL_CALL AnimationNode::setFrom( co
 	throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maFrom = _from;
+	if( _from != maFrom )
+	{
+		maFrom = _from;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1401,7 +1541,11 @@ void SAL_CALL AnimationNode::setTo( cons
 	throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maTo = _to;
+	if( _to != maTo )
+	{
+		maTo = _to;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1421,7 +1565,11 @@ void SAL_CALL AnimationNode::setBy( cons
 	throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maBy = _by;
+	if( _by != maBy )
+	{
+		maBy = _by;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1442,6 +1590,7 @@ void SAL_CALL AnimationNode::setTimeFilt
 {
 	Guard< Mutex > aGuard( maMutex );
 	maTimeFilter = _timefilter;
+	fireChangeListener();
 }
 
 // --------------------------------------------------------------------
@@ -1457,7 +1606,11 @@ OUString SAL_CALL AnimationNode::getForm
 void SAL_CALL AnimationNode::setFormula( const OUString& _formula ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	maFormula = _formula;
+	if( _formula != maFormula )
+	{
+		maFormula = _formula;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1475,7 +1628,11 @@ sal_Int16 SAL_CALL AnimationNode::getCol
 void SAL_CALL AnimationNode::setColorInterpolation( sal_Int16 _colorspace ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnColorSpace = _colorspace;
+	if( _colorspace != mnColorSpace )
+	{
+		mnColorSpace = _colorspace;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1493,7 +1650,11 @@ sal_Bool SAL_CALL AnimationNode::getDire
 void SAL_CALL AnimationNode::setDirection( sal_Bool _direction ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mbDirection = _direction;
+	if( _direction != mbDirection )
+	{
+		mbDirection = _direction;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1512,6 +1673,7 @@ void SAL_CALL AnimationNode::setPath( co
 {
 	Guard< Mutex > aGuard( maMutex );
 	maPath = _path;
+	fireChangeListener();
 }
 
 // --------------------------------------------------------------------
@@ -1530,6 +1692,7 @@ void SAL_CALL AnimationNode::setOrigin( 
 {
 	Guard< Mutex > aGuard( maMutex );
 	maOrigin = _origin;
+	fireChangeListener();
 }
 
 // --------------------------------------------------------------------
@@ -1547,7 +1710,11 @@ sal_Int16 SAL_CALL AnimationNode::getTra
 void SAL_CALL AnimationNode::setTransformType( sal_Int16 _transformtype ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnTransformType = _transformtype;
+	if( _transformtype != mnTransformType )
+	{
+		mnTransformType = _transformtype;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1565,7 +1732,11 @@ sal_Int16 SAL_CALL AnimationNode::getTra
 void SAL_CALL AnimationNode::setTransition( sal_Int16 _transition ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnTransition = _transition;
+	if( _transition != mnTransition )
+	{
+		mnTransition = _transition;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1583,7 +1754,11 @@ sal_Int16 SAL_CALL AnimationNode::getSub
 void SAL_CALL AnimationNode::setSubtype( sal_Int16 _subtype ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnSubtype = _subtype;
+	if( _subtype != mnSubtype )
+	{
+		mnSubtype = _subtype;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1601,7 +1776,11 @@ sal_Bool SAL_CALL AnimationNode::getMode
 void SAL_CALL AnimationNode::setMode( sal_Bool _mode ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mbMode = _mode;
+	if( _mode != mbMode )
+	{
+		mbMode = _mode;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1619,7 +1798,11 @@ sal_Int32 SAL_CALL AnimationNode::getFad
 void SAL_CALL AnimationNode::setFadeColor( sal_Int32 _fadecolor ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnFadeColor = _fadecolor;
+	if( _fadecolor != mnFadeColor )
+	{
+		mnFadeColor = _fadecolor;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1638,6 +1821,7 @@ void SAL_CALL AnimationNode::setSource( 
 {
 	Guard< Mutex > aGuard( maMutex );
 	maTarget = _source;
+	fireChangeListener();
 }
 
 // --------------------------------------------------------------------
@@ -1655,7 +1839,11 @@ double SAL_CALL AnimationNode::getVolume
 void SAL_CALL AnimationNode::setVolume( double _volume ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mfVolume = _volume;
+	if( _volume != mfVolume )
+	{
+		mfVolume = _volume;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1673,7 +1861,11 @@ sal_Int16 SAL_CALL AnimationNode::getCom
 void SAL_CALL AnimationNode::setCommand( sal_Int16 _command ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnCommand = _command;
+	if( _command != mnCommand )
+	{
+		mnCommand = _command;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1692,6 +1884,7 @@ void SAL_CALL AnimationNode::setParamete
 {
 	Guard< Mutex > aGuard( maMutex );
 	maParameter = _parameter;
+	fireChangeListener();
 }
 
 // --------------------------------------------------------------------
@@ -1743,6 +1936,9 @@ Reference< XAnimationNode > SAL_CALL Ani
 
 	maChilds.insert( before, newChild );
 
+	Reference< XInterface > xThis( static_cast< OWeakObject * >(this) );
+	newChild->setParent( xThis );
+
 	return newChild;
 }
 
@@ -1865,7 +2061,11 @@ sal_Int16 SAL_CALL AnimationNode::getIte
 void SAL_CALL AnimationNode::setIterateType( sal_Int16 _iteratetype ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mnIterateType = _iteratetype;
+	if( _iteratetype != mnIterateType )
+	{
+		mnIterateType = _iteratetype;
+		fireChangeListener();
+	}
 }
 
 // --------------------------------------------------------------------
@@ -1883,7 +2083,86 @@ double SAL_CALL AnimationNode::getIterat
 void SAL_CALL AnimationNode::setIterateInterval( double _iterateinterval ) throw (RuntimeException)
 {
 	Guard< Mutex > aGuard( maMutex );
-	mfIterateInterval = _iterateinterval;
+	if( _iterateinterval != mfIterateInterval )
+	{
+		mfIterateInterval = _iterateinterval;
+		fireChangeListener();
+	}
+}
+
+// --------------------------------------------------------------------
+
+// XChangesNotifier
+void SAL_CALL AnimationNode::addChangesListener( const Reference< XChangesListener >& aListener ) throw (RuntimeException)
+{
+	maChangeListener.addInterface( aListener );
+}
+
+// --------------------------------------------------------------------
+
+// XChangesNotifier
+void SAL_CALL AnimationNode::removeChangesListener( const Reference< XChangesListener >& aListener ) throw (RuntimeException)
+{
+	maChangeListener.removeInterface(aListener);
+}
+
+// --------------------------------------------------------------------
+
+// XUnoTunnel
+::sal_Int64 SAL_CALL AnimationNode::getSomething( const Sequence< ::sal_Int8 >& rId ) throw (RuntimeException)
+{
+	if( rId.getLength() == 16 && 0 == rtl_compareMemory( getUnoTunnelId().getConstArray(), rId.getConstArray(), 16 ) )
+	{
+		return (sal_Int64)this;
+	}
+	else
+	{
+		return 0;
+	}
+}
+
+// --------------------------------------------------------------------
+
+const ::com::sun::star::uno::Sequence< sal_Int8 > & AnimationNode::getUnoTunnelId()
+{
+	static ::com::sun::star::uno::Sequence< sal_Int8 > * pSeq = 0;
+	if( !pSeq )
+	{
+		::osl::Guard< ::osl::Mutex > aGuard( ::osl::Mutex::getGlobalMutex() );
+		if( !pSeq )
+		{
+			static ::com::sun::star::uno::Sequence< sal_Int8 > aSeq( 16 );
+			rtl_createUuid( (sal_uInt8*)aSeq.getArray(), 0, sal_True );
+			pSeq = &aSeq;
+		}
+	}
+	return *pSeq;
+}
+
+// --------------------------------------------------------------------
+
+void AnimationNode::fireChangeListener()
+{
+	Guard< Mutex > aGuard( maMutex );
+
+	OInterfaceIteratorHelper aIterator( maChangeListener );
+	if( aIterator.hasMoreElements() )
+	{
+		Reference< XInterface > xSource( static_cast<OWeakObject*>(this), UNO_QUERY );
+		Sequence< ElementChange > aChanges;
+		const ChangesEvent aEvent( xSource, makeAny( mxParent ), aChanges );
+		while( aIterator.hasMoreElements() )
+		{
+			Reference< XChangesListener > xListener( aIterator.next(), UNO_QUERY );
+			if( xListener.is() )
+				xListener->changesOccurred( aEvent );
+		}
+	}
+
+	if( mpParent )
+		mpParent->fireChangeListener();
 }
 
+// --------------------------------------------------------------------
+
 }; // namespace animcore
Index: svx/source/unodraw/UnoGraphicExporter.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/unodraw/UnoGraphicExporter.cxx,v
retrieving revision 1.20
retrieving revision 1.20.210.1
diff -u -p -u -p -r1.20 -r1.20.210.1
--- svx/source/unodraw/UnoGraphicExporter.cxx	26 Nov 2004 18:15:04 -0000	1.20
+++ svx/source/unodraw/UnoGraphicExporter.cxx	21 Feb 2005 17:14:17 -0000	1.20.210.1
@@ -947,6 +947,8 @@ sal_Bool SAL_CALL GraphicExporter::filte
 			sdr::contact::DisplayInfo aDisplayInfo;
 			aDisplayInfo.SetProcessedPage( mpCurrentPage );	
 			aDisplayInfo.SetMasterPagePainting( pPage->IsMasterPage() );
+			if( mpCurrentPage && pPage->IsMasterPage() )
+				aDisplayInfo.SetProcessLayers( mpCurrentPage->TRG_GetMasterPageVisibleLayers() );
 
 			aIter = aShapes.begin();
 			while( aIter != aEnd )
@@ -957,8 +959,10 @@ sal_Bool SAL_CALL GraphicExporter::filte
 				sdr::contact::ObjectContactOfPagePainter aObjectContact( pPage, false );
 				sdr::contact::ViewObjectContact aOriginal( aObjectContact, aViewContact);
 
-				if( (pObj->GetPage() == 0) || pObj->GetPage()->checkVisibility(aOriginal, aDisplayInfo, false) )
-					pObj->SingleObjectPainter(aXOut,aInfoRec); // #110094#-17
+				if( aDisplayInfo.GetProcessLayers().IsSet(pObj->SdrObject::GetLayer()) )
+					if( (pObj->GetPage() == 0) || pObj->GetPage()->checkVisibility(aOriginal, aDisplayInfo, false) )
+						pObj->SingleObjectPainter(aXOut,aInfoRec); // #110094#-17
+
 
 				aOriginal.PrepareDelete();
 			}
