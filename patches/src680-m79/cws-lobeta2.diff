Index: filter/source/xsltdialog/xmlfilterdialogstrings.src
===================================================================
RCS file: /cvs/framework/filter/source/xsltdialog/xmlfilterdialogstrings.src,v
retrieving revision 1.11
retrieving revision 1.11.72.1
diff -u -p -u -p -r1.11 -r1.11.72.1
--- filter/source/xsltdialog/xmlfilterdialogstrings.src	20 Aug 2004 08:31:11 -0000	1.11
+++ filter/source/xsltdialog/xmlfilterdialogstrings.src	15 Dec 2004 13:27:52 -0000	1.11.72.1
@@ -120,22 +120,22 @@ String STR_APPL_NAME_DRAW
 
 String STR_APPL_NAME_OASIS_WRITER
 {
-	Text = "%PRODUCTNAME Writer (.oot)";
+	Text = "%PRODUCTNAME Writer (.odt)";
 };
 
 String STR_APPL_NAME_OASIS_CALC
 {
-	Text = "%PRODUCTNAME Calc (.oos)";
+	Text = "%PRODUCTNAME Calc (.ods)";
 };
 
 String STR_APPL_NAME_OASIS_IMPRESS
 {
-	Text = "%PRODUCTNAME Impress (.oop)";
+	Text = "%PRODUCTNAME Impress (.odp)";
 };
 
 String STR_APPL_NAME_OASIS_DRAW
 {
-	Text = "%PRODUCTNAME Draw (.ood)";
+	Text = "%PRODUCTNAME Draw (.odg)";
 };
 
 String STR_WARN_DELETE
Index: filter/source/xsltfilter/XSLTFilter.cxx
===================================================================
RCS file: /cvs/framework/filter/source/xsltfilter/XSLTFilter.cxx,v
retrieving revision 1.5
retrieving revision 1.4.14.2
diff -u -p -u -p -r1.5 -r1.4.14.2
--- filter/source/xsltfilter/XSLTFilter.cxx	27 Jan 2005 12:10:21 -0000	1.5
+++ filter/source/xsltfilter/XSLTFilter.cxx	7 Feb 2005 14:25:10 -0000	1.4.14.2
@@ -203,6 +203,13 @@ void XSLTFilter::started() throw (Runtim
 }
 void XSLTFilter::error(const Any& a) throw (RuntimeException)
 {
+    Exception e;
+    if ( a >>= e)
+    {
+        OString aMessage("XSLTFilter::error was called: ");
+        aMessage += OUStringToOString(e.Message, RTL_TEXTENCODING_ASCII_US);
+        OSL_ENSURE(sal_False, aMessage);
+    }
     m_bError = sal_True;
     osl_setCondition(m_cTransformed);
 }
@@ -431,7 +438,7 @@ sal_Bool XSLTFilter::exporter(
         tsource->setOutputStream(m_rOutputStream);
 
         // don't start transformer yet but wait for buffer to be filled
-        //m_tcontrol->start();
+        // m_tcontrol->start();
 
         return sal_True;
     }
Index: filter/source/xsltfilter/XSLTransformer.java
===================================================================
RCS file: /cvs/framework/filter/source/xsltfilter/XSLTransformer.java,v
retrieving revision 1.7
retrieving revision 1.7.14.1
diff -u -p -u -p -r1.7 -r1.7.14.1
--- filter/source/xsltfilter/XSLTransformer.java	18 Nov 2004 10:17:18 -0000	1.7
+++ filter/source/xsltfilter/XSLTransformer.java	15 Dec 2004 10:57:29 -0000	1.7.14.1
@@ -228,8 +228,9 @@ public class XSLTransformer
                     // remove any dtd references but keep localy defined
                     // entities
 
-                    ByteArrayOutputStream bufstream = new ByteArrayOutputStream();
-                    final int bsize = 2000;
+                    // ByteArrayOutputStream bufstream = new ByteArrayOutputStream();
+                    StringBuffer strbuf = new StringBuffer();
+                    final int bsize = 4000;
                     int rbytes = 0;
                     byte[][] byteBuffer = new byte[1][bsize];
                     // rewind
@@ -238,13 +239,15 @@ public class XSLTransformer
                         xseek.seek(0);
                     }
                     while ((rbytes = xistream.readSomeBytes(byteBuffer, bsize)) != 0)
-                        bufstream.write(byteBuffer[0], 0, rbytes);
+                        strbuf.append(new String(byteBuffer[0], 0, rbytes, "UTF-8"));
+                        // bufstream.write(byteBuffer[0], 0, rbytes);                                        
 
                     // close the input stream after we have transferred all data
                     // into the buffer so it won't keep the content open until it
                     // gets finalized by the java GC
                     xistream.closeInput();
 
+                    /*
                     String xmlFile = bufstream.toString("UTF-8");
                     if (xmlFile.indexOf("<!DOCTYPE")!=-1){
                         String tag = xmlFile.substring(xmlFile.lastIndexOf("/")+1,
@@ -266,25 +269,59 @@ public class XSLTransformer
                             xmlFile.lastIndexOf(">")+1);
                         xmlFile= newDocType.concat(xmlFile);
                     }
+                    */
+                    if (strbuf.indexOf("<!DOCTYPE")!=-1){
+                        // document element tag name
+                        String tag = strbuf.substring(strbuf.lastIndexOf("/")+1,
+                                                      strbuf.lastIndexOf(">"));
+                        String entities = new String();
+                        // look for inline doctype/entities to preserve
+                        if (strbuf.indexOf("[",strbuf.indexOf("<!DOCTYPE"))!=-1){
+                            if (strbuf.indexOf("[",strbuf.indexOf("<!DOCTYPE")) <
+                                strbuf.indexOf(">",strbuf.indexOf("<!DOCTYPE")))
+                            {
+                                // copy inline doctype/entities
+                                entities = strbuf.substring(
+                                    strbuf.indexOf("[",strbuf.indexOf("<!DOCTYPE")),
+                                    strbuf.indexOf("]",strbuf.indexOf("<!DOCTYPE"))+1);
+                            }
+                        }
+                        // construct a new doctype/header including only the saved inline information
+                        String newDocType =
+                            "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE "
+                            +tag+" "+entities+">";
+                        // replace the header of the original buffer (end index is exclusive)
+                        strbuf.replace(0, strbuf.indexOf("<"+tag, 0), newDocType);
+                    }
+                    
+                    // StreamSource xmlsource = new StreamSource(
+                    //     new ByteArrayInputStream(xmlFile.getBytes("UTF-8")));
+                    
+                    char[] xmlchars = new char[strbuf.length()];  // we need to copy here :(
+                    strbuf.getChars(0, strbuf.length(), xmlchars, 0) ;
+                    strbuf = null;
+           
                     StreamSource xmlsource = new StreamSource(
-                        new ByteArrayInputStream(xmlFile.getBytes("UTF-8")));
-
-                    ByteArrayOutputStream resultbuf = new ByteArrayOutputStream();
-                    StreamResult xmlresult = new StreamResult(resultbuf);
+                        new CharArrayReader(xmlchars));
+                    
+                    // ByteArrayOutputStream resultbuf = new ByteArrayOutputStream();
+                    BufferedOutputStream output = new BufferedOutputStream(
+                        new XOutputStreamToOutputStreamAdapter(xostream));
+                    StreamResult xmlresult = new StreamResult(output);
                     TransformerFactory tfactory = TransformerFactory.newInstance();
                     Transformer transformer = tfactory.newTransformer(stylesource);
 
                     // invalid to set 'null' as parameter as 'null' is not a valid Java object
                     if(sourceurl != null)
-					    transformer.setParameter("sourceURL", sourceurl);
+                        transformer.setParameter("sourceURL", sourceurl);
                     if(targeturl != null)
-    					transformer.setParameter("targetURL", targeturl);
+                        transformer.setParameter("targetURL", targeturl);
                     if(targetbaseurl != null)
-    					transformer.setParameter("targetBaseURL", targetbaseurl);
+                        transformer.setParameter("targetBaseURL", targetbaseurl);
                     if(pubtype != null)
-    					transformer.setParameter("publicType", pubtype);
+                        transformer.setParameter("publicType", pubtype);
                     if(systype != null)
-    					transformer.setParameter("systemType", systype);
+                        transformer.setParameter("systemType", systype);
 
                     long tstart = System.currentTimeMillis();
                     transformer.transform(xmlsource, xmlresult);
@@ -292,8 +329,11 @@ public class XSLTransformer
                     if (statsp != null) {
                         statsp.println("finished transformation in "+time+"ms");
                     }
-                    String resultstring = resultbuf.toString();
-                    xostream.writeBytes(resultbuf.toByteArray());
+                    // dereference input buffer
+                    xmlsource = null;
+                    xmlchars = null;
+                    
+                    output.close();
                     xostream.closeOutput();
 
                     // notify any listeners about close
Index: officecfg/registry/data/org/openoffice/Setup.xcu
===================================================================
RCS file: /cvs/util/officecfg/registry/data/org/openoffice/Setup.xcu,v
retrieving revision 1.15
retrieving revision 1.13.10.6
diff -u -p -u -p -r1.15 -r1.13.10.6
--- officecfg/registry/data/org/openoffice/Setup.xcu	27 Jan 2005 14:23:39 -0000	1.15
+++ officecfg/registry/data/org/openoffice/Setup.xcu	7 Feb 2005 13:30:21 -0000	1.13.10.6
@@ -515,23 +515,29 @@
 					<value>.*/database/biblio/biblio\.dbf</value>
 				</prop>
 				<prop oor:name="ExcludedFiles">
-					<value/>
 				</prop>
 				<prop oor:name="IncludedNodes">
+                    <value>
+                        org.openoffice.Office.DataAccess
+                    </value>
 				</prop>
 				<prop oor:name="ExcludedNodes">
+	                <value>
+                        org.openoffice.Office.DataAccess/Bibliography
+                        org.openoffice.Office.DataAccess/ConnectionPool
+                        org.openoffice.Office.DataAccess/DataSources
+                        org.openoffice.Office.DataAccess/DriverManager
+                    </value>
 				</prop>			
 			</node>
-			<node oor:name="UCB" oor:op="replace">
-				<prop oor:name="IncludedNodes">
-					<value>org.openoffice.Inet/Settings
-					</value>
+			<node oor:name="Deployment" oor:op="replace">
+				<prop oor:name="MigrationService">
+					<value>com.sun.star.comp.deployment.migration.Migration_2_0</value>
 				</prop>
 			</node>
-			<node oor:name="VCL" oor:op="replace">
+			<node oor:name="Inet" oor:op="replace">
 				<prop oor:name="IncludedNodes">
-					<value>org.openoffice.Office.Common/I18N/CTL/UIMirroring
-					       org.openoffice.Office.Common/I18NInputMethod/ShowStatusWindow
+					<value>org.openoffice.Inet
 					</value>
 				</prop>
 			</node>
@@ -553,6 +559,123 @@
 					<value>org.openoffice.UserProfile</value>
 				</prop>
 			</node>			
+            <node oor:name="Common" oor:op="replace">
+                <prop oor:name="IncludedNodes">
+                    <value>
+                        org.openoffice.Office.Common/Accessibility
+                        org.openoffice.Office.Common/Accessibility/AutoDetectSystemHC
+                        org.openoffice.Office.Common/AddXMLToStrorage
+                        org.openoffice.Office.Common/AsianLayout
+                        org.openoffice.Office.Common/AutoCorrect
+                        org.openoffice.Office.Common/Cache
+                        org.openoffice.Office.Common/ExternalMailer/Program
+                        org.openoffice.Office.Common/Filter
+                        org.openoffice.Office.Common/Font
+                        org.openoffice.Office.Common/Gallery
+                        org.openoffice.Office.Common/Help
+                        org.openoffice.Office.Common/History 
+                        org.openoffice.Office.Common/I18N
+                        org.openoffice.Office.Common/InternalMSExport
+                        org.openoffice.Office.Common/Load
+                        org.openoffice.Office.Common/Misc/Form/ControlPilotsEnabled
+                        org.openoffice.Office.Common/Misc/PluginsEnabled
+                        org.openoffice.Office.Common/Misc/SymbolSet
+                        org.openoffice.Office.Common/Misc/UseSystemFileDialog
+                        org.openoffice.Office.Common/Misc/UseSystemFileDialog
+                        org.openoffice.Office.Common/OfficeObjects
+                        org.openoffice.Office.Common/Passwords
+                        org.openoffice.Office.Common/Print/PrintingModifiesDocument
+                        org.openoffice.Office.Common/Print/Warning
+                        org.openoffice.Office.Common/PrintVectorize
+                        org.openoffice.Office.Common/Save
+                        org.openoffice.Office.Common/SearchOptions
+                        org.openoffice.Office.Common/SearchOptionsJapanese
+                        org.openoffice.Office.Common/Undo
+                        org.openoffice.Office.Common/View/Dialog/Dialog/MiddleMouseButton
+                        org.openoffice.Office.Common/View/Dialog/MousePositioning
+                        org.openoffice.Office.Common/View/Localization
+                        org.openoffice.Office.Common/View/Menu
+                        org.openoffice.Office.Common/_3D_Engine
+                    </value>
+                </prop>
+ 				<prop oor:name="ExcludedNodes">
+                    <value>
+                        org.openoffice.Office.Common/Filter/PDF
+                        org.openoffice.Office.Common/_3D_Engine/OpenGL
+                    </value>
+				</prop>		
+            </node>
+ 			<node oor:name="Calc" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Calc</value>
+				</prop>
+			</node>			
+            <node oor:name="Chart" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Chart/DefaultColor</value>
+				</prop>
+			</node>			
+            <node oor:name="Draw" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Draw</value>
+				</prop>
+			</node>			
+             <node oor:name="Impress" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Impress</value>
+				</prop>
+			</node>			
+            <node oor:name="Labels" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Labels</value>
+				</prop>
+			</node>			
+            <node oor:name="Linguistic" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Linguistic</value>
+				</prop>
+ 				<prop oor:name="ExcludedNodes">
+                    <value>
+                        org.openoffice.Office.Linguistic/ServiceManagerManager
+                    </value>
+                </prop>	
+			</node>			
+            <node oor:name="Math" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Math</value>
+				</prop>
+			</node>			
+            <node oor:name="Security" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Security</value>
+				</prop>
+			</node>			
+            <node oor:name="Setup" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Setup/L10N</value>
+				</prop>
+			</node>			
+            <node oor:name="UI" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.UI/ColorScheme</value>
+				</prop>
+			</node>			
+            <node oor:name="Views" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Views</value>
+				</prop>
+			</node>			
+            <node oor:name="Writer" oor:op="replace">
+				<prop oor:name="IncludedNodes">
+					<value>org.openoffice.Office.Writer</value>
+					<value>org.openoffice.Office.WriterWeb</value>
+				</prop>
+				<prop oor:name="ExcludedNodes">
+                    <value>
+                        org.openoffice.Office.Writer/Wizard
+                    </value>
+                </prop>
+    		</node>			
 		</node>
 	</node>
 </oor:component-data>
Index: dbaccess/source/filter/migration/cfgimport.cxx
===================================================================
RCS file: /cvs/dba/dbaccess/source/filter/migration/cfgimport.cxx,v
retrieving revision 1.4
retrieving revision 1.4.48.1
diff -u -p -u -p -r1.4 -r1.4.48.1
--- dbaccess/source/filter/migration/cfgimport.cxx	15 Nov 2004 15:17:53 -0000	1.4
+++ dbaccess/source/filter/migration/cfgimport.cxx	24 Feb 2005 21:17:09 -0000	1.4.48.1
@@ -59,10 +59,10 @@
  *
  ************************************************************************/
 
-#include "cfgimport.hxx" 
+#include "cfgimport.hxx"
 
 #ifndef CFG_REGHELPER_HXX
-#include "cfg_reghelper.hxx" 
+#include "cfg_reghelper.hxx"
 #endif
 #ifndef _SV_SVAPP_HXX
 #include <vcl/svapp.hxx>
@@ -103,7 +103,7 @@
 #ifndef INCLUDED_SVTOOLS_PATHOPTIONS_HXX
 #include <svtools/pathoptions.hxx>
 #endif
-#ifndef _COM_SUN_STAR_FRAME_XCOMPONENTLOADER_HPP_ 
+#ifndef _COM_SUN_STAR_FRAME_XCOMPONENTLOADER_HPP_
 #include <com/sun/star/frame/XComponentLoader.hpp>
 #endif
 #ifndef DBACCESS_SHARED_CFGSTRINGS_HRC
@@ -174,7 +174,7 @@
 #endif
 
 
-extern "C" void SAL_CALL createRegistryInfo_OCfgImport( ) 
+extern "C" void SAL_CALL createRegistryInfo_OCfgImport( )
 {
 	static ::dbacfg::OMultiInstanceAutoRegistration< ::dbacfg::OCfgImport > aAutoRegistration;
 }
@@ -222,8 +222,8 @@ using namespace dbacfg;
 // - OCfgImport -
 // -------------
 
-OCfgImport::OCfgImport( const Reference< XMultiServiceFactory >& _rxMSF ) 
-	:m_xORB( _rxMSF ) 
+OCfgImport::OCfgImport( const Reference< XMultiServiceFactory >& _rxMSF )
+	:m_xORB( _rxMSF )
 	,m_bPropertyMayBeVoid(sal_True)
 {
 }
@@ -279,19 +279,19 @@ void LoadTableWindows(const Reference< X
 			const static ::rtl::OUString s_sTables(RTL_CONSTASCII_USTRINGPARAM("Tables"));
 			for (; pViewIter != pEnd && pViewIter->Name != s_sTables; ++pViewIter)
 				;
-			
+
 			if ( pViewIter == pEnd )
 			{
-				sal_Int32 nLen = _rViewProps.getLength(); 
+				sal_Int32 nLen = _rViewProps.getLength();
 				_rViewProps.realloc( nLen + 1 );
 				pViewIter = _rViewProps.getArray() + nLen;
 				pViewIter->Name = s_sTables;
 			}
-			
+
 			Sequence<PropertyValue> aTables(nCount);
 			PropertyValue *pIter = aTables.getArray();
 
-			
+
 			for(sal_Int32 i=0;i<nCount;++i,++pIter)
 			{
 				pIter->Name = ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("Table")) + ::rtl::OUString::valueOf(i+1);
@@ -360,7 +360,7 @@ void LoadTableFields(const Reference< XO
 		sal_Int32 nLen = _rViewProps.getLength();
 		_rViewProps.realloc( nLen + 2 + (nCount != 0 ? 1 : 0) );
 		pIter = _rViewProps.getArray() + nLen;
-		
+
 		if ( nCount != 0 )
 		{
 			pIter->Name = ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("Fields"));
@@ -399,7 +399,7 @@ void LoadTableFieldDesc(const Reference<
 	::rtl::OUString		aFieldAlias;	// column alias
 	::rtl::OUString		aDatabaseName;	// qualifier or catalog
 	::rtl::OUString		aFunctionName;	// enth"alt den Funktionsnamen, nur wenn eFunctionType != FKT_NONE gesetzt
-	
+
 	sal_Int32			eDataType;
 	sal_Int32			eFunctionType;
 	sal_Int32			eFieldType;
@@ -492,10 +492,10 @@ sal_Bool isDocumentReport(const Referenc
 				aMedDescr[nPos].Name = ::rtl::OUString::createFromAscii( "ReadOnly" );
 				aMedDescr[nPos++].Value <<= sal_True;
 				Reference< XTypeDetection > xTypeDetection(_xORB->createInstance( ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.document.TypeDetection")) ),UNO_QUERY );
-	
+
 				if ( !xTypeDetection.is() )
 					throw RuntimeException(); // TODO
-			
+
 				// get TypeName
 				::rtl::OUString aTypeName = xTypeDetection->queryTypeByDescriptor( aMedDescr, sal_True );
 				const PropertyValue* pIter = aMedDescr.getConstArray();
@@ -525,7 +525,7 @@ sal_Bool isDocumentReport(const Referenc
 				try
 				{
 					xLoadable->load(aMedDescr);
-				
+
 					Reference< XEventsSupplier> xEventsSup(xDocument,UNO_QUERY);
 					Reference< XNameReplace> xEvents = xEventsSup.is() ? xEventsSup->getEvents() : Reference< XNameReplace>();
 					static const ::rtl::OUString s_sOnNew = ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("OnNew"));
@@ -563,9 +563,9 @@ sal_Bool isDocumentReport(const Referenc
 								Reference<XPropertySet> xProp(xControls->getByName(*pControlIter),UNO_QUERY);
 								sal_Int16 nClassId = 0;
 								const static ::rtl::OUString s_sClassId = ::rtl::OUString(RTL_CONSTASCII_USTRINGPARAM("ClassId"));
-								if ( xProp.is() 
-									&& xProp->getPropertySetInfo().is() 
-									&& xProp->getPropertySetInfo()->hasPropertyByName(s_sClassId) 
+								if ( xProp.is()
+									&& xProp->getPropertySetInfo().is()
+									&& xProp->getPropertySetInfo()->hasPropertyByName(s_sClassId)
 									&& (xProp->getPropertyValue(s_sClassId) >>= nClassId) )
 								{
 									bForm = nClassId != FormComponentType::HIDDENCONTROL;
@@ -598,10 +598,10 @@ void OCfgImport::createDataSource(const 
 	::rtl::OUString sExtension;
 	static const String s_sDatabaseType = String::CreateFromAscii("StarOffice XML (Base)");
 	const SfxFilter* pFilter = SfxFilter::GetFilterByName( s_sDatabaseType);
-	OSL_ENSURE(pFilter,"Filter: StarOffice XML (Base) could not be found!"); 
+	OSL_ENSURE(pFilter,"Filter: StarOffice XML (Base) could not be found!");
 	if ( pFilter )
 	{
-		String aRet = pFilter->GetDefaultExtension(); 
+		String aRet = pFilter->GetDefaultExtension();
 		while( aRet.SearchAndReplaceAscii( "*.", String() ) != STRING_NOTFOUND );
 		sExtension = aRet;
 	}
@@ -619,7 +619,7 @@ void OCfgImport::createDataSource(const 
 		aURL.setExtension(sExtension);
 
 		sFileName = aURL.GetMainURL(INetURLObject::NO_DECODE);
-		
+
 		sal_Int32 i = 0;
 		// create unique name
 		while ( UCBContentHelper::IsDocument(sFileName) )
@@ -629,7 +629,7 @@ void OCfgImport::createDataSource(const 
 			aURL.setExtension(sExtension);
 			sFileName = aURL.GetMainURL(INetURLObject::NO_DECODE);
 		}
-		
+
 		xModel->attachResource(sFileName,Sequence<PropertyValue>());
 	}
 	catch(Exception&)
@@ -669,7 +669,7 @@ void OCfgImport::setProperties()
 				xFormMultiSet.set(m_xCurrentDS,UNO_QUERY);
 
 			if ( xFormMultiSet.is() )
-				xFormMultiSet->setPropertyValues(m_aProperties, m_aValues);			
+				xFormMultiSet->setPropertyValues(m_aProperties, m_aValues);
 		}
 		catch(const Exception& e)
 		{
@@ -687,23 +687,23 @@ Any SAL_CALL OCfgImport::execute( const 
 }
 // -----------------------------------------------------------------------------
 // XLayerHandler
-void SAL_CALL OCfgImport::startLayer() 	 
+void SAL_CALL OCfgImport::startLayer()
     throw(WrappedTargetException)
 {
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL OCfgImport::endLayer() 	 
-    throw(	 
+void SAL_CALL OCfgImport::endLayer()
+    throw(
         MalformedDataException,
         WrappedTargetException )
 {
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL OCfgImport::overrideNode( 
-        const ::rtl::OUString& aName, 
-        sal_Int16 aAttributes, 
+void SAL_CALL OCfgImport::overrideNode(
+        const ::rtl::OUString& aName,
+        sal_Int16 aAttributes,
         sal_Bool bClear)
     throw(
         MalformedDataException,
@@ -714,9 +714,9 @@ void SAL_CALL OCfgImport::overrideNode( 
 // -----------------------------------------------------------------------------
 
 void SAL_CALL OCfgImport::addOrReplaceNode(
-        const ::rtl::OUString& aName, 
-        sal_Int16 aAttributes) 
-    throw(	
+        const ::rtl::OUString& aName,
+        sal_Int16 aAttributes)
+    throw(
         MalformedDataException,
         WrappedTargetException )
 {
@@ -760,7 +760,7 @@ void SAL_CALL OCfgImport::addOrReplaceNo
 					if ( xSupplier.is() )
 					{
 						Reference<XDataDescriptorFactory> xFact(xSupplier->getColumns(),UNO_QUERY);
-						
+
 						m_xCurrentColumn = ( xFact.is() ? xFact->createDataDescriptor() : Reference<XPropertySet>());
 						if ( m_xCurrentColumn.is() )
 							m_xCurrentColumn->setPropertyValue(PROPERTY_NAME,makeAny(aName));
@@ -775,7 +775,7 @@ void SAL_CALL OCfgImport::addOrReplaceNo
 	}
 	/*if ( aName.equalsAscii("org.openoffice.Office.DataAccess") )
 		m_aStack.push(TElementStack::value_type(aName,0));
-	else*/ 
+	else*/
 	if ( aName.equalsAscii("DataSources") )
 		m_aStack.push(TElementStack::value_type(aName,DATASOURCES));
 	else if ( aName.equalsAscii("DataSourceSettings") )
@@ -797,10 +797,10 @@ void SAL_CALL OCfgImport::addOrReplaceNo
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL  OCfgImport::addOrReplaceNodeFromTemplate( 	 
+void SAL_CALL  OCfgImport::addOrReplaceNodeFromTemplate(
         const ::rtl::OUString& aName,
         const TemplateIdentifier& aTemplate,
-        sal_Int16 aAttributes ) 
+        sal_Int16 aAttributes )
     throw(
         MalformedDataException,
         WrappedTargetException )
@@ -808,8 +808,8 @@ void SAL_CALL  OCfgImport::addOrReplaceN
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL  OCfgImport::endNode() 	 
-    throw(	 
+void SAL_CALL  OCfgImport::endNode()
+    throw(
         MalformedDataException,
         WrappedTargetException )
 {
@@ -827,7 +827,7 @@ void SAL_CALL  OCfgImport::endNode() 	 
 						xStr = NULL;
 					}
 					// register the new datbase document
-					
+
 					if ( !m_sCurrentDataSourceName.equalsAscii("Bibliography") )
 					{
 						// create unique name
@@ -861,7 +861,8 @@ void SAL_CALL  OCfgImport::endNode() 	 
 					Reference<XNameContainer> xTables(xSupplier->getTables(),UNO_QUERY);
 					::rtl::OUString sName;
 					m_xCurrentObject->getPropertyValue(PROPERTY_NAME) >>= sName;
-					xTables->insertByName(sName,makeAny(m_xCurrentObject));
+                    if ( !xTables->hasByName(sName) )
+                        xTables->insertByName(sName,makeAny(m_xCurrentObject));
 					m_xCurrentObject = NULL;
 				}
 				break;
@@ -944,26 +945,26 @@ void SAL_CALL  OCfgImport::endNode() 	 
 				break;
 		}
 
-		m_aStack.pop();	
+		m_aStack.pop();
 	}
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL  OCfgImport::dropNode( 	 
-        const ::rtl::OUString& aName ) 
-    throw( 
+void SAL_CALL  OCfgImport::dropNode(
+        const ::rtl::OUString& aName )
+    throw(
         MalformedDataException,
         WrappedTargetException )
 {
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL  OCfgImport::overrideProperty( 	 
+void SAL_CALL  OCfgImport::overrideProperty(
         const ::rtl::OUString& aName,
         sal_Int16 aAttributes,
         const Type& aType,
-        sal_Bool bClear ) 
-    throw(	 
+        sal_Bool bClear )
+    throw(
         MalformedDataException,
         WrappedTargetException )
 {
@@ -990,7 +991,7 @@ void SAL_CALL  OCfgImport::overridePrope
 						sProp = PROPERTY_SUPPRESSVERSIONCL;
 					else if ( aName == CONFIGKEY_LAYOUTINFORMATION )
 						sProp = PROPERTY_LAYOUTINFORMATION;
-					
+
 					if ( sProp.getLength() )
 					{
 						sal_Int32 nPos = m_aProperties.getLength();
@@ -1081,7 +1082,7 @@ void SAL_CALL  OCfgImport::overridePrope
 					else if ( m_bPropertyMayBeVoid = (aName == CONFIGKEY_COLUMN_HELPTEXT) ) sProp = PROPERTY_HELPTEXT;
 					else if ( m_bPropertyMayBeVoid = (aName == CONFIGKEY_COLUMN_CONTROLDEFAULT) ) sProp = PROPERTY_CONTROLDEFAULT;
 					else if ( m_bPropertyMayBeVoid = (aName == CONFIGKEY_COLUMN_NUMBERFORMAT) ) sProp = PROPERTY_NUMBERFORMAT;
-					
+
 
 					if ( sProp.getLength() )
 					{
@@ -1100,9 +1101,9 @@ void SAL_CALL  OCfgImport::overridePrope
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL  OCfgImport::setPropertyValue( 	 
-        const Any& aValue ) 
-    throw( 
+void SAL_CALL  OCfgImport::setPropertyValue(
+        const Any& aValue )
+    throw(
         MalformedDataException,
         WrappedTargetException )
 {
@@ -1188,18 +1189,18 @@ void SAL_CALL  OCfgImport::setPropertyVa
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL OCfgImport::setPropertyValueForLocale( 	 
+void SAL_CALL OCfgImport::setPropertyValueForLocale(
         const Any& aValue,
-        const ::rtl::OUString& aLocale ) 
-    throw(	 
+        const ::rtl::OUString& aLocale )
+    throw(
         MalformedDataException,
         WrappedTargetException )
 {
 }
 // -----------------------------------------------------------------------------
 
-void SAL_CALL  OCfgImport::endProperty() 	 
-    throw(	 
+void SAL_CALL  OCfgImport::endProperty()
+    throw(
         MalformedDataException,
         WrappedTargetException )
 {
Index: sfx2/source/appl/namecont.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/appl/namecont.cxx,v
retrieving revision 1.48
retrieving revision 1.48.62.1
diff -u -p -u -p -r1.48 -r1.48.62.1
--- sfx2/source/appl/namecont.cxx	27 Jan 2005 14:25:12 -0000	1.48
+++ sfx2/source/appl/namecont.cxx	24 Feb 2005 13:06:59 -0000	1.48.62.1
@@ -146,12 +146,15 @@ using namespace rtl;
 using namespace osl;
 
 
+// #i34411: Flag for error handling during migration 
+bool GbMigrationSuppressErrors = false;
+
+
 //============================================================================
 // Implementation class NameContainer_Impl
 
 namespace SfxContainer_Impl
 {
-
 // Methods XElementAccess
 Type NameContainer_Impl::getElementType()
 	throw(RuntimeException)
@@ -767,6 +770,8 @@ sal_Bool SfxLibraryContainer_Impl::init(
 						    OSL_ENSURE( 0, "Different library names in library"
 							    " container and library info files!\n" );
 					    }
+						if( GbMigrationSuppressErrors && !bLoaded )
+							removeLibrary( aLibName );
 				    }
 			    }
 			    else if( !bStorage )
@@ -928,7 +933,9 @@ sal_Bool SfxLibraryContainer_Impl::init(
 				OUString aLibInfoFileName = aPrevUserBasicLibInfoInetObj.GetMainURL( INetURLObject::NO_DECODE );
 				Sequence<Any> aInitSeq( 1 );
 				aInitSeq.getArray()[0] <<= aLibInfoFileName;
+				GbMigrationSuppressErrors = true;
 				pPrevCont->initialize( aInitSeq );
+				GbMigrationSuppressErrors = false;
 
 				// Rename folders back
 				mxSFI->move( aFolderUserBasic, aPrevFolder );
@@ -1352,9 +1359,12 @@ sal_Bool SfxLibraryContainer_Impl::implL
 		catch( Exception& )
 		{
             xInput.clear();
-		    SfxErrorContext aEc( ERRCTX_SFX_LOADBASIC, aLibInfoPath );
-            ULONG nErrorCode = ERRCODE_IO_GENERAL;
-            ErrorHandler::HandleError( nErrorCode );
+			if( !GbMigrationSuppressErrors )
+			{
+				SfxErrorContext aEc( ERRCTX_SFX_LOADBASIC, aLibInfoPath );
+				ULONG nErrorCode = ERRCODE_IO_GENERAL;
+				ErrorHandler::HandleError( nErrorCode );
+			}
 		}
 	}
 	if( !xInput.is() )
Index: desktop/prj/build.lst
===================================================================
RCS file: /cvs/framework/desktop/prj/build.lst,v
retrieving revision 1.27
retrieving revision 1.23.4.3
diff -u -p -u -p -r1.27 -r1.23.4.3
--- desktop/prj/build.lst	11 Jan 2005 11:25:36 -0000	1.27
+++ desktop/prj/build.lst	7 Feb 2005 14:32:12 -0000	1.23.4.3
@@ -6,7 +6,7 @@ dt	desktop\res								get		-	all	dt_res 
 dt	desktop\source\app						nmake	-	all	dt_app NULL
 dt	desktop\source\migration				nmake	-	all	dt_migr dt_app NULL
 dt	desktop\source\migration\services			nmake	-	all	dt_services NULL
-dt	desktop\source\so_comp					nmake	-	all	dt_so_comp NULL
+dt	desktop\source\so_comp					nmake	-	all	dt_so_comp dt_migr NULL
 dt	desktop\source\offacc					nmake	-	all	dt_offac NULL
 dt	desktop\source\splash					nmake	-	all	dt_spl NULL
 dt	desktop\win32\source					nmake	-	w	dt_wrapper NULL
Index: desktop/source/app/app.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/app.cxx,v
retrieving revision 1.166
retrieving revision 1.159.4.6
diff -u -p -u -p -r1.166 -r1.159.4.6
--- desktop/source/app/app.cxx	2 Feb 2005 13:45:19 -0000	1.166
+++ desktop/source/app/app.cxx	7 Feb 2005 13:50:08 -0000	1.159.4.6
@@ -76,7 +76,6 @@
 #include "desktopcontext.hxx"
 #include "exithelper.hxx"
 #include "javainteractionhandler.hxx"
-#include "../migration/wizard.hxx"
 
 #ifndef _COM_SUN_STAR_FRAME_XSESSIONMANAGERLISTENER_HPP_
 #include <com/sun/star/frame/XSessionManagerListener.hpp>
@@ -392,7 +391,7 @@ ResMgr* Desktop::GetDesktopResManager()
             as.SetUILanguage(aLanguageType);
             SetSettings(as);
 */
-            LanguageSelection langselect;
+            // LanguageSelection langselect;
             OUString aUILocaleString = LanguageSelection::getLanguageString();
             sal_Int32 nIndex = 0;
             OUString aLanguage = aUILocaleString.getToken( 0, '-', nIndex);
@@ -1486,12 +1485,17 @@ void Desktop::Main()
         tools::InitTestToolLib();
 
         // First Start Wizard
-        FirstStartWizard fsw(NULL);
-        if (!fsw.Execute()) {
-            Reference< XDesktop > xDesktop( xSMgr->createInstance(
-                OUString( RTL_CONSTASCII_USTRINGPARAM( "com.sun.star.frame.Desktop"))),UNO_QUERY);
-            xDesktop.is() && xDesktop->terminate();
-            return;
+        {
+            Reference< XJob > xFirstStartJob( xSMgr->createInstance(
+                DEFINE_CONST_UNICODE( "com.sun.star.comp.desktop.FirstStart" ) ), UNO_QUERY );
+            if (xFirstStartJob.is())
+            {
+                sal_Bool bDone = sal_False;
+                xFirstStartJob->execute(Sequence<NamedValue>()) >>= bDone;
+                if (!bDone) {
+                    return;
+                }
+            }
         }
 
         if (xGlobalBroadcaster.is())
@@ -2237,6 +2241,13 @@ String GetURL_Impl( const String& rName 
         return rName;
     }
 
+    // dont touch file urls, those should already be in internal form
+    // they won't get better here (#112849#)
+    if (rName.CompareToAscii("file:" , 5) == COMPARE_EQUAL)
+    {
+        return rName;
+    }
+
     if ( rName.CompareToAscii("service:" , 8) == COMPARE_EQUAL )
     {
         return rName;
@@ -2279,172 +2290,7 @@ String GetURL_Impl( const String& rName 
 
 void Desktop::HandleAppEvent( const ApplicationEvent& rAppEvent )
 {
-    if ( rAppEvent.IsOpenEvent() || rAppEvent.IsPrintEvent() )
-    {
-        String aPrinterName;
-        Reference< XComponentLoader > xDesktop(
-                ::comphelper::getProcessServiceFactory()->createInstance( OUSTRING(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.frame.Desktop")) ),
-                ::com::sun::star::uno::UNO_QUERY );
-
-        // create parameter array
-        sal_Int32 nCount = rAppEvent.IsPrintEvent() ? 5 : 1;
-        Sequence < PropertyValue > aArgs( nCount );
-        aArgs[0].Name = ::rtl::OUString::createFromAscii("Referer");
-
-        if ( rAppEvent.IsPrintEvent() )
-        {
-            aArgs[1].Name = ::rtl::OUString::createFromAscii("ReadOnly");
-            aArgs[2].Name = ::rtl::OUString::createFromAscii("OpenNewView");
-            aArgs[3].Name = ::rtl::OUString::createFromAscii("Hidden");
-            aArgs[4].Name = ::rtl::OUString::createFromAscii("Silent");
-        }
-
-        // mark request as user interaction from outside
-        aArgs[0].Value <<= ::rtl::OUString::createFromAscii("private:OpenEvent");
-
-        for( sal_uInt16 i=0; i<rAppEvent.GetParamCount(); i++ )
-        {
-            // get file name
-            String aName( rAppEvent.GetParam(i) );
-            ::rtl::OUString aTarget( DEFINE_CONST_UNICODE("_default") );
-
-            // is the parameter a printername ?
-            if( aName.Len()>1 && *aName.GetBuffer()=='@' )
-            {
-                aPrinterName = aName.Copy(1);
-                continue;
-            }
-
-            aName = GetURL_Impl(aName);
-
-            if ( rAppEvent.IsPrintEvent() )
-            {
-                // documents opened for printing are opened readonly because they must be opened as a new document and this
-                // document could be open already
-                aArgs[1].Value <<= sal_True;
-
-                // always open a new document for printing, because it must be disposed afterwards
-                aArgs[2].Value <<= sal_True;
-
-                // printing is done in a hidden view
-                aArgs[3].Value <<= sal_True;
-
-                // load document for printing without user interaction
-                aArgs[4].Value <<= sal_True;
-
-                // hidden documents should never be put into open tasks
-                aTarget = ::rtl::OUString( DEFINE_CONST_UNICODE("_blank") );
-            }
-
-            Reference < XPrintable > xDoc;
-            if(
-                ( aName.CompareToAscii( ".uno"  , 4 ) == COMPARE_EQUAL )  ||
-                ( aName.CompareToAscii( "slot:" , 5 ) == COMPARE_EQUAL )  ||
-                ( aName.CompareToAscii( "macro:", 6 ) == COMPARE_EQUAL )  ||
-                ( aName.CompareToAscii( "vnd.sun.star.script", 19 ) == COMPARE_EQUAL )
-              )
-            {
-                URL             aURL ;
-                aURL.Complete = aName;
-
-                Reference < XDispatch >         xDispatcher ;
-                Reference < XDispatchProvider > xProvider   ( xDesktop, UNO_QUERY );
-                Reference < XURLTransformer >   xParser     ( ::comphelper::getProcessServiceFactory()->createInstance( OUSTRING(RTL_CONSTASCII_USTRINGPARAM("com.sun.star.util.URLTransformer")) ), ::com::sun::star::uno::UNO_QUERY );
-
-                if( xParser.is() == sal_True )
-                    xParser->parseStrict( aURL );
-
-                if( xProvider.is() == sal_True )
-                    xDispatcher = xProvider->queryDispatch( aURL, ::rtl::OUString(), 0 );
-
-                if( xDispatcher.is() == sal_True )
-                {
-                    // We have to be listener to catch errors during dispatching URLs.
-                    // Otherwise it would be possible to have an office running without an open
-                    // window!!
-                    Reference < XNotifyingDispatch > xDisp( xDispatcher, UNO_QUERY );
-                    if ( xDisp.is() )
-                        xDisp->dispatchWithNotification( aURL, aArgs, DispatchWatcher::GetDispatchWatcher() );
-                    else
-                        xDispatcher->dispatch( aURL, aArgs );
-                }
-            }
-            else
-            {
-                INetURLObject aObj( aName );
-                if ( aObj.GetProtocol() == INET_PROT_PRIVATE )
-                    aTarget = ::rtl::OUString( DEFINE_CONST_UNICODE("_blank") );
-
-                try{
-                    xDoc = Reference < XPrintable >( xDesktop->loadComponentFromURL( aName, aTarget, 0, aArgs ), UNO_QUERY );
-                }
-                catch ( ::com::sun::star::lang::IllegalArgumentException& iae)
-                {
-                    OUString aMsg = OUString::createFromAscii(
-                        "handle app event IllegalArgumentException while calling loadComponentFromURL: ")
-                        + iae.Message;
-                    OSL_ENSURE( sal_False, OUStringToOString(aMsg, RTL_TEXTENCODING_ASCII_US).getStr());
-                }
-                catch (com::sun::star::io::IOException& ioe)
-                {
-                    OUString aMsg = OUString::createFromAscii(
-                        "handle app event IOException while calling loadComponentFromURL: ")
-                        + ioe.Message;
-                    OSL_ENSURE( sal_False, OUStringToOString(aMsg, RTL_TEXTENCODING_ASCII_US).getStr());
-                }
-
-                if ( !xDoc.is() )
-                {
-                    // error case
-                    Reference< XFramesSupplier > xTasksSupplier( xDesktop, UNO_QUERY );
-                    Reference< XElementAccess > xList( xTasksSupplier->getFrames(), UNO_QUERY );
-
-                    if ( !xList->hasElements() )
-                    {
-                        // We don't have any task open so we have to shutdown ourself!!
-                        Reference< XDesktop > xDesktop( xTasksSupplier, UNO_QUERY );
-                        if ( xDesktop.is() )
-                            xDesktop->terminate();
-                        return;
-                    }
-                }
-            }
-
-            if ( rAppEvent.IsPrintEvent() )
-            {
-                if ( xDoc.is() )
-                {
-                    if ( aPrinterName.Len() )
-                    {
-                        // create the printer
-                        Sequence < PropertyValue > aPrinterArgs( 1 );
-                        aPrinterArgs[0].Name = ::rtl::OUString::createFromAscii("Name");
-                        aPrinterArgs[0].Value <<= ::rtl::OUString( aPrinterName );
-                        xDoc->setPrinter( aPrinterArgs );
-                    }
-
-                    // print ( also without user interaction )
-                    Sequence < PropertyValue > aPrinterArgs( 1 );
-                    aPrinterArgs[0].Name = ::rtl::OUString::createFromAscii("Silent");
-                    aPrinterArgs[0].Value <<= ( sal_Bool ) sal_True;
-                    xDoc->print( aPrinterArgs );
-                }
-                else
-                {
-                    // place error message here ...
-                }
-
-                // remove the document
-                Reference < XComponent > xComp( xDoc, UNO_QUERY );
-                if ( xComp.is() )
-                    xComp->dispose();
-            }
-        }
-
-        // remove this pending request
-        OfficeIPCThread::RequestsCompleted( 1 );
-    }
-    else if ( rAppEvent.GetEvent() == "APPEAR" && !GetCommandLineArgs()->IsInvisible() )
+    if ( rAppEvent.GetEvent() == "APPEAR" && !GetCommandLineArgs()->IsInvisible() )
     {
         // find active task - the active task is always a visible task
         ::com::sun::star::uno::Reference< ::com::sun::star::frame::XFramesSupplier >
Index: desktop/source/app/cmdlineargs.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/cmdlineargs.cxx,v
retrieving revision 1.24
retrieving revision 1.24.60.2
diff -u -p -u -p -r1.24 -r1.24.60.2
--- desktop/source/app/cmdlineargs.cxx	2 Aug 2004 14:39:15 -0000	1.24
+++ desktop/source/app/cmdlineargs.cxx	16 Dec 2004 16:35:18 -0000	1.24.60.2
@@ -68,6 +68,19 @@
 #ifndef _RTL_URI_HXX_
 #include <rtl/uri.hxx>
 #endif
+#include <rtl/ustring.hxx>
+#include <comphelper/processfactory.hxx>
+#include <cppuhelper/bootstrap.hxx>
+#include <com/sun/star/uri/XExternalUriReferenceTranslator.hpp>
+#include <com/sun/star/lang/XMultiServiceFactory.hpp>
+#include <com/sun/star/uno/XCurrentContext.hpp>
+#include <uno/current_context.hxx>
+#include <com/sun/star/uno/Reference.hxx>
+
+using namespace rtl;
+using namespace com::sun::star::lang;
+using namespace com::sun::star::uri;
+using namespace com::sun::star::uno;
 
 namespace desktop
 {
@@ -118,10 +131,29 @@ void CommandLineArgs::ParseCommandLine_I
 	::rtl::OUString	aDummy;
 	String			aArguments;
 
+    Reference<XComponentContext> xComponentContext = ::cppu::defaultBootstrap_InitialComponentContext();    
+	Reference<XMultiServiceFactory> xMS(xComponentContext->getServiceManager(), UNO_QUERY);
+    Reference< XExternalUriReferenceTranslator > xTranslator(
+        xMS->createInstance(
+        OUString::createFromAscii(
+        "com.sun.star.uri.ExternalUriReferenceTranslator")),
+        UNO_QUERY);
+
+
 	// Extract cmdline parameters and concat them to the cmdline string format
 	for( sal_uInt32 i=0; i < nCount; i++ )
 	{
 		aCmdLine.getCommandArg( i, aDummy );
+
+        // convert file URLs to internal form #112849#
+        if (aDummy.indexOf(OUString::createFromAscii("file:"))==0 && 
+            xTranslator.is())
+        {
+            OUString tmp(xTranslator->translateToInternal(aDummy));
+            if (tmp.getLength() > 0)
+                aDummy = tmp;
+        }
+
 		aArguments += String( aDummy );
 		aArguments += '|';
 	}
@@ -346,7 +378,9 @@ sal_Bool CommandLineArgs::InterpretComma
 	}
 	else if ( aArg.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM( "-quickstart" )) == sal_True )
 	{
+#ifdef WNT
 		SetBoolParam_Impl( CMD_BOOLPARAM_QUICKSTART, sal_True );
+#endif
 		return sal_True;
 	}
 	else if ( aArg.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM( "-terminate_after_init" )) == sal_True )
Index: desktop/source/app/cmdlinehelp.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/cmdlinehelp.cxx,v
retrieving revision 1.5
retrieving revision 1.5.60.1
diff -u -p -u -p -r1.5 -r1.5.60.1
--- desktop/source/app/cmdlinehelp.cxx	2 Aug 2004 14:39:38 -0000	1.5
+++ desktop/source/app/cmdlinehelp.cxx	6 Dec 2004 15:07:38 -0000	1.5.60.1
@@ -114,7 +114,7 @@ namespace desktop
 		"keep startup bitmap minimized.\n"\
 		"no startup screen, no default document and no UI.\n"\
 		"suppress restart/restore after fatal errors.\n"\
-		"starts the quickstart service\n"\
+		"starts the quickstart service (only available on windows platform)\n"\
 		"don't show startup screen.\n"\
 		"don't check for remote instances using the installation\n"\
 		"don't start with an empty document\n"\
Index: desktop/source/app/langselect.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/langselect.cxx,v
retrieving revision 1.13
retrieving revision 1.12.14.3
diff -u -p -u -p -r1.13 -r1.12.14.3
--- desktop/source/app/langselect.cxx	27 Jan 2005 12:27:15 -0000	1.13
+++ desktop/source/app/langselect.cxx	7 Feb 2005 14:32:48 -0000	1.12.14.3
@@ -117,6 +117,7 @@ Locale LanguageSelection::IsoStringToLoc
 
 bool LanguageSelection::prepareLanguage()
 {
+    // get the selected UI language as string
     OUString aLocaleString = getLanguageString();
     if ( aLocaleString.getLength() > 0 )
     {
@@ -124,6 +125,9 @@ bool LanguageSelection::prepareLanguage(
         Reference< XMultiServiceFactory > theMSF = comphelper::getProcessServiceFactory();
         try
         {
+            // prepare default config provider by localizing it to the selected locale
+            // this will ensure localized configuration settings to be selected accoring to the
+            // UI language.
             Reference< XLocalizable > theConfigProvider(
                 theMSF->createInstance( sConfigSrvc ),UNO_QUERY_THROW );
             Locale loc = LanguageSelection::IsoStringToLocale(aLocaleString);
@@ -131,8 +135,16 @@ bool LanguageSelection::prepareLanguage(
             Reference< XPropertySet > xProp(getConfigAccess("org.openoffice.Setup/L10N/", sal_True), UNO_QUERY_THROW);
             xProp->setPropertyValue(OUString::createFromAscii("ooLocale"), makeAny(aLocaleString));
             Reference< XChangesBatch >(xProp, UNO_QUERY_THROW)->commitChanges();
+
+            // #i32939# setting of default document locale
+            setDefaultLocale(aLocaleString);
+
             return true;
         }
+        catch ( PropertyVetoException& )
+        {
+            // we are not allowed to change this
+        }
         catch (Exception& e)
         {
             OString aMsg = OUStringToOString(e.Message, RTL_TEXTENCODING_ASCII_US);
@@ -143,6 +155,49 @@ bool LanguageSelection::prepareLanguage(
     return false;
 }
 
+void LanguageSelection::setDefaultLocale(const OUString& usUILocale)
+{
+    // #i32939# setting of default document locale
+    // org.openoffice.Office.Linguistic/General/DefaultLocale
+    // org.openoffice.Office.Linguistic/General/DefaultLocale_CJK
+    // org.openoffice.Office.Linguistic/General/DefaultLocale_CTL
+
+    // determine script type of UI locale
+    LanguageType ltUILocale = ConvertIsoStringToLanguage(usUILocale);
+    sal_uInt16 nScriptType = SvtLanguageOptions::GetScriptTypeOfLanguage(ltUILocale);
+
+    Reference< XPropertySet > xProp(getConfigAccess(
+        "org.openoffice.Office.Linguistic/General/", sal_True), UNO_QUERY_THROW);
+    OUString usName = OUString::createFromAscii("DefaultLocale");
+    switch (nScriptType)
+    {
+        case SCRIPTTYPE_ASIAN:
+            usName = OUString::createFromAscii("DefaultLocale_CJK");
+            break;
+        case SCRIPTTYPE_COMPLEX:
+            usName = OUString::createFromAscii("DefaultLocale_CTL");
+            break;
+    }
+    OUString usValue;
+    xProp->getPropertyValue(usName) >>= usValue;
+    if (usValue.getLength() == 0)
+    {
+        // there is no document language set, for the script type selected
+        // in the UI
+        // covert the LanguageType we've got from the LanguageTable back to
+        // an iso string and store it
+        OUString usDefault = ConvertLanguageToIsoString(ltUILocale);
+        try
+        {
+            xProp->setPropertyValue(usName, makeAny(usDefault));
+            Reference< XChangesBatch >(xProp, UNO_QUERY_THROW)->commitChanges();
+        }
+        catch ( PropertyVetoException )
+        {
+            // we are not allowed to change this
+        }
+    }
+}
 
 OUString LanguageSelection::getLanguageString()
 {
@@ -330,6 +385,10 @@ void LanguageSelection::resetUserLanguag
         xProp->setPropertyValue(OUString::createFromAscii("UILocale"), makeAny(OUString::createFromAscii("")));
         Reference< XChangesBatch >(xProp, UNO_QUERY_THROW)->commitChanges();
     }
+    catch ( PropertyVetoException& )
+    {
+        // we are not allowed to change this
+    }
     catch ( Exception& e)
     {
         OString aMsg = OUStringToOString(e.Message, RTL_TEXTENCODING_ASCII_US);
Index: desktop/source/app/langselect.hxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/langselect.hxx,v
retrieving revision 1.7
retrieving revision 1.7.14.1
diff -u -p -u -p -r1.7 -r1.7.14.1
--- desktop/source/app/langselect.hxx	9 Nov 2004 15:15:28 -0000	1.7
+++ desktop/source/app/langselect.hxx	9 Dec 2004 13:36:56 -0000	1.7.14.1
@@ -72,6 +72,7 @@
 #include <com/sun/star/lang/Locale.hpp>
 #include <com/sun/star/container/XNameAccess.hpp>
 #include <com/sun/star/beans/XPropertySet.hpp>
+#include <svtools/languageoptions.hxx>
 
 namespace desktop
 {
@@ -91,6 +92,7 @@ private:
     static rtl::OUString getUserLanguage();
     static rtl::OUString getSystemLanguage();
     static void resetUserLanguage();
+    static void setDefaultLocale(const rtl::OUString&);
 
 public:
     static com::sun::star::lang::Locale IsoStringToLocale(const rtl::OUString& str);
Index: desktop/source/app/officeipcthread.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/officeipcthread.cxx,v
retrieving revision 1.43
retrieving revision 1.42.60.3
diff -u -p -u -p -r1.43 -r1.42.60.3
--- desktop/source/app/officeipcthread.cxx	21 Jan 2005 17:35:51 -0000	1.43
+++ desktop/source/app/officeipcthread.cxx	7 Feb 2005 14:33:06 -0000	1.42.60.3
@@ -98,6 +98,9 @@
 #ifndef INCLUDED_SVTOOLS_MODULEOPTIONS_HXX
 #include <svtools/moduleoptions.hxx>
 #endif
+#include <comphelper/processfactory.hxx>
+#include <com/sun/star/uri/XExternalUriReferenceTranslator.hpp>
+
 
 using namespace vos;
 using namespace rtl;
@@ -105,6 +108,7 @@ using namespace desktop;
 using namespace ::com::sun::star::uno;
 using namespace ::com::sun::star::lang;
 using namespace ::com::sun::star::frame;
+using namespace ::com::sun::star::uri;
 
 const char  *OfficeIPCThread::sc_aTerminationSequence = "InternalIPC::TerminateThread";
 const int OfficeIPCThread::sc_nTSeqLength = 28;
@@ -407,6 +411,13 @@ OfficeIPCThread::Status OfficeIPCThread:
 		{
             sal_Bool    bPrintTo = sal_False;
             OUString    aPrintToCmd( RTL_CONSTASCII_USTRINGPARAM( "-pt" ));
+
+            Reference< XExternalUriReferenceTranslator > xTranslator(
+                comphelper::getProcessServiceFactory()->createInstance(
+                OUString::createFromAscii(
+                "com.sun.star.uri.ExternalUriReferenceTranslator")),
+                UNO_QUERY);
+
             for( ULONG i=0; i < nCount; i++ )
 			{
 				aInfo.getCommandArg( i, aDummy );
@@ -417,8 +428,19 @@ OfficeIPCThread::Status OfficeIPCThread:
 				if( aDummy.indexOf('-',0) != 0 )
 				{
                     bWaitBeforeClose = sal_True;
-					if ( !bPrintTo )
+                    // convert to an absolut url, but don't touch extrnal file URLs here
+                    if ( !bPrintTo)
+                    {
+                        // convert file URLs to internal form #112849#
+                        if (aDummy.indexOf(OUString::createFromAscii("file:"))==0 && 
+                            xTranslator.is())
+                        {
+                            OUString tmp(xTranslator->translateToInternal(aDummy));
+                            if (tmp.getLength() > 0)
+                                aDummy = tmp;
+                        }
 					    aDummy = GetURL_Impl( aDummy );
+                    }
                     bPrintTo = sal_False;
 				}
                 else
@@ -641,7 +663,12 @@ void SAL_CALL OfficeIPCThread::run()
 				bDocRequestSent |= aCmdLineArgs.GetForceNewList( pRequest->aForceNewList );
 
 				// Special command line args to create an empty document for a given module
-                if ( aCmdLineArgs.HasModuleParam() && Desktop::CheckOEM())
+
+                // #i18338# (lo)
+                // we only do this if no document was specified on the command line,
+                // since this would be inconsistent with the the behaviour of
+                // the first process, see OpenClients() (call to OpenDefault()) in app.cxx                
+                if ( aCmdLineArgs.HasModuleParam() && Desktop::CheckOEM() && (!bDocRequestSent))
 				{
 					SvtModuleOptions aOpt;
 					SvtModuleOptions::EFactory eFactory = SvtModuleOptions::E_WRITER;
Index: desktop/source/app/userinstall.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/app/userinstall.cxx,v
retrieving revision 1.15
retrieving revision 1.14.4.2
diff -u -p -u -p -r1.15 -r1.14.4.2
--- desktop/source/app/userinstall.cxx	26 Nov 2004 23:15:09 -0000	1.15
+++ desktop/source/app/userinstall.cxx	16 Dec 2004 17:19:13 -0000	1.14.4.2
@@ -357,8 +357,12 @@ namespace desktop {
                 theConfigProvider->createInstanceWithArguments(sAccessSrvc, theArgs), UNO_QUERY_THROW);
             hpset->setHierarchicalPropertyValue(OUString::createFromAscii("L10N/ooLocale"), makeAny(aUserLanguage));
             Reference< XChangesBatch >(hpset, UNO_QUERY_THROW)->commitChanges();
-
-        } catch (Exception const & e)
+        }
+        catch ( PropertyVetoException& )
+        {
+            // we are not allowed to change this
+        }
+        catch (Exception const & e)
         {
             OString msg(OUStringToOString(e.Message, RTL_TEXTENCODING_ASCII_US));
             OSL_ENSURE(sal_False, msg.getStr());
@@ -406,6 +410,10 @@ namespace desktop {
             hpset->setHierarchicalPropertyValue(OUString::createFromAscii("Office/ooSetupInstCompleted"), makeAny(sal_True));
             Reference< XChangesBatch >(hpset, UNO_QUERY_THROW)->commitChanges();
         }
+        catch ( PropertyVetoException& )
+        {
+            // we are not allowed to change this
+        }
         catch (Exception& e)
         {
             OString aMsg("create_user_install(): ");
Index: desktop/source/deployment/migration/dp_migration.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/deployment/migration/dp_migration.cxx,v
retrieving revision 1.3
retrieving revision 1.2.14.1
diff -u -p -u -p -r1.3 -r1.2.14.1
--- desktop/source/deployment/migration/dp_migration.cxx	21 Jan 2005 17:11:55 -0000	1.3
+++ desktop/source/deployment/migration/dp_migration.cxx	20 Dec 2004 12:06:34 -0000	1.2.14.1
@@ -110,7 +110,7 @@ class MigrationImpl : public ::cppu::Wea
     };
 
     const Reference<XComponentContext> m_xContext;
-    OUString m_oldUserDir;
+    OUString m_userData;
     
 public:
     virtual ~MigrationImpl();
@@ -138,12 +138,13 @@ MigrationImpl::MigrationImpl(
 {
     for ( sal_Int32 pos = args.getLength(); pos--; )
     {
-        const beans::NamedValue nv( args[pos].get<beans::NamedValue>() );
-        if (nv.Name.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("OldUserDir") ))
-            m_oldUserDir = nv.Value.get<OUString>();
+        const beans::NamedValue nv(
+            extract_throw<beans::NamedValue>( args[pos] ) );
+        if (nv.Name.equalsAsciiL( RTL_CONSTASCII_STRINGPARAM("UserData") ))
+            extract_throw( &m_userData, nv.Value );
     }
-    if (m_oldUserDir.getLength() == 0)
-        throw lang::IllegalArgumentException( OUSTR("missing OldUserDir!"), 0,
+    if (m_userData.getLength() == 0)
+        throw lang::IllegalArgumentException( OUSTR("missing UserData!"), 0,
                                               static_cast<sal_Int16>(-1) );
 }
 
@@ -175,7 +176,7 @@ Any MigrationImpl::execute( Sequence<bea
             m_xContext )->getPackageManager( OUSTR("user") ) );
     ::ucb::Content packagesDir;
     if (create_ucb_content( &packagesDir,
-                            makeURL( m_oldUserDir, OUSTR("user/uno_packages") ),
+                            makeURL( m_userData, OUSTR("user/uno_packages") ),
                             Reference<XCommandEnvironment>(),
                             false /* no throw */ ))
     {
Index: desktop/source/migration/makefile.mk
===================================================================
RCS file: /cvs/framework/desktop/source/migration/makefile.mk,v
retrieving revision 1.2
retrieving revision 1.2.4.1
diff -u -p -u -p -r1.2 -r1.2.4.1
--- desktop/source/migration/makefile.mk	15 Nov 2004 15:47:55 -0000	1.2
+++ desktop/source/migration/makefile.mk	13 Dec 2004 09:30:46 -0000	1.2.4.1
@@ -75,11 +75,11 @@ RSCUPDVER=$(RSCREVISION)(SV$(UPD)$(UPDMI
 
 # --- Files --------------------------------------------------------
 
-OBJFILES = \
-        $(OBJ)$/migration.obj \
-        $(OBJ)$/wizard.obj    \
-        $(OBJ)$/pages.obj     \
-        $(OBJ)$/cfgfilter.obj
+SLOFILES = \
+        $(SLO)$/migration.obj \
+        $(SLO)$/wizard.obj    \
+        $(SLO)$/pages.obj     \
+        $(SLO)$/cfgfilter.obj
         
 SRS1NAME=	wizard
 SRC1FILES=	wizard.src	        
Index: desktop/source/migration/migration.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/migration/migration.cxx,v
retrieving revision 1.2
retrieving revision 1.2.4.1
diff -u -p -u -p -r1.2 -r1.2.4.1
--- desktop/source/migration/migration.cxx	15 Nov 2004 15:48:08 -0000	1.2
+++ desktop/source/migration/migration.cxx	13 Dec 2004 09:30:46 -0000	1.2.4.1
@@ -141,11 +141,7 @@ void Migration::cancelMigration()
 
 sal_Bool Migration::checkMigration()
 {
-#ifdef PRODUCT
-    return sal_False;
-#else
     return getImpl()->checkMigration();
-#endif
 }
 
 OUString Migration::getOldVersionName()
Index: desktop/source/migration/pages.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/migration/pages.cxx,v
retrieving revision 1.2
retrieving revision 1.2.4.6
diff -u -p -u -p -r1.2 -r1.2.4.6
--- desktop/source/migration/pages.cxx	15 Nov 2004 15:49:08 -0000	1.2
+++ desktop/source/migration/pages.cxx	14 Jan 2005 11:49:31 -0000	1.2.4.6
@@ -63,8 +63,8 @@
 #include "wizard.hrc"
 #include "wizard.hxx"
 #include "migration.hxx"
-#include "../app/desktopresid.hxx"
 #include <vcl/msgbox.hxx>
+#include <vcl/mnemonic.hxx>
 #include <app.hxx>
 #include <rtl/ustring.hxx>
 #include <osl/file.hxx>
@@ -98,8 +98,9 @@ static void _setBold(FixedText& ft)
 
 WelcomePage::WelcomePage( svt::OWizardMachine* parent, const ResId& resid)
     : OWizardPage(parent, resid)
-    , m_ftHead(this, DesktopResId(FT_WELCOME_HEADER))
-    , m_ftBody(this, DesktopResId(FT_WELCOME_BODY))
+    , m_ftHead(this, WizardResId(FT_WELCOME_HEADER))
+    , m_ftBody(this, WizardResId(FT_WELCOME_BODY))
+    , m_pParent(parent)
 {
     FreeResource();
 
@@ -114,17 +115,17 @@ WelcomePage::WelcomePage( svt::OWizardMa
         // check for migration
         if (Migration::checkMigration())
         {
-            String aText(DesktopResId(STR_WELCOME_MIGRATION));
+            String aText(WizardResId(STR_WELCOME_MIGRATION));
             // replace %OLDPRODUCT with found version name
             aText.SearchAndReplaceAll( UniString::CreateFromAscii("%OLD_VERSION"), Migration::getOldVersionName());
             m_ftBody.SetText( aText );
         }
         break;
     case OEM_NORMAL:
-        m_ftBody.SetText(String(DesktopResId(STR_WELCOME_OEM)));
+        m_ftBody.SetText(String(WizardResId(STR_WELCOME_OEM)));
         break;
     case OEM_EXTENDED:
-        m_ftBody.SetText(String(DesktopResId(STR_WELCOME_OEM_EXT)));
+        m_ftBody.SetText(String(WizardResId(STR_WELCOME_OEM_EXT)));
         break;
     }
 
@@ -136,17 +137,23 @@ WelcomePage::OEMType WelcomePage::checkO
 }
 
 
-
+void WelcomePage::ActivatePage()
+{
+    OWizardPage::ActivatePage();
+    // this page has no controls, so forwarding to default
+    // button (next) won't work if we grap focus
+    // GrabFocus();
+}
 
 LicensePage::LicensePage( svt::OWizardMachine* parent, const ResId& resid)
     : OWizardPage(parent, resid)
-    , m_ftHead(this, DesktopResId(FT_LICENSE_HEADER))
-    , m_ftBody1(this, DesktopResId(FT_LICENSE_BODY_1))
-    , m_ftBody1Txt(this, DesktopResId(FT_LICENSE_BODY_1_TXT))
-    , m_ftBody2(this, DesktopResId(FT_LICENSE_BODY_2))
-    , m_ftBody2Txt(this, DesktopResId(FT_LICENSE_BODY_2_TXT))
-    , m_mlLicense(this, DesktopResId(ML_LICENSE))
-    , m_pbDown(this, DesktopResId(PB_LICENSE_DOWN))
+    , m_pbDown(this, WizardResId(PB_LICENSE_DOWN))
+    , m_ftHead(this, WizardResId(FT_LICENSE_HEADER))
+    , m_ftBody1(this, WizardResId(FT_LICENSE_BODY_1))
+    , m_ftBody1Txt(this, WizardResId(FT_LICENSE_BODY_1_TXT))
+    , m_ftBody2(this, WizardResId(FT_LICENSE_BODY_2))
+    , m_ftBody2Txt(this, WizardResId(FT_LICENSE_BODY_2_TXT))
+    , m_mlLicense(this, WizardResId(ML_LICENSE))    
     , m_bLicenseRead(sal_False)
     , m_pParent(parent)
 {
@@ -165,7 +172,9 @@ LicensePage::LicensePage( svt::OWizardMa
 
     // replace %PAGEDOWN in text2 with button text
     String aText = m_ftBody1Txt.GetText();
-    aText.SearchAndReplaceAll( UniString::CreateFromAscii("%PAGEDOWN"), m_pbDown.GetText());
+    aText.SearchAndReplaceAll( UniString::CreateFromAscii("%PAGEDOWN"), 
+        MnemonicGenerator::EraseAllMnemonicChars(m_pbDown.GetText()));
+
     m_ftBody1Txt.SetText( aText );
 
     OUString aLicensePath = FirstStartWizard::getLicensePath();
@@ -190,12 +199,26 @@ LicensePage::LicensePage( svt::OWizardMa
         OUString aLicenseString(pBuffer, nBytes, RTL_TEXTENCODING_UTF8, 
                 OSTRING_TO_OUSTRING_CVTFLAGS | RTL_TEXTTOUNICODE_FLAGS_GLOBAL_SIGNATURE);
         delete[] pBuffer;    
-        m_mlLicense.SetText(aLicenseString);    
+        m_mlLicense.SetText(aLicenseString);           
+        
     }
 }
 
+void LicensePage::ActivatePage()
+{
+    OWizardPage::ActivatePage();    
+    m_bLicenseRead = m_mlLicense.IsEndReached();
+    m_pbDown.GrabFocus();
+    implCheckNextButton();
+}
+
 sal_Bool LicensePage::determineNextButtonState()
 {
+    if (m_mlLicense.IsEndReached())
+        m_pbDown.Disable();
+    else
+        m_pbDown.Enable();
+
     return m_bLicenseRead;
 }
 
@@ -291,9 +314,9 @@ void LicenseView::Notify( SfxBroadcaster
 
 MigrationPage::MigrationPage( svt::OWizardMachine* parent, const ResId& resid)
     : OWizardPage(parent, resid)
-    , m_ftHead(this, DesktopResId(FT_MIGRATION_HEADER))
-    , m_ftBody(this, DesktopResId(FT_MIGRATION_BODY))
-    , m_cbMigration(this, DesktopResId(CB_MIGRATION))
+    , m_ftHead(this, WizardResId(FT_MIGRATION_HEADER))
+    , m_ftBody(this, WizardResId(FT_MIGRATION_BODY))
+    , m_cbMigration(this, WizardResId(CB_MIGRATION))
     , m_bMigrationDone(sal_False)
 { 
     FreeResource();
@@ -317,18 +340,25 @@ sal_Bool MigrationPage::commitPage(COMMI
     return sal_True;
 }
 
+void MigrationPage::ActivatePage()
+{
+    OWizardPage::ActivatePage();
+    GrabFocus();
+}
+
+
 UserPage::UserPage( svt::OWizardMachine* parent, const ResId& resid)
 	: OWizardPage(parent, resid)
-	, m_ftHead(this, DesktopResId(FT_USER_HEADER))
-    , m_ftBody(this, DesktopResId(FT_USER_BODY))
-    , m_ftFirst(this, DesktopResId(FT_USER_FIRST))
-	, m_ftLast(this, DesktopResId(FT_USER_LAST))
-	, m_ftInitials(this, DesktopResId(FT_USER_INITIALS))
-	, m_ftFather(this, DesktopResId(FT_USER_FATHER))
-    , m_edFirst(this, DesktopResId(ED_USER_FIRST))
-	, m_edLast(this, DesktopResId(ED_USER_LAST))
-	, m_edInitials(this, DesktopResId(ED_USER_INITIALS))
-	, m_edFather(this, DesktopResId(ED_USER_FATHER))
+	, m_ftHead(this, WizardResId(FT_USER_HEADER))
+    , m_ftBody(this, WizardResId(FT_USER_BODY))
+    , m_ftFirst(this, WizardResId(FT_USER_FIRST))
+    , m_edFirst(this, WizardResId(ED_USER_FIRST))
+	, m_ftLast(this, WizardResId(FT_USER_LAST))
+	, m_edLast(this, WizardResId(ED_USER_LAST))
+    , m_ftInitials(this, WizardResId(FT_USER_INITIALS))
+	, m_edInitials(this, WizardResId(ED_USER_INITIALS))
+    , m_ftFather(this, WizardResId(FT_USER_FATHER))
+	, m_edFather(this, WizardResId(ED_USER_FATHER))
     , m_lang(Application::GetSettings().GetUILanguage())
 {
     FreeResource();
@@ -360,18 +390,23 @@ sal_Bool UserPage::commitPage(COMMIT_REA
     return sal_True;
 }
 
+void UserPage::ActivatePage()
+{
+    OWizardPage::ActivatePage();
+    GrabFocus();
+}
 
 RegistrationPage::RegistrationPage( svt::OWizardMachine* parent, const ResId& resid)
     : OWizardPage(parent, resid)
-    , m_ftHeader(this, DesktopResId(FT_REGISTRATION_HEADER))
-    , m_fiImage(this, DesktopResId(IMG_REGISTRATION))
-    , m_ftBody(this, DesktopResId(FT_REGISTRATION_BODY))
-    , m_rbNow(this, DesktopResId(RB_REGISTRATION_NOW))
-    , m_rbLater(this, DesktopResId(RB_REGISTRATION_LATER))
-    , m_rbNever(this, DesktopResId(RB_REGISTRATION_NEVER))
-    , m_rbReg(this, DesktopResId(RB_REGISTRATION_REG))
-    , m_flSeparator(this, DesktopResId(FL_REGISTRATION))
-    , m_ftEnd(this, DesktopResId(FT_REGISTRATION_END))
+    , m_ftHeader(this, WizardResId(FT_REGISTRATION_HEADER))
+    , m_fiImage(this, WizardResId(IMG_REGISTRATION))
+    , m_ftBody(this, WizardResId(FT_REGISTRATION_BODY))
+    , m_rbNow(this, WizardResId(RB_REGISTRATION_NOW))
+    , m_rbLater(this, WizardResId(RB_REGISTRATION_LATER))
+    , m_rbNever(this, WizardResId(RB_REGISTRATION_NEVER))
+    , m_rbReg(this, WizardResId(RB_REGISTRATION_REG))
+    , m_flSeparator(this, WizardResId(FL_REGISTRATION))
+    , m_ftEnd(this, WizardResId(FT_REGISTRATION_END))
 {
     FreeResource();
     _setBold(m_ftHeader);
@@ -382,6 +417,12 @@ sal_Bool RegistrationPage::determineNext
     return sal_False;
 }
 
+void RegistrationPage::ActivatePage()
+{
+    OWizardPage::ActivatePage();
+    GrabFocus();
+}
+
 sal_Bool RegistrationPage::commitPage(COMMIT_REASON _eReason)
 {
     if ( _eReason == eFinish )
@@ -413,7 +454,7 @@ sal_Bool RegistrationPage::commitPage(CO
 	        }
 	        if ( !bSuccess )
 	        {
-		        ErrorBox aRegistrationError( this, DesktopResId( ERRBOX_REG_NOSYSBROWSER ) );
+		        ErrorBox aRegistrationError( this, WizardResId( ERRBOX_REG_NOSYSBROWSER ) );
 		        aRegistrationError.Execute();
 	        }
         }
Index: desktop/source/migration/pages.hxx
===================================================================
RCS file: /cvs/framework/desktop/source/migration/pages.hxx,v
retrieving revision 1.2
retrieving revision 1.2.4.3
diff -u -p -u -p -r1.2 -r1.2.4.3
--- desktop/source/migration/pages.hxx	15 Nov 2004 15:49:20 -0000	1.2
+++ desktop/source/migration/pages.hxx	25 Jan 2005 15:46:26 -0000	1.2.4.3
@@ -79,6 +79,7 @@ class WelcomePage : public svt::OWizardP
 private:
     FixedText m_ftHead;
     FixedText m_ftBody;
+    svt::OWizardMachine *m_pParent;
     enum OEMType
     {
         OEM_NONE, OEM_NORMAL, OEM_EXTENDED
@@ -87,6 +88,8 @@ private:
 
 public:
     WelcomePage( svt::OWizardMachine* parent, const ResId& resid);
+protected:
+    virtual void ActivatePage();
 };
 
 class LicenseView : public MultiLineEdit, public SfxListener
@@ -134,6 +137,7 @@ private:
     DECL_LINK(ScrolledHdl, LicenseView*);
 protected:
     virtual sal_Bool determineNextButtonState();
+    virtual void ActivatePage();
 };
 
 class MigrationPage : public svt::OWizardPage
@@ -147,6 +151,8 @@ public:
     MigrationPage( svt::OWizardMachine* parent, const ResId& resid);
     virtual sal_Bool commitPage(COMMIT_REASON _eReason);
 
+protected:
+    virtual void ActivatePage();
 };
 
 class UserPage : public svt::OWizardPage
@@ -155,18 +161,20 @@ private:
     FixedText m_ftHead;
     FixedText m_ftBody;
     FixedText m_ftFirst;
-	FixedText m_ftLast;
-	FixedText m_ftInitials;
-	FixedText m_ftFather;
     Edit m_edFirst;
+	FixedText m_ftLast;
 	Edit m_edLast;
+	FixedText m_ftInitials;
 	Edit m_edInitials;
+	FixedText m_ftFather;
 	Edit m_edFather;
     LanguageType m_lang;
 
 public:
     UserPage( svt::OWizardMachine* parent, const ResId& resid);
     virtual sal_Bool commitPage(COMMIT_REASON _eReason);
+protected:
+    virtual void ActivatePage();
 };
 
 
@@ -187,6 +195,7 @@ public:
     virtual sal_Bool commitPage(COMMIT_REASON _eReason);
 protected:
     virtual sal_Bool determineNextButtonState();
+    virtual void ActivatePage();
 };
 
 }
Index: desktop/source/migration/wizard.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/migration/wizard.cxx,v
retrieving revision 1.2
retrieving revision 1.2.4.4
diff -u -p -u -p -r1.2 -r1.2.4.4
--- desktop/source/migration/wizard.cxx	15 Nov 2004 15:49:35 -0000	1.2
+++ desktop/source/migration/wizard.cxx	14 Jan 2005 11:49:31 -0000	1.2.4.4
@@ -63,7 +63,6 @@
 #include "wizard.hxx"
 #include "wizard.hrc"
 #include "pages.hxx"
-#include "../app/desktopresid.hxx"
 #include "app.hxx"
 
 #include <rtl/ustring.hxx>
@@ -108,15 +107,32 @@ const FirstStartWizard::WizardState Firs
 const FirstStartWizard::WizardState FirstStartWizard::STATE_USER = 3;
 const FirstStartWizard::WizardState FirstStartWizard::STATE_REGISTRATION = 4;
 
-// WZB_NEXT|WZB_PREVIOUS|WZB_FINISH|WZB_CANCEL|WZB_HELP
+WizardResId::WizardResId( USHORT nId ) :
+	ResId( nId, FirstStartWizard::GetResManager() )
+{
+}
+
+ResMgr *FirstStartWizard::pResMgr = 0;
+
+ResMgr *FirstStartWizard::GetResManager()
+{
+    if ( !FirstStartWizard::pResMgr )
+    {
+        String aMgrName = String::CreateFromAscii( "dkt" );
+        aMgrName += String::CreateFromInt32(SUPD); // current version number
+        FirstStartWizard::pResMgr = ResMgr::CreateResMgr( OUStringToOString( aMgrName, RTL_TEXTENCODING_UTF8 ));
+    }
+    return FirstStartWizard::pResMgr;
+}
 
 FirstStartWizard::FirstStartWizard(Window* pParent)
-    :RoadmapWizard( pParent, DesktopResId(DLG_FIRSTSTART_WIZARD),
-        WZB_NEXT|WZB_PREVIOUS|WZB_FINISH|WZB_CANCEL|WZB_HELP, DesktopResId(STR_FIRSTSTART_TITLE))
+    :RoadmapWizard( pParent, WizardResId(DLG_FIRSTSTART_WIZARD),
+        WZB_NEXT|WZB_PREVIOUS|WZB_FINISH|WZB_CANCEL|WZB_HELP, WizardResId(STR_FIRSTSTART_TITLE))
     ,m_aDefaultPath(0)
 	,m_aMigrationPath(0)
     ,m_bDone(sal_False)
     ,m_bAccepted(sal_False)
+    ,m_bOverride(sal_False)
 {
     // ---
     // FreeResource();
@@ -177,9 +193,10 @@ FirstStartWizard::FirstStartWizard(Windo
     ActivatePage();
 
     // set text of finish putton:
-    m_pFinish->SetText(String(DesktopResId(STR_FINISH)));
+    m_pFinish->SetText(String(WizardResId(STR_FINISH)));
     // disable "finish button"
     enableButtons(WZB_FINISH, sal_False);
+    defaultButton(WZB_NEXT);
 
 }
 
@@ -196,6 +213,9 @@ void FirstStartWizard::enterState(Wizard
     m_pCancel->SetClickHdl(m_lnkCancel);
     m_pNextPage->SetText(m_sNext);
 
+    // default
+    defaultButton(WZB_NEXT);
+
     // specialized state
     switch (_nState)
     {     
@@ -203,8 +223,8 @@ void FirstStartWizard::enterState(Wizard
         enableButtons(WZB_PREVIOUS, sal_False);
         break;
     case STATE_LICENSE:
-        m_pCancel->SetText(String(DesktopResId(STR_LICENSE_DECLINE)));
-        m_pNextPage->SetText(String(DesktopResId(STR_LICENSE_ACCEPT)));
+        m_pCancel->SetText(String(WizardResId(STR_LICENSE_DECLINE)));
+        m_pNextPage->SetText(String(WizardResId(STR_LICENSE_ACCEPT)));
         enableButtons(WZB_NEXT, sal_False);
         // attach warning dialog to cancel/decline button        
         m_pCancel->SetClickHdl( LINK(this, FirstStartWizard, DeclineHdl) );
@@ -212,14 +232,17 @@ void FirstStartWizard::enterState(Wizard
     case STATE_REGISTRATION:
         enableButtons(WZB_NEXT, sal_False); 
         enableButtons(WZB_FINISH, sal_True);
+        defaultButton(WZB_FINISH);
         break;
     }
+
+    // focus
         
 }
 
 IMPL_LINK( FirstStartWizard, DeclineHdl, PushButton *, arg )
 {
-    QueryBox aBox(this, DesktopResId(QB_ASK_DECLINE));
+    QueryBox aBox(this, WizardResId(QB_ASK_DECLINE));
     sal_Int32 ret = aBox.Execute();
     if ( ret == BUTTON_OK || ret == BUTTON_YES)
     {
@@ -237,19 +260,19 @@ TabPage* FirstStartWizard::createPage(Wi
     switch (_nState)
     {
     case STATE_WELCOME:
-        pTabPage = new WelcomePage(this, DesktopResId(TP_WELCOME));
+        pTabPage = new WelcomePage(this, WizardResId(TP_WELCOME));
         break;
     case STATE_LICENSE:
-        pTabPage = new LicensePage(this, DesktopResId(TP_LICENSE));
+        pTabPage = new LicensePage(this, WizardResId(TP_LICENSE));
         break;
     case STATE_MIGRATION:
-        pTabPage = new MigrationPage(this, DesktopResId(TP_MIGRATION));
+        pTabPage = new MigrationPage(this, WizardResId(TP_MIGRATION));
         break;
     case STATE_USER:
-        pTabPage = new UserPage(this, DesktopResId(TP_USER));
+        pTabPage = new UserPage(this, WizardResId(TP_USER));
         break;
     case STATE_REGISTRATION:
-        pTabPage = new RegistrationPage(this, DesktopResId(TP_REGISTRATION));
+        pTabPage = new RegistrationPage(this, WizardResId(TP_REGISTRATION));
         break;
     }
     pTabPage->Show();
@@ -263,19 +286,19 @@ String FirstStartWizard::getStateDisplay
     switch(_nState)
     {
     case STATE_WELCOME:
-        sName = String(DesktopResId(STR_STATE_WELCOME));
+        sName = String(WizardResId(STR_STATE_WELCOME));
         break;
     case STATE_LICENSE:
-        sName = String(DesktopResId(STR_STATE_LICENSE));
+        sName = String(WizardResId(STR_STATE_LICENSE));
         break;
     case STATE_MIGRATION:
-        sName = String(DesktopResId(STR_STATE_MIGRATION));
+        sName = String(WizardResId(STR_STATE_MIGRATION));
         break;
     case STATE_USER:
-        sName = String(DesktopResId(STR_STATE_USER));
+        sName = String(WizardResId(STR_STATE_USER));
         break;
     case STATE_REGISTRATION:
-        sName = String(DesktopResId(STR_STATE_REGISTRATION));
+        sName = String(WizardResId(STR_STATE_REGISTRATION));
         break;
     }
     return sName;
@@ -316,12 +339,14 @@ sal_Bool FirstStartWizard::onFinish(sal_
         return sal_False;
 }
 
+void FirstStartWizard::overrideCheck(sal_Bool bOverride)
+{
+    m_bOverride = bOverride;
+}
+
 short FirstStartWizard::Execute()
 {
-    if (isFirstStart() || !isLicenseAccepted())    
-        return svt::RoadmapWizard::Execute();
-    else
-        return sal_True;
+    return svt::RoadmapWizard::Execute();
 }
 
 
Index: desktop/source/migration/wizard.hxx
===================================================================
RCS file: /cvs/framework/desktop/source/migration/wizard.hxx,v
retrieving revision 1.2
retrieving revision 1.2.4.2
diff -u -p -u -p -r1.2 -r1.2.4.2
--- desktop/source/migration/wizard.hxx	15 Nov 2004 15:50:03 -0000	1.2
+++ desktop/source/migration/wizard.hxx	14 Jan 2005 11:49:32 -0000	1.2.4.2
@@ -69,6 +69,13 @@
 
 namespace desktop
 {
+
+class WizardResId : public ResId
+{
+public:
+    WizardResId( USHORT nId );
+};
+
 class FirstStartWizard : public svt::RoadmapWizard
 {
 
@@ -79,13 +86,19 @@ public:
 	static const WizardState STATE_USER;
     static const WizardState STATE_REGISTRATION;
 
+    static ResMgr* pResMgr;
+    static ResMgr* GetResManager();
+
     FirstStartWizard(Window* pParent);
 
     virtual short Execute();
 
     static rtl::OUString getLicensePath();
 
+    void overrideCheck(sal_Bool bOverride);
+
 private:
+    sal_Bool m_bOverride;
     WizardState _currentState;
     PathId m_aDefaultPath;
 	PathId m_aMigrationPath;
@@ -98,11 +111,13 @@ private:
     void storeAcceptDate();
     void disableWizard();
     void enableQuickstart();
-    sal_Bool isFirstStart();
-    sal_Bool isLicenseAccepted();
 
     DECL_LINK(DeclineHdl, PushButton*);
 
+public:
+    static sal_Bool isFirstStart();
+    static sal_Bool isLicenseAccepted();
+
 protected:
     // from svt::WizardMachine
     virtual TabPage* createPage(WizardState _nState);
Index: desktop/source/migration/wizard.src
===================================================================
RCS file: /cvs/framework/desktop/source/migration/wizard.src,v
retrieving revision 1.2
retrieving revision 1.2.4.6
diff -u -p -u -p -r1.2 -r1.2.4.6
--- desktop/source/migration/wizard.src	15 Nov 2004 15:50:22 -0000	1.2
+++ desktop/source/migration/wizard.src	25 Jan 2005 15:46:26 -0000	1.2.4.6
@@ -174,6 +174,7 @@ TabPage TP_WELCOME
     // bold fixedtext for header
     FixedText FT_WELCOME_HEADER
     {
+        NoLabel = TRUE;
         Pos = MAP_APPFONT(MARGINRIGHT, MARGINTOP);
         Size = MAP_APPFONT( BODYWIDTH, ROWHEIGHT );
         Text [ de ]    = "Willkommen zu %PRODUCTNAME %PRODUCTVERSION";
@@ -181,6 +182,7 @@ TabPage TP_WELCOME
     };    
     FixedText FT_WELCOME_BODY
     {
+        NoLabel = TRUE;
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP + 2*ROWHEIGHT);
         Size = MAP_APPFONT( BODYWIDTH, BODYHEIGHT-MARGINTOP - 2*ROWHEIGHT );    
         WordBreak = TRUE;
@@ -199,13 +201,15 @@ TabPage TP_LICENSE
     {
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP);
         Size = MAP_APPFONT( BODYWIDTH, ROWHEIGHT );
+        NoLabel = TRUE;
         Text [ en-US ] = "Please follow these steps to accept the license";
-        Text [ de ]    = "Bitte folgen Sie diesen Schritten, um die Lizenz zu akzeptieren.";
+        Text [ de ]    = "Bitte folgen Sie diesen Schritten, um die Lizenz zu akzeptieren";
     };    
     FixedText FT_LICENSE_BODY_1
     {
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP + 2*ROWHEIGHT);
         Size = MAP_APPFONT( INDENT, ROWHEIGHT );
+        NoLabel = TRUE;
         Text [ en-US ] = "1.";
         Text [ de ]    = "1.";
     };    
@@ -214,13 +218,15 @@ TabPage TP_LICENSE
         Pos = MAP_APPFONT(MARGINLEFT+INDENT, MARGINTOP +2*ROWHEIGHT);
         Size = MAP_APPFONT( BODYWIDTH-INDENT, 3*ROWHEIGHT);
         WordBreak = TRUE;
+        NoLabel = TRUE;
         Text [ en-US ] = "View the complete License Agreement. Please use the scrollbar or the '%PAGEDOWN' button in this dialog to view the entire license text.";
-        Text [ de ]    = "Lesen Sie den gesamten Lizenzvertrag. Verwenden Sie die Bildlaufleiste oder die %PAGEDOWN Schaltflche in diesem Dialog um den gesamten Text sichtbar zu machen.";
+        Text [ de ]    = "Lesen Sie den gesamten Lizenzvertrag. Verwenden Sie die Bildlaufleiste oder die '%PAGEDOWN' Schaltflche in diesem Dialog, um den gesamten Text sichtbar zu machen.";
     };    
     FixedText FT_LICENSE_BODY_2
     {
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP + 5*ROWHEIGHT);
         Size = MAP_APPFONT(INDENT, ROWHEIGHT );
+        NoLabel = TRUE;
         Text [ en-US ] = "2.";
         Text [ de ]    = "2.";
     };    
@@ -229,8 +235,9 @@ TabPage TP_LICENSE
         Pos = MAP_APPFONT(MARGINLEFT+INDENT, MARGINTOP + 5*ROWHEIGHT);
         Size = MAP_APPFONT( BODYWIDTH-INDENT, 2*ROWHEIGHT);
         WordBreak = TRUE;
-        Text [ en-US ] = "Click 'Accept' to accept the terms of the Agreement. ";
-        Text [ de ]    = "Klicken Sie auf 'Akzeptieren' um die Bedingungen des Vertrages zu akzeptieren";
+        NoLabel = TRUE;
+        Text [ en-US ] = "Click 'Accept' to accept the terms of the Agreement.";
+        Text [ de ]    = "Klicken Sie auf 'Akzeptieren', um die Bedingungen des Vertrages zu akzeptieren.";
     };    
 	MultiLineEdit ML_LICENSE
 	{
@@ -245,7 +252,7 @@ TabPage TP_LICENSE
 		Pos = MAP_APPFONT ( TP_WIDTH-MARGINRIGHT-50 , TP_HEIGHT-MARGINBOTTOM-15 ) ;
 		Size = MAP_APPFONT ( 50, 15 ) ;
 		Text [ de ] = "Bltt~ern";
-		Text [ en-US ] = "Scroll ~Down";
+		Text [ en-US ] = "Scroll Do~wn";
 	};        
 };
 
@@ -270,6 +277,7 @@ TabPage TP_MIGRATION
 
     FixedText FT_MIGRATION_HEADER
     {
+        NoLabel = TRUE;
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP);    
         Size = MAP_APPFONT( BODYWIDTH, ROWHEIGHT );
         Text [ en-US ] = "Transfer personal data";
@@ -279,11 +287,12 @@ TabPage TP_MIGRATION
 
     FixedText FT_MIGRATION_BODY
     {
+        NoLabel = TRUE;
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP+ROWHEIGHT*2);    
         Size = MAP_APPFONT(BODYWIDTH, ROWHEIGHT*8);
         WordBreak = TRUE;
         Text [ en-US ] = "Personal data from %OLDPRODUCT installation can be used in %PRODUCTNAME %PRODUCTVERSION.\n\nUnmark the check box below if you do not want data such as templates, dictionaries and Gallery themes to be copied to %PRODUCTNAME %PRODUCTVERSION. To migrate all your personal data from the previous version of  %PRODUCTNAME, follow the guidelines in the Readme file.";
-        Text [ de ]    = "Sie knnen persnliche Daten aus %OLDPRODUCT nach %PRODUCTNAME %PRODUCTVERSION kopieren.\n\nDeaktivieren Sie das  Markierfeld weiter unten, um Benutzerdaten wie Dokumentvorlagen, Wrterbcher und Gallery-Themen nicht nach %PRODUCTNAME %PRODUCTVERSION zu bernhmen. Zur vollstndigen Migration Ihrer Daten beachten Sie bitte auch weitere Hinweise in der Readme-Datei.";
+        Text [ de ]    = "Sie knnen persnliche Daten aus %OLDPRODUCT nach %PRODUCTNAME %PRODUCTVERSION kopieren.\n\nDeaktivieren Sie das  Markierfeld weiter unten, um Benutzerdaten wie Dokumentvorlagen, Wrterbcher und Gallery-Themen nicht nach %PRODUCTNAME %PRODUCTVERSION zu bernehmen. Zur vollstndigen Migration Ihrer Daten beachten Sie bitte auch weitere Hinweise in der Readme-Datei.";
     };
     
     CheckBox CB_MIGRATION
@@ -310,15 +319,17 @@ TabPage TP_USER
 
     FixedText FT_USER_HEADER
     {
+        NoLabel = TRUE;
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP);    
         Size = MAP_APPFONT( BODYWIDTH, ROWHEIGHT );
         Text [ en-US ] = "Provide your full name and initials below";
-        Text [ de ]    = "Bitte geben Sie ihren Vor- und Nachnamen sowie Ihre Krzel an.";
+        Text [ de ]    = "Bitte geben Sie ihren Vor- und Nachnamen sowie Ihr Krzel an";
         
     };
 
     FixedText FT_USER_BODY
     {
+        NoLabel = TRUE;
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP+ROWHEIGHT*2);    
         Size = MAP_APPFONT(BODYWIDTH, ROWHEIGHT*3);
         WordBreak = TRUE;
@@ -326,12 +337,13 @@ TabPage TP_USER
         Text [ de ]    = "Der Benutzername wird in den Dokumenteigenschaften sowie Dokumentvorlagen verwendet und wenn Sie nderungen an Dokumenten aufzeichnen.";        
     };
     
+    
     FixedText FT_USER_FIRST
     {
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP+ROWHEIGHT*7+FTADD);
         Size = MAP_APPFONT(USERINDENT, ROWHEIGHT);
-        Text [ en-US ] = "First name";
-        Text [ de ]    = "Vorname";        
+        Text [ en-US ] = "~First name";
+        Text [ de ]    = "~Vorname";        
     };
     Edit ED_USER_FIRST
     {
@@ -339,13 +351,12 @@ TabPage TP_USER
         Pos = MAP_APPFONT(MARGINLEFT+USERINDENT, MARGINTOP+ROWHEIGHT*7);
         Size = MAP_APPFONT(BODYWIDTH-USERINDENT, EDHEIGHT);
     };
-
     FixedText FT_USER_LAST
     {
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP+ROWHEIGHT*9+FTADD);
         Size = MAP_APPFONT(USERINDENT, ROWHEIGHT);
-        Text [ en-US ] = "Last name";
-        Text [ de ]    = "Nachname";        
+        Text [ en-US ] = "~Last name";
+        Text [ de ]    = "~Nachname";        
     };
     Edit ED_USER_LAST
     {
@@ -353,13 +364,12 @@ TabPage TP_USER
         Pos = MAP_APPFONT(MARGINLEFT+USERINDENT, MARGINTOP+ROWHEIGHT*9);
         Size = MAP_APPFONT(BODYWIDTH-USERINDENT, EDHEIGHT);
     };
-    
     FixedText FT_USER_INITIALS
     {
         Pos = MAP_APPFONT(MARGINLEFT, MARGINTOP+ROWHEIGHT*11+FTADD);
         Size = MAP_APPFONT(USERINDENT, ROWHEIGHT);
-        Text [ en-US ] = "Initials";
-        Text [ de ]    = "Krzel";        
+        Text [ en-US ] = "~Initials";
+        Text [ de ]    = "~Krzel";        
     };
     Edit ED_USER_INITIALS
     {
@@ -373,8 +383,8 @@ TabPage TP_USER
         Hide = TRUE;
         Pos = MAP_APPFONT(MARGINLEFT+USERINDENT+INITIALSWIDTH+10, MARGINTOP+ROWHEIGHT*11+FTADD);
         Size = MAP_APPFONT(USERINDENT, ROWHEIGHT);
-        Text [ en-US ] = "Father's name";
-        Text [ de ]    = "Vatername";        
+        Text [ en-US ] = "~Father's name";
+        Text [ de ]    = "~Vatername";        
     };
     Edit ED_USER_FATHER
     {
@@ -393,6 +403,7 @@ TabPage TP_REGISTRATION
     HelpID          = HID_FIRSTSTART_REGISTRATION;
     FixedText FT_REGISTRATION_HEADER
     {
+        NoLabel = TRUE;
         Text [ en-US ] = "%PRODUCTNAME Registration";
         Text [ de ]    = "%PRODUCTNAME Registrierung";
         Pos = MAP_APPFONT(MARGINLEFT, MARGINRIGHT);
@@ -414,17 +425,18 @@ TabPage TP_REGISTRATION
     };    
     FixedText FT_REGISTRATION_BODY
     {
+        NoLabel = TRUE;
         Text [ en-US ] = "You now have the opportunity to register as a %PRODUCTNAME user. Registration is voluntary and is without obligation.\n\nIf you register, we can inform you about new developments concerning this product.";
         Text [ de ]    = "Sie haben jetzt die Mglichkeit, sich als %PRODUCTNAME Anwender registrieren zu lassen.  Die Registrierung ist freiwillig und fr Sie unverbindlich.\n\nWenn Sie sich registrieren, knnen wir Sie ber Produktneuheiten informieren.";
         WordBreak = TRUE;
         Pos = MAP_APPFONT(MARGINLEFT+INDENT2, MARGINTOP+ROWHEIGHT*2);
-        Size = MAP_APPFONT(BODYWIDTH-INDENT2, ROWHEIGHT*9);
+        Size = MAP_APPFONT(BODYWIDTH-INDENT2, ROWHEIGHT*7);
     };
     
     RadioButton RB_REGISTRATION_NOW
     {    
         Text [ en-US ] = "I want to register ~now";
-        Text [ de ]    = "Ich mchte mich ~jetzt registrieren";
+        Text [ de ]    = "Ich mchte mich jetzt ~registrieren";
         Pos = MAP_APPFONT(MARGINLEFT+INDENT2, ROWHEIGHT*11);
         Size = MAP_APPFONT(BODYWIDTH-INDENT2, ROWHEIGHT*2); 
         Check = TRUE;       
@@ -459,6 +471,7 @@ TabPage TP_REGISTRATION
     
     FixedText FT_REGISTRATION_END
     {
+        NoLabel = TRUE;
         Text [ en-US ] = "We hope you enjoy working with %PRODUCTNAME.\n\nTo exit the wizard, click 'Finish'.";
         Text [ de ]    = "Wir wnschen Ihnen viel Spa und Erfolg mit %PRODUCTNAME.\n\nKlicken Sie auf 'Fertig', um den Assistenten zu beenden.";
         Pos = MAP_APPFONT(MARGINLEFT, TP_HEIGHT-MARGINBOTTOM-ROWHEIGHT*4);    
Index: desktop/source/migration/services/jvmfwk.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/migration/services/jvmfwk.cxx,v
retrieving revision 1.4
retrieving revision 1.2.4.2
diff -u -p -u -p -r1.4 -r1.2.4.2
--- desktop/source/migration/services/jvmfwk.cxx	27 Jan 2005 14:27:09 -0000	1.4
+++ desktop/source/migration/services/jvmfwk.cxx	7 Feb 2005 14:37:10 -0000	1.2.4.2
@@ -351,7 +351,8 @@ css::uno::Any SAL_CALL JavaMigration::ex
                css::uno::RuntimeException)
 {
     migrateJavarc();
-	m_xLayer->readData(this);
+    if (m_xLayer.is())
+        m_xLayer->readData(this);
     
     return css::uno::Any();
 }
Index: desktop/source/so_comp/firststart.cxx
===================================================================
RCS file: desktop/source/so_comp/firststart.cxx
diff -N desktop/source/so_comp/firststart.cxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ desktop/source/so_comp/firststart.cxx	14 Jan 2005 11:49:32 -0000	1.1.2.2
@@ -0,0 +1,187 @@
+/*************************************************************************
+ *
+ *  $RCSfile$
+ *
+ *  $Revision$
+ *
+ *  last change: $Author$ $Date$
+ *
+ *  The Contents of this file are made available subject to the terms of
+ *  either of the following licenses
+ *
+ *         - GNU Lesser General Public License Version 2.1
+ *         - Sun Industry Standards Source License Version 1.1
+ *
+ *  Sun Microsystems Inc., October, 2000
+ *
+ *  GNU Lesser General Public License Version 2.1
+ *  =============================================
+ *  Copyright 2000 by Sun Microsystems, Inc.
+ *  901 San Antonio Road, Palo Alto, CA 94303, USA
+ *
+ *  This library is free software; you can redistribute it and/or
+ *  modify it under the terms of the GNU Lesser General Public
+ *  License version 2.1, as published by the Free Software Foundation.
+ *
+ *  This library is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *  Lesser General Public License for more details.
+ *
+ *  You should have received a copy of the GNU Lesser General Public
+ *  License along with this library; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+ *  MA  02111-1307  USA
+ *
+ *
+ *  Sun Industry Standards Source License Version 1.1
+ *  =================================================
+ *  The contents of this file are subject to the Sun Industry Standards
+ *  Source License Version 1.1 (the "License"); You may not use this file
+ *  except in compliance with the License. You may obtain a copy of the
+ *  License at http://www.openoffice.org/license.html.
+ *
+ *  Software provided under this License is provided on an "AS IS" basis,
+ *  WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING,
+ *  WITHOUT LIMITATION, WARRANTIES THAT THE SOFTWARE IS FREE OF DEFECTS,
+ *  MERCHANTABLE, FIT FOR A PARTICULAR PURPOSE, OR NON-INFRINGING.
+ *  See the License for the specific provisions governing your rights and
+ *  obligations concerning the Software.
+ *
+ *  The Initial Developer of the Original Code is: Sun Microsystems, Inc.
+ *
+ *  Copyright: 2000 by Sun Microsystems, Inc.
+ *
+ *  All Rights Reserved.
+ *
+ *  Contributor(s): _______________________________________
+ *
+ *
+ ************************************************************************/
+
+#include "firststart.hxx"
+#include "../migration/wizard.hxx"
+
+using namespace rtl;
+using namespace ::com::sun::star::uno;
+using namespace ::com::sun::star::lang;
+using namespace ::com::sun::star::beans;
+
+namespace desktop{
+
+
+const char* FirstStart::interfaces[] =
+{
+    "com.sun.star.task.XJob",
+    NULL,
+};
+const char* FirstStart::implementationName = "com.sun.star.comp.desktop.FirstStart";
+const char* FirstStart::serviceName = "com.sun.star.task.Job";
+
+OUString FirstStart::GetImplementationName()
+{
+	return OUString( RTL_CONSTASCII_USTRINGPARAM( implementationName));
+}
+
+Sequence< OUString > FirstStart::GetSupportedServiceNames()
+{
+	sal_Int32 nSize = (sizeof( interfaces ) / sizeof( const char *)) - 1;
+	Sequence< OUString > aResult( nSize );
+	
+	for( sal_Int32 i = 0; i < nSize; i++ )
+		aResult[i] = OUString::createFromAscii( interfaces[i] );
+	return aResult;
+}
+
+Reference< XInterface >  SAL_CALL FirstStart::CreateInstance(
+    const Reference< XMultiServiceFactory >& rSMgr )
+{
+	    static osl::Mutex aMutex;
+		osl::MutexGuard guard( aMutex );
+		return (XComponent*) ( new FirstStart( rSMgr ) );
+}
+
+FirstStart::FirstStart( const Reference< XMultiServiceFactory >& xFactory ) : 
+	m_aListeners( m_aMutex ),
+	m_xServiceManager( xFactory )
+{
+}
+
+FirstStart::~FirstStart()
+{
+}
+
+// XComponent
+void SAL_CALL FirstStart::dispose() throw ( RuntimeException )
+{
+    EventObject aObject;
+    aObject.Source = (XComponent*)this;
+    m_aListeners.disposeAndClear( aObject );
+}
+
+void SAL_CALL FirstStart::addEventListener( const Reference< XEventListener > & aListener) throw ( RuntimeException )
+{
+    m_aListeners.addInterface( aListener );
+}
+
+void SAL_CALL FirstStart::removeEventListener( const Reference< XEventListener > & aListener ) throw ( RuntimeException )
+{
+    m_aListeners.removeInterface( aListener );
+}
+
+// XServiceInfo
+::rtl::OUString SAL_CALL FirstStart::getImplementationName() 
+throw ( RuntimeException )
+{
+	return FirstStart::GetImplementationName();
+}
+
+sal_Bool SAL_CALL FirstStart::supportsService( const ::rtl::OUString& rServiceName ) 
+throw ( RuntimeException )
+{
+	sal_Int32 nSize = sizeof( interfaces ) / sizeof( const char *);
+	
+	for( sal_Int32 i = 0; i < nSize; i++ )
+		if ( rServiceName.equalsAscii( interfaces[i] ))
+			return sal_True;
+	return sal_False;
+}
+
+Sequence< ::rtl::OUString > SAL_CALL FirstStart::getSupportedServiceNames() 
+throw ( RuntimeException )
+{
+	return FirstStart::GetSupportedServiceNames();
+}
+
+// XJob
+Any SAL_CALL FirstStart::execute(const Sequence<NamedValue>& args)
+throw ( RuntimeException )
+{
+    sal_Bool bOverride = sal_False;
+    if (args.getLength() > 0 && args[0].Name.equalsAscii("Override"))
+        args[0].Value >>= bOverride;
+
+    if(bOverride || FirstStartWizard::isFirstStart() || !FirstStartWizard::isLicenseAccepted())
+    {
+        FirstStartWizard fsw(NULL);
+        return makeAny((sal_Bool)fsw.Execute());
+    }
+    else
+        return makeAny(sal_True);
+}
+
+// XJobExecutor
+void SAL_CALL FirstStart::trigger(const OUString& arg)
+throw ( RuntimeException )
+{
+    // trigger wizard with override, so it gets started regardless of
+    // configuration
+    Sequence<NamedValue> seq(1);
+    seq[0] = NamedValue(
+        OUString::createFromAscii("Override"),
+        makeAny(sal_True));
+    execute(seq);
+}
+
+
+} // namespace desktop
Index: desktop/source/so_comp/firststart.hxx
===================================================================
RCS file: desktop/source/so_comp/firststart.hxx
diff -N desktop/source/so_comp/firststart.hxx
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ desktop/source/so_comp/firststart.hxx	13 Dec 2004 12:38:32 -0000	1.1.2.1
@@ -0,0 +1,138 @@
+/*************************************************************************
+ *
+ *  $RCSfile$
+ *
+ *  $Revision$
+ *
+ *  last change: $Author$ $Date$
+ *
+ *  The Contents of this file are made available subject to the terms of
+ *  either of the following licenses
+ *
+ *         - GNU Lesser General Public License Version 2.1
+ *         - Sun Industry Standards Source License Version 1.1
+ *
+ *  Sun Microsystems Inc., October, 2000
+ *
+ *  GNU Lesser General Public License Version 2.1
+ *  =============================================
+ *  Copyright 2000 by Sun Microsystems, Inc.
+ *  901 San Antonio Road, Palo Alto, CA 94303, USA
+ *
+ *  This library is free software; you can redistribute it and/or
+ *  modify it under the terms of the GNU Lesser General Public
+ *  License version 2.1, as published by the Free Software Foundation.
+ *
+ *  This library is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *  Lesser General Public License for more details.
+ *
+ *  You should have received a copy of the GNU Lesser General Public
+ *  License along with this library; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+ *  MA  02111-1307  USA
+ *
+ *
+ *  Sun Industry Standards Source License Version 1.1
+ *  =================================================
+ *  The contents of this file are subject to the Sun Industry Standards
+ *  Source License Version 1.1 (the "License"); You may not use this file
+ *  except in compliance with the License. You may obtain a copy of the
+ *  License at http://www.openoffice.org/license.html.
+ *
+ *  Software provided under this License is provided on an "AS IS" basis,
+ *  WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING,
+ *  WITHOUT LIMITATION, WARRANTIES THAT THE SOFTWARE IS FREE OF DEFECTS,
+ *  MERCHANTABLE, FIT FOR A PARTICULAR PURPOSE, OR NON-INFRINGING.
+ *  See the License for the specific provisions governing your rights and
+ *  obligations concerning the Software.
+ *
+ *  The Initial Developer of the Original Code is: Sun Microsystems, Inc.
+ *
+ *  Copyright: 2000 by Sun Microsystems, Inc.
+ *
+ *  All Rights Reserved.
+ *
+ *  Contributor(s): _______________________________________
+ *
+ *
+ ************************************************************************/
+
+#ifndef _SOCOMP_FIRSTSTART_HXX_
+#define _SOCOMP_FIRSTSTART_HXX_
+
+#ifndef _COM_SUN_STAR_LANG_XSERVICEINFO_HPP_
+#include <com/sun/star/lang/XServiceInfo.hpp>
+#endif
+#ifndef _COM_SUN_STAR_UNO_EXCEPTION_HPP_
+#include <com/sun/star/uno/Exception.hpp>
+#endif
+#ifndef _COM_SUN_STAR_UNO_REFERENCE_H_
+#include <com/sun/star/uno/Reference.h>
+#endif
+#ifndef _COM_SUN_STAR_LANG_XCOMPONENT_HPP_
+#include <com/sun/star/lang/XComponent.hpp>
+#endif
+#ifndef _COM_SUN_STAR_TASK_XJOB_HPP_
+#include <com/sun/star/task/XJob.hpp>
+#endif
+#ifndef _CPPUHELPER_IMPLBASE4_HXX_
+#include <cppuhelper/implbase4.hxx>
+#endif
+#ifndef _CPPUHELPER_INTERFACECONTAINER_H_
+#include <cppuhelper/interfacecontainer.h>
+#endif
+#include <com/sun/star/task/XJobExecutor.hpp>
+#include <com/sun/star/lang/XSingleServiceFactory.hpp>
+#include <osl/mutex.hxx>
+
+using namespace ::com::sun::star::uno;
+using namespace ::com::sun::star::lang;
+using namespace ::com::sun::star::beans;
+using namespace ::com::sun::star::task;
+
+namespace desktop{
+
+class FirstStart : public ::cppu::WeakImplHelper4< XJob, XJobExecutor, XComponent, XServiceInfo >
+{
+
+private:
+    ::osl::Mutex						m_aMutex;
+    ::cppu::OInterfaceContainerHelper	m_aListeners;
+    Reference< XMultiServiceFactory >	m_xServiceManager;
+
+public:
+    FirstStart( const Reference < XMultiServiceFactory >& xFactory );
+    virtual ~FirstStart();
+
+    static ::rtl::OUString						GetImplementationName();
+    static Sequence< rtl::OUString >			GetSupportedServiceNames();
+
+
+	// XComponent
+    virtual void SAL_CALL dispose() throw ( RuntimeException );
+    virtual void SAL_CALL addEventListener( const Reference< XEventListener > & aListener) throw ( RuntimeException );
+    virtual void SAL_CALL removeEventListener(const Reference< XEventListener > & aListener) throw ( RuntimeException );
+
+	// XServiceInfo
+	virtual ::rtl::OUString SAL_CALL	getImplementationName() throw ( RuntimeException );
+	virtual sal_Bool SAL_CALL			supportsService( const ::rtl::OUString& rServiceName ) throw ( RuntimeException );
+	virtual Sequence< ::rtl::OUString > SAL_CALL getSupportedServiceNames() throw ( RuntimeException );
+
+    //XJob
+    virtual Any SAL_CALL execute(const Sequence<NamedValue>& args)throw ( RuntimeException );
+    //XJobExecutor
+    virtual void SAL_CALL trigger(const rtl::OUString& arg)throw ( RuntimeException );
+
+    static const char* interfaces[];
+    static const char* implementationName;
+    static const char* serviceName;
+    static Reference<XInterface> SAL_CALL CreateInstance(
+        const Reference< XMultiServiceFactory >&);
+
+
+};
+}
+
+#endif // _SOCOMP_FIRSTSTART_HXX_
Index: desktop/source/so_comp/makefile.mk
===================================================================
RCS file: /cvs/framework/desktop/source/so_comp/makefile.mk,v
retrieving revision 1.11
retrieving revision 1.9.4.3
diff -u -p -u -p -r1.11 -r1.9.4.3
--- desktop/source/so_comp/makefile.mk	24 Jan 2005 17:33:19 -0000	1.11
+++ desktop/source/so_comp/makefile.mk	7 Feb 2005 14:38:34 -0000	1.9.4.3
@@ -81,10 +81,16 @@ CDEFS+=-DTIMEBOMB=20050930
 
 SLOFILES =	$(SLO)$/evaluation.obj \
             $(SLO)$/oemjob.obj \
-            $(SLO)$/services.obj
+            $(SLO)$/services.obj \
+            $(SLO)$/firststart.obj
 
 SHL1DEPN=	makefile.mk
-SHL1OBJS=	$(SLOFILES)
+SHL1OBJS=	$(SLOFILES) \
+            $(SLO)$/pages.obj \
+            $(SLO)$/wizard.obj \
+            $(SLO)$/migration.obj \
+            $(SLO)$/cfgfilter.obj
+
 
 SHL1TARGET=	$(TARGET)
 SHL1IMPLIB= i$(TARGET)
@@ -94,8 +100,11 @@ SHL1DEF=$(MISC)$/$(SHL1TARGET).def
 DEF1NAME=$(SHL1TARGET)
 
 SHL1STDLIBS= \
-	$(VCLLIB)			\
-	$(UNOTOOLSLIB)		\
+	$(VCLLIB)           \
+	$(SVLLIB)           \
+	$(SVTOOLLIB)        \
+	$(COMPHELPERLIB)    \
+	$(UNOTOOLSLIB)      \
 	$(TOOLSLIB)			\
 	$(CPPUHELPERLIB)	\
 	$(CPPULIB)			\
Index: desktop/source/so_comp/services.cxx
===================================================================
RCS file: /cvs/framework/desktop/source/so_comp/services.cxx,v
retrieving revision 1.2
retrieving revision 1.2.374.1
diff -u -p -u -p -r1.2 -r1.2.374.1
--- desktop/source/so_comp/services.cxx	22 May 2003 08:55:11 -0000	1.2
+++ desktop/source/so_comp/services.cxx	13 Dec 2004 12:37:54 -0000	1.2.374.1
@@ -83,6 +83,7 @@
 
 #include "oemjob.hxx"
 #include "evaluation.hxx"
+#include "firststart.hxx"
 
 
 using namespace rtl;
@@ -95,7 +96,8 @@ using namespace ::desktop;
 static const char* pServices[] =
 {
     SOEvaluation::serviceName,
-    OEMPreloadJob::serviceName,    
+    OEMPreloadJob::serviceName,
+    FirstStart::serviceName,
     NULL
 };
 
@@ -103,6 +105,7 @@ static const char* pImplementations[] =
 {
     SOEvaluation::implementationName,
     OEMPreloadJob::implementationName,    
+    FirstStart::implementationName,    
     NULL
 };
 
@@ -112,6 +115,7 @@ static const fProvider pInstanceProvider
 {
     SOEvaluation::CreateInstance,
     OEMPreloadJob::CreateInstance,
+    FirstStart::CreateInstance,
     NULL
 };
 
@@ -120,6 +124,7 @@ static const char** pSupportedServices[]
 {
     SOEvaluation::interfaces,
     OEMPreloadJob::interfaces,
+    FirstStart::interfaces,
     NULL
 };	
 
Index: desktop/util/makefile.mk
===================================================================
RCS file: /cvs/framework/desktop/util/makefile.mk,v
retrieving revision 1.53
retrieving revision 1.50.4.2
diff -u -p -u -p -r1.53 -r1.50.4.2
--- desktop/util/makefile.mk	30 Nov 2004 16:05:50 -0000	1.53
+++ desktop/util/makefile.mk	16 Dec 2004 23:26:25 -0000	1.50.4.2
@@ -94,11 +94,7 @@ TARGETOBJS=	\
 			$(OBJ)$/cmdlinehelp.obj         \
 			$(OBJ)$/langselect.obj          \
 			$(OBJ)$/userinstall.obj         \
-			$(OBJ)$/desktopcontext.obj      \
-			$(OBJ)$/migration.obj           \
-			$(OBJ)$/cfgfilter.obj           \
-            $(OBJ)$/wizard.obj              \
-            $(OBJ)$/pages.obj
+			$(OBJ)$/desktopcontext.obj      
             
 
 
