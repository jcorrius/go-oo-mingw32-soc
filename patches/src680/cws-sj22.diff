Index: svtools/source/filter.vcl/wmf/enhwmf.cxx
===================================================================
RCS file: /cvs/util/svtools/source/filter.vcl/wmf/enhwmf.cxx,v
retrieving revision 1.24
retrieving revision 1.23.144.2
diff -u -p -u -p -r1.24 -r1.23.144.2
--- svtools/source/filter.vcl/wmf/enhwmf.cxx	14 Jul 2005 10:40:40 -0000	1.24
+++ svtools/source/filter.vcl/wmf/enhwmf.cxx	8 Aug 2005 11:09:36 -0000	1.23.144.2
@@ -868,12 +868,12 @@ BOOL EnhWMFReader::ReadEnhWMF() // SvStr
 						>> xformSrc >> nColor >> iUsageSrc >> offBmiSrc >> cbBmiSrc
 							>> offBitsSrc >> cbBitsSrc >> cxSrc >> cySrc;
 
-				cxDest = abs( (int)cxDest );		// sj: i37894, size can be negative
-				cyDest = abs( (int)cyDest );	
-
 				Bitmap		aBitmap;
 				Rectangle	aRect( Point( xDest, yDest ), Size( cxDest+1, cyDest+1 ) );
 
+				cxDest = abs( (int)cxDest );		// sj: i37894, size can be negative
+				cyDest = abs( (int)cyDest );		// and also 122889
+
 				if ( offBmiSrc )
 				{
 					UINT32	nSize = cbBmiSrc + cbBitsSrc + 14;
@@ -918,12 +918,12 @@ BOOL EnhWMFReader::ReadEnhWMF() // SvStr
 				*pWMF >> xDest >> yDest >> xSrc >> ySrc >> cxSrc >> cySrc >> offBmiSrc >> cbBmiSrc >> offBitsSrc
 					>> cbBitsSrc >> iUsageSrc >> dwRop >> cxDest >> cyDest;
 
-				cxDest = abs( (int)cxDest );		// sj: i37894, size can be negative
-				cyDest = abs( (int)cyDest );	
-
 				Bitmap		aBitmap;
 				Rectangle	aRect( Point( xDest, yDest ), Size( cxDest+1, cyDest+1 ) );
 
+				cxDest = abs( (int)cxDest );		// sj: i37894, size can be negative
+				cyDest = abs( (int)cyDest );		// and also 122889
+
 				UINT32 nSize = cbBmiSrc + cbBitsSrc + 14;
 				char* pBuf = new char[ nSize ];
 				SvMemoryStream aTmp( pBuf, nSize, STREAM_READ | STREAM_WRITE );
Index: svtools/source/filter.vcl/wmf/winmtf.cxx
===================================================================
RCS file: /cvs/util/svtools/source/filter.vcl/wmf/winmtf.cxx,v
retrieving revision 1.42
retrieving revision 1.41.372.3
diff -u -p -u -p -r1.42 -r1.41.372.3
--- svtools/source/filter.vcl/wmf/winmtf.cxx	14 Jul 2005 10:40:52 -0000	1.42
+++ svtools/source/filter.vcl/wmf/winmtf.cxx	8 Aug 2005 11:09:49 -0000	1.41.372.3
@@ -204,6 +204,16 @@ void WinMtfPathObj::AddPolyPolygon( cons
 
 void WinMtfPathObj::ClosePath()
 {
+	if ( Count() )
+	{
+		Polygon& rPoly = ((PolyPolygon&)*this)[ Count() - 1 ];
+		if ( rPoly.GetSize() > 2 )
+		{
+			Point aFirst( rPoly[ 0 ] );
+			if ( aFirst != rPoly[ rPoly.GetSize() - 1 ] )
+				rPoly.Insert( rPoly.GetSize(), aFirst, POLY_NORMAL );
+		}
+	}
 	bClosed = sal_True;
 }
 
@@ -1446,7 +1456,9 @@ void WinMtfOutput::DrawText( Point& rPos
 
 	VirtualDevice* pVDev = NULL;
 	
-	rPosition = ImplMap( nGfxMode == GM_ADVANCED ? Point() : rPosition );
+//	rPosition = ImplMap( nGfxMode == GM_ADVANCED ? Point() : rPosition );
+	rPosition = ImplMap( rPosition );
+
 	sal_Int32 nOldGfxMode = GetGfxMode();
 	SetGfxMode( GM_COMPATIBLE );
 	if ( pDXArry )
@@ -1520,20 +1532,23 @@ void WinMtfOutput::DrawText( Point& rPos
 
 	if ( nGfxMode == GM_ADVANCED )
 	{
+		// check whether there is a font rotation applied via transformation
 		Point aP1( ImplMap( Point() ) );
-		Point aP2( ImplMap( Point( 0, aTmp.GetHeight() ) ) );
+		Point aP2( ImplMap( Point( 0, 100 ) ) );
 		aP2.X() -= aP1.X();
 		aP2.Y() -= aP1.Y();
 		double fX = aP2.X();
 		double fY = aP2.Y();
-		double fHeight = sqrt( fX * fX + fY * fY );
-		aTmp.SetHeight( (sal_Int32)fHeight );
-
-		double fOrientation = acos( fX / sqrt( fX * fX + fY * fY ) ) * 57.29577951308;
-		if ( fY > 0 )
-			fOrientation = 360 - fOrientation;
-		fOrientation += 90;
-		aTmp.SetOrientation( sal_Int16( fOrientation * 10.0 ) );
+		if ( fX )
+		{
+			double fOrientation = acos( fX / sqrt( fX * fX + fY * fY ) ) * 57.29577951308;
+			if ( fY > 0 )
+				fOrientation = 360 - fOrientation;
+			fOrientation += 90;
+			fOrientation *= 10;
+			fOrientation += aTmp.GetOrientation();
+			aTmp.SetOrientation( sal_Int16( fOrientation ) );
+		}
 	}
 
 	if( mnTextAlign & ( TA_UPDATECP | TA_RIGHT_CENTER ) )
Index: svtools/source/filter.vcl/wmf/winwmf.cxx
===================================================================
RCS file: /cvs/util/svtools/source/filter.vcl/wmf/winwmf.cxx,v
retrieving revision 1.24
retrieving revision 1.23.352.2
diff -u -p -u -p -r1.24 -r1.23.352.2
--- svtools/source/filter.vcl/wmf/winwmf.cxx	14 Jul 2005 10:41:18 -0000	1.24
+++ svtools/source/filter.vcl/wmf/winwmf.cxx	8 Aug 2005 11:10:25 -0000	1.23.352.2
@@ -436,7 +436,8 @@ void WMFReader::ReadRecordParams( USHORT
 
 		case W_META_EXTTEXTOUT:
 		{
-			sal_uInt16	i, nLen, nOptions, nData;
+			sal_Int16	nDx, nDxTmp;
+			sal_uInt16	i, nLen, nOptions;
 			sal_Int32	nRecordPos, nRecordSize, nOriginalTextLen, nNewTextLen;
 			Point		aPosition;
 			Rectangle	aRect;
@@ -485,19 +486,23 @@ void WMFReader::ReadRecordParams( USHORT
 						{
 							if ( pWMF->Tell() >= nMaxStreamPos )
 								break;
-							*pWMF >> nData;
+							*pWMF >> nDx;
 							if ( nNewTextLen != nOriginalTextLen )
 							{
 								ByteString aTmp( aText.GetChar( i ), pOut->GetCharSet() );
 								if ( aTmp.Len() > 1 )
 								{
-									sal_Int32 nToSkip = ( aTmp.Len() - 1 ) << 1;
-									if ( ( nToSkip + pWMF->Tell() ) > nMaxStreamPos )
+									sal_Int32 nDxCount = aTmp.Len() - 1;
+									if ( ( ( nDxCount * 2 ) + pWMF->Tell() ) > nMaxStreamPos )
 										break;
-									pWMF->SeekRel( nToSkip );
+									while ( nDxCount-- )
+									{
+										*pWMF >> nDxTmp;
+										nDx += nDxTmp;
+									}
 								}							
 							}
-							pDXAry[ i ] = nData;
+							pDXAry[ i ] = nDx;
 						}
 						if ( i == nNewTextLen )
 							bUseDXAry = TRUE;
Index: tools/source/generic/poly.cxx
===================================================================
RCS file: /cvs/util/tools/source/generic/poly.cxx,v
retrieving revision 1.5
retrieving revision 1.5.130.1
diff -u -p -u -p -r1.5 -r1.5.130.1
--- tools/source/generic/poly.cxx	17 Jun 2004 13:11:39 -0000	1.5
+++ tools/source/generic/poly.cxx	20 Jul 2005 09:59:43 -0000	1.5.130.1
@@ -498,24 +498,27 @@ Polygon::Polygon( const Rectangle& rRect
 		mpImplPolygon = (ImplPolygon*)(&aStaticImplPolygon);
 	else
 	{
-		nHorzRound = Min( nHorzRound, (ULONG) labs( rRect.GetWidth() >> 1 ) );
-		nVertRound = Min( nVertRound, (ULONG) labs( rRect.GetHeight() >> 1 ) );
+		Rectangle aRect( rRect );
+		aRect.Justify();			// SJ: i9140
+
+		nHorzRound = Min( nHorzRound, (ULONG) labs( aRect.GetWidth() >> 1 ) );
+		nVertRound = Min( nVertRound, (ULONG) labs( aRect.GetHeight() >> 1 ) );
 
 		if( !nHorzRound && !nVertRound )
 		{
 			mpImplPolygon = new ImplPolygon( 5 );
-			mpImplPolygon->mpPointAry[0] = rRect.TopLeft();
-			mpImplPolygon->mpPointAry[1] = rRect.TopRight();
-			mpImplPolygon->mpPointAry[2] = rRect.BottomRight();
-			mpImplPolygon->mpPointAry[3] = rRect.BottomLeft();
-			mpImplPolygon->mpPointAry[4] = rRect.TopLeft();
+			mpImplPolygon->mpPointAry[0] = aRect.TopLeft();
+			mpImplPolygon->mpPointAry[1] = aRect.TopRight();
+			mpImplPolygon->mpPointAry[2] = aRect.BottomRight();
+			mpImplPolygon->mpPointAry[3] = aRect.BottomLeft();
+			mpImplPolygon->mpPointAry[4] = aRect.TopLeft();
 		}
 		else
 		{
-			const Point		aTL( rRect.Left() + nHorzRound, rRect.Top() + nVertRound );
-			const Point		aTR( rRect.Right() - nHorzRound, rRect.Top() + nVertRound );
-			const Point		aBR( rRect.Right() - nHorzRound, rRect.Bottom() - nVertRound );
-			const Point		aBL( rRect.Left() + nHorzRound, rRect.Bottom() - nVertRound );
+			const Point		aTL( aRect.Left() + nHorzRound, aRect.Top() + nVertRound );
+			const Point		aTR( aRect.Right() - nHorzRound, aRect.Top() + nVertRound );
+			const Point		aBR( aRect.Right() - nHorzRound, aRect.Bottom() - nVertRound );
+			const Point		aBL( aRect.Left() + nHorzRound, aRect.Bottom() - nVertRound );
 			Polygon*		pEllipsePoly = new Polygon( Point(), nHorzRound, nVertRound );
 			USHORT			i, nEnd, nSize4 = pEllipsePoly->GetSize() >> 2;
 

Index: sd/source/filter/pptin.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/filter/pptin.cxx,v
retrieving revision 1.77
retrieving revision 1.76.100.2
diff -u -p -u -p -r1.77 -r1.76.100.2
--- sd/source/filter/pptin.cxx	12 Jul 2005 13:27:47 -0000	1.77
+++ sd/source/filter/pptin.cxx	8 Aug 2005 11:42:16 -0000	1.76.100.2
@@ -2807,14 +2807,12 @@ SdrObject* ImplSdPPTImport::ProcessObj( 
 											pMediaObj->SetMergedItemSet( pObj->GetMergedItemSet() );
 
                                             //--remove object from aAnimations list and add the new object instead
-                                            bool bHasAnimation = false;
                                             Ppt97AnimationPtr pAnimation;
                                             {
                                                 tAnimationMap::iterator aFound = aAnimations.find( pObj );
                                                 if( aFound != aAnimations.end() )
                                                 {
-                                                    bHasAnimation =true;
-                                                    pAnimation = Ppt97AnimationPtr( aAnimations[pObj].get() );
+                                                    pAnimation = (*aFound).second;
                                                     aAnimations.erase(aFound);
                                                 }
                                                 aAnimations[pMediaObj] = pAnimation;
Index: sd/source/filter/eppt/epptso.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/filter/eppt/epptso.cxx,v
retrieving revision 1.84
retrieving revision 1.82.100.3
diff -u -p -u -p -r1.84 -r1.82.100.3
--- sd/source/filter/eppt/epptso.cxx	14 Jul 2005 10:44:37 -0000	1.84
+++ sd/source/filter/eppt/epptso.cxx	8 Aug 2005 11:42:36 -0000	1.82.100.3
@@ -1449,12 +1449,13 @@ sal_Bool PPTWriter::ImplGetStyleSheets()
 		bRetValue = aXNamed.is() && aXNameAccess.is() && aXStyleFamiliesSupplier.is();
 		if  ( bRetValue )
 		{
-			for ( nInstance = EPP_TEXTTYPE_Title; nInstance <= EPP_TEXTTYPE_CenterBody; nInstance++ )
+			for ( nInstance = EPP_TEXTTYPE_Title; nInstance <= EPP_TEXTTYPE_CenterTitle; nInstance++ )
 			{
 				String aStyle;
 				String aFamily;
 				switch ( nInstance )
 				{
+					case EPP_TEXTTYPE_CenterTitle :
 					case EPP_TEXTTYPE_Title :
 					{
 						aStyle = String( RTL_CONSTASCII_USTRINGPARAM( "title" ) );
@@ -1505,9 +1506,9 @@ sal_Bool PPTWriter::ImplGetStyleSheets()
 												xPropSet( aXStyle, ::com::sun::star::uno::UNO_QUERY );
 											if( xPropSet.is() )
 												mpStyleSheet->SetStyleSheet( xPropSet, maFontCollection, nInstance, 0 );
-											if ( nInstance == EPP_TEXTTYPE_Body )
+											for ( nLevel = 1; nLevel < 5; nLevel++ )
 											{
-												for ( nLevel = 1; nLevel < 5; nLevel++ )
+												if ( nInstance == EPP_TEXTTYPE_Body )
 												{
 													sal_Unicode cTemp = aStyle.GetChar( aStyle.Len() - 1 );
 													aStyle.SetChar( aStyle.Len() - 1, ++cTemp );
@@ -1525,6 +1526,8 @@ sal_Bool PPTWriter::ImplGetStyleSheets()
 														}
 													}
 												}
+												else
+													mpStyleSheet->SetStyleSheet( xPropSet, maFontCollection, nInstance, nLevel );
 											}
 										}
 									}
Index: sd/source/ui/unoidl/unomodel.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/unoidl/unomodel.cxx,v
retrieving revision 1.88
retrieving revision 1.88.76.1
diff -u -p -u -p -r1.88 -r1.88.76.1
--- sd/source/ui/unoidl/unomodel.cxx	12 Apr 2005 16:59:51 -0000	1.88
+++ sd/source/ui/unoidl/unomodel.cxx	30 Jun 2005 02:46:03 -0000	1.88.76.1
@@ -2034,7 +2034,7 @@ void SAL_CALL SdXImpressDocument::render
 										}
 										presentation::FadeEffect eFe;
 										aAny = xPagePropSet->getPropertyValue( sEffect );
-										vcl::PDFWriter::PageTransition eType = vcl::PDFWriter::Dissolve;
+										vcl::PDFWriter::PageTransition eType = vcl::PDFWriter::Regular;
 										if ( aAny >>= eFe )
 										{
 											switch( eFe )
@@ -2089,10 +2089,11 @@ void SAL_CALL SdXImpressDocument::render
 												case presentation::FadeEffect_FADE_TO_CENTER : eType = vcl::PDFWriter::BoxInward; break;
 												case presentation::FadeEffect_FADE_FROM_CENTER : eType = vcl::PDFWriter::BoxOutward; break;
 
+												case presentation::FadeEffect_NONE : eType = vcl::PDFWriter::Regular; break;
+
 												case presentation::FadeEffect_RANDOM :
 												case presentation::FadeEffect_DISSOLVE :
 												default: eType = vcl::PDFWriter::Dissolve; break;
-
 											}
 										}
 										pPDFExtOutDevData->SetPageTransition( eType, nTime, -1 );
Index: goodies/source/filter.vcl/icgm/cgm.cxx
===================================================================
RCS file: /cvs/graphics/goodies/source/filter.vcl/icgm/cgm.cxx,v
retrieving revision 1.8
retrieving revision 1.8.66.1
diff -u -p -u -p -r1.8 -r1.8.66.1
--- goodies/source/filter.vcl/icgm/cgm.cxx	9 Sep 2004 11:31:01 -0000	1.8
+++ goodies/source/filter.vcl/icgm/cgm.cxx	30 Jun 2005 02:23:28 -0000	1.8.66.1
@@ -1007,6 +1007,7 @@ extern "C" sal_uInt32 __LOADONCALLAPI Im
 						if ( bProgressBar )
 							aXStatInd->end();
 #endif
+						delete pIn;
 					}
 				}
 			}
Index: goodies/source/filter.vcl/ipict/ipict.cxx
===================================================================
RCS file: /cvs/graphics/goodies/source/filter.vcl/ipict/ipict.cxx,v
retrieving revision 1.10
retrieving revision 1.10.50.1
diff -u -p -u -p -r1.10 -r1.10.50.1
--- goodies/source/filter.vcl/ipict/ipict.cxx	27 Jan 2005 16:14:22 -0000	1.10
+++ goodies/source/filter.vcl/ipict/ipict.cxx	21 Jul 2005 13:23:05 -0000	1.10.50.1
@@ -792,7 +792,11 @@ ULONG PictReader::ReadPixMapEtc( Bitmap 
 			if ( nRowBytes < 8 || nPackType == 1 )
 			{
 				for ( i = 0; i < nRowBytes; i++ )
-					SETBYTE;
+				{
+					*pPict >> nDat;
+					if ( nx < nWidth )
+						SETBYTE;
+				}
 				nDataSize += nRowBytes;
 			}
 			else
Index: svx/inc/msdffdef.hxx
===================================================================
RCS file: /cvs/graphics/svx/inc/msdffdef.hxx,v
retrieving revision 1.6
retrieving revision 1.6.332.1
diff -u -p -u -p -r1.6 -r1.6.332.1
--- svx/inc/msdffdef.hxx	21 Jan 2005 14:57:31 -0000	1.6
+++ svx/inc/msdffdef.hxx	30 Jun 2005 03:10:03 -0000	1.6.332.1
@@ -1186,6 +1186,57 @@ typedef enum {
    mso_filterTest = 255          // For testing only
 } MSO_BLIPFILTER;
 
+typedef enum {
+	mso_syscolorButtonFace,				// COLOR_BTNFACE
+	mso_syscolorWindowText,				// COLOR_WINDOWTEXT
+	mso_syscolorMenu,					// COLOR_MENU
+	mso_syscolorHighlight,				// COLOR_HIGHLIGHT
+	mso_syscolorHighlightText,			// COLOR_HIGHLIGHTTEXT
+	mso_syscolorCaptionText,			// COLOR_CAPTIONTEXT
+	mso_syscolorActiveCaption,			// COLOR_ACTIVECAPTION
+	mso_syscolorButtonHighlight,		// COLOR_BTNHIGHLIGHT
+	mso_syscolorButtonShadow,			// COLOR_BTNSHADOW
+	mso_syscolorButtonText,				// COLOR_BTNTEXT
+	mso_syscolorGrayText,				// COLOR_GRAYTEXT
+	mso_syscolorInactiveCaption,		// COLOR_INACTIVECAPTION
+	mso_syscolorInactiveCaptionText,	// COLOR_INACTIVECAPTIONTEXT
+	mso_syscolorInfoBackground,			// COLOR_INFOBK
+	mso_syscolorInfoText,				// COLOR_INFOTEXT
+	mso_syscolorMenuText,				// COLOR_MENUTEXT
+	mso_syscolorScrollbar,				// COLOR_SCROLLBAR
+	mso_syscolorWindow,					// COLOR_WINDOW
+	mso_syscolorWindowFrame,			// COLOR_WINDOWFRAME
+	mso_syscolor3DLight,				// COLOR_3DLIGHT
+	mso_syscolorMax,					// Count of system colors
+
+	mso_colorFillColor = 0xF0,			// Use the fillColor property
+	mso_colorLineOrFillColor,			// Use the line color only if there is a line
+	mso_colorLineColor,					// Use the lineColor property
+	mso_colorShadowColor,				// Use the shadow color
+	mso_colorThis,						// Use this color (only valid as described below)
+	mso_colorFillBackColor,				// Use the fillBackColor property
+	mso_colorLineBackColor,				// Use the lineBackColor property
+	mso_colorFillThenLine,				// Use the fillColor unless no fill and line
+	mso_colorIndexMask = 0xFF,			// Extract the color index
+
+	mso_colorProcessMask	  =0xFFFF00,// All the processing bits
+	mso_colorModificationMask =0x0F00,	// Just the function
+	mso_colorModFlagMask      =0xF000,	// Just the additional flags
+	mso_colorDarken           =0x0100,	// Darken color by parameter/255
+	mso_colorLighten          =0x0200,	// Lighten color by parameter/255
+	mso_colorAdd              =0x0300,	// Add grey level RGB(param,param,param)
+	mso_colorSubtract         =0x0400,	// Subtract grey level RGB(p,p,p)
+	mso_colorReverseSubtract  =0x0500,	// Subtract from grey level RGB(p,p,p)
+	/* In the following "black" means maximum component value, white minimum.
+		The operation is per component, to guarantee white combine with
+	mso_colorGray */
+	mso_colorBlackWhite       =0x0600,	// Black if < uParam, else white (>=)
+	mso_colorInvert           =0x2000,	// Invert color (at the *end*)
+	mso_colorInvert128        =0x4000,	// Invert by toggling the top bit
+	mso_colorGray             =0x8000,	// Make the color gray (before the above!)
+	mso_colorBParamMask       =0xFF0000,// Parameter used as above
+	mso_colorBParamShift = 16,			// To extract the parameter value
+} MSO_SYSCOLORINDEX;
 
 #ifdef Hier_noch_was_aus_der_Doku
 /* The secondary, or data, UID - should always be set. */
Index: svx/inc/svx/sdr/properties/customshapeproperties.hxx
===================================================================
RCS file: /cvs/graphics/svx/inc/svx/sdr/properties/customshapeproperties.hxx,v
retrieving revision 1.3
retrieving revision 1.3.570.1
diff -u -p -u -p -r1.3 -r1.3.570.1
--- svx/inc/svx/sdr/properties/customshapeproperties.hxx	12 Oct 2004 13:49:12 -0000	1.3
+++ svx/inc/svx/sdr/properties/customshapeproperties.hxx	30 Jun 2005 03:26:19 -0000	1.3.570.1
@@ -111,6 +111,9 @@ namespace sdr
 			
 			// Clone() operator, normally just calls the local copy constructor
 			virtual BaseProperties& Clone(SdrObject& rObj) const;
+
+			// This is the notifyer from SfxListener
+			virtual void Notify(SfxBroadcaster& rBC, const SfxHint& rHint);
 		};
 	} // end of namespace properties
 } // end of namespace sdr
Index: svx/source/customshapes/EnhancedCustomShapeFontWork.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/customshapes/EnhancedCustomShapeFontWork.cxx,v
retrieving revision 1.7
retrieving revision 1.7.236.1
diff -u -p -u -p -r1.7 -r1.7.236.1
--- svx/source/customshapes/EnhancedCustomShapeFontWork.cxx	21 Feb 2005 16:17:39 -0000	1.7
+++ svx/source/customshapes/EnhancedCustomShapeFontWork.cxx	30 Jun 2005 03:05:10 -0000	1.7.236.1
@@ -107,12 +107,20 @@
 #define ITEMID_FONT         EE_CHAR_FONTINFO
 #define ITEMID_CHARSCALE_W	EE_CHAR_FONTWIDTH
 #define ITEMID_FRAMEDIR		EE_PARA_WRITINGDIR
+#define ITEMID_POSTURE		EE_CHAR_ITALIC
+#define ITEMID_WEIGHT		EE_CHAR_WEIGHT
 #ifndef _SVX_FRMDIRITEM_HXX
 #include <frmdiritem.hxx>
 #endif
 #ifndef _SVX_FONTITEM_HXX //autogen
 #include <fontitem.hxx>
 #endif
+#ifndef _SVX_POSTITEM_HXX
+#include <postitem.hxx>
+#endif
+#ifndef _SVX_WGHTITEM_HXX
+#include <wghtitem.hxx>
+#endif
 #ifndef _SVX_CHARSCALEITEM_HXX
 #include <charscaleitem.hxx>
 #endif
@@ -207,17 +215,17 @@ sal_Bool InitializeFontWorkData( const S
 			sal_Int16 nParagraphsLeft = rTextObj.GetParagraphCount();
 
 			rFWData.nMaxParagraphsPerTextArea = ( ( nParagraphsLeft - 1 ) / nTextAreaCount ) + 1;
-
+			sal_Int16 j = 0;
 			while( nParagraphsLeft && nTextAreaCount )
 			{
 				FWTextArea aTextArea;
 				sal_Int16 i, nParagraphs = ( ( nParagraphsLeft - 1 ) / nTextAreaCount ) + 1;
-				for ( i = 0; i < nParagraphs; i++ )
+				for ( i = 0; i < nParagraphs; i++, j++ )
 				{
 					FWParagraphData aParagraphData;
-					aParagraphData.aString = rTextObj.GetText( i );
+					aParagraphData.aString = rTextObj.GetText( j );
 
-					const SfxItemSet& rParaSet = rTextObj.GetParaAttribs( i );	// retrieving some paragraph attributes
+					const SfxItemSet& rParaSet = rTextObj.GetParaAttribs( j );	// retrieving some paragraph attributes
 					aParagraphData.nFrameDirection = ((SvxFrameDirectionItem&)rParaSet.Get( EE_PARA_WRITINGDIR )).GetValue();
 					aTextArea.vParagraphs.push_back( aParagraphData );
 				}
@@ -335,6 +343,12 @@ void GetTextAreaOutline( const FWData& r
 			aFont.SetStyleName( rFontItem.GetStyleName() );
 			aFont.SetOrientation( 0 );
 
+			SvxPostureItem& rPostureItem = (SvxPostureItem&)pCustomShape->GetMergedItem( EE_CHAR_ITALIC );
+			aFont.SetItalic( rPostureItem.GetPosture() );
+
+			SvxWeightItem& rWeightItem = (SvxWeightItem&)pCustomShape->GetMergedItem( EE_CHAR_WEIGHT );
+			aFont.SetWeight( rWeightItem.GetWeight() );
+
 			// initializing virtual device
 			VirtualDevice aVirDev( 1 );
 			aVirDev.SetMapMode( MAP_100TH_MM );
Index: svx/source/customshapes/EnhancedCustomShapeGeometry.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/customshapes/EnhancedCustomShapeGeometry.cxx,v
retrieving revision 1.13
retrieving revision 1.13.154.1
diff -u -p -u -p -r1.13 -r1.13.154.1
--- svx/source/customshapes/EnhancedCustomShapeGeometry.cxx	23 Mar 2005 13:29:37 -0000	1.13
+++ svx/source/customshapes/EnhancedCustomShapeGeometry.cxx	30 Jun 2005 02:41:39 -0000	1.13.154.1
@@ -1891,10 +1891,9 @@ static const mso_CustomShape msoCircular
 
 static const SvxMSDffVertPair mso_sptCubeVert[] =
 {
-	{ 0, 10 MSO_I }, { 0, 1 MSO_I }, { 2 MSO_I, 0 }, { 9 MSO_I, 0 },
-	{ 9 MSO_I, 3 MSO_I }, { 4 MSO_I, 10 MSO_I }, { 0, 1 MSO_I }, { 2 MSO_I, 0 },
-	{ 9 MSO_I, 0 }, { 4 MSO_I, 1 MSO_I }, { 4 MSO_I, 10 MSO_I  }, { 4 MSO_I, 1 MSO_I },
-	{ 9 MSO_I, 0 }, { 9 MSO_I, 3 MSO_I }
+	{ 0, 12 MSO_I }, { 0, 1 MSO_I }, { 2 MSO_I, 0 }, { 11 MSO_I, 0 }, { 11 MSO_I, 3 MSO_I }, { 4 MSO_I, 12 MSO_I },
+	{ 0, 1 MSO_I }, { 2 MSO_I, 0 },	{ 11 MSO_I, 0 }, { 4 MSO_I, 1 MSO_I },
+	{ 4 MSO_I, 12 MSO_I  }, { 4 MSO_I, 1 MSO_I },	{ 11 MSO_I, 0 }, { 11 MSO_I, 3 MSO_I }
 };
 static const sal_uInt16 mso_sptCubeSegm[] =
 {
@@ -1909,22 +1908,28 @@ static const SvxMSDffCalculationData mso
 	{ 0x6000, DFF_Prop_geoLeft, 0x400, 0 },
 	{ 0xa000, DFF_Prop_geoBottom, 0, 0x400 },
 	{ 0xa000, DFF_Prop_geoRight, 0, 0x400 },
-	{ 0x8000,  21600, 0, 0x402 },	// 5
-	{ 0x2001, 0x405, 1, 2 },		// 6
-	{ 0x6000, 0x402, 0x406, 0 },	// 7
-	{ 0x2001, 0x404, 1, 2 },		// 8
-	{ 0x2000, DFF_Prop_geoRight, 0, 0 },	// 9
-	{ 0x2000, DFF_Prop_geoBottom, 0, 0 }	//10
+	{ 0xa000, DFF_Prop_geoRight, 0, 0x402 },	// 5
+	{ 0x2001, 0x405, 1, 2 },					// 6
+	{ 0x6000, 0x402, 0x406, 0 },				// 7
+	{ 0xa000, DFF_Prop_geoBottom, 0, 0x401 },	// 8
+	{ 0x2001, 0x408, 1, 2 },					// 9
+	{ 0x6000, 0x401, 0x409, 0 },				// 10
+	{ 0x2000, DFF_Prop_geoRight, 0, 0 },		// 11
+	{ 0x2000, DFF_Prop_geoBottom, 0, 0 }		// 12
 };
 static const SvxMSDffTextRectangles mso_sptCubeTextRect[] =
 {
-	{ { 0, 1 MSO_I }, { 4 MSO_I, 10 MSO_I } }
+	{ { 0, 1 MSO_I }, { 4 MSO_I, 12 MSO_I } }
 };
 static const SvxMSDffHandle mso_sptCubeHandle[] =
 {
 	{	MSDFF_HANDLE_FLAGS_RANGE | MSDFF_HANDLE_FLAGS_SWITCHED,
 		0, 0x100, 10800, 10800, 0x80000000, 0x7fffffff, 0, 21600 }
 };
+static const SvxMSDffVertPair mso_sptCubeGluePoints[] =
+{
+	{ 7 MSO_I, 0 }, { 6 MSO_I, 1 MSO_I }, { 0, 10 MSO_I }, { 6 MSO_I, 21600 }, { 4 MSO_I, 10 MSO_I }, { 21600, 9 MSO_I }
+};
 static const mso_CustomShape msoCube =
 {
 	(SvxMSDffVertPair*)mso_sptCubeVert, sizeof( mso_sptCubeVert ) / sizeof( SvxMSDffVertPair ),
@@ -1934,7 +1939,7 @@ static const mso_CustomShape msoCube =
 	(SvxMSDffTextRectangles*)mso_sptCubeTextRect, sizeof( mso_sptCubeTextRect ) / sizeof( SvxMSDffTextRectangles ),
 	21600, 21600,
 	10800, 10800,
-	NULL, 0,
+	(SvxMSDffVertPair*)mso_sptCubeGluePoints, sizeof( mso_sptCubeGluePoints ) / sizeof( SvxMSDffVertPair ),
 	(SvxMSDffHandle*)mso_sptCubeHandle, sizeof( mso_sptCubeHandle ) / sizeof( SvxMSDffHandle )
 };
 
Index: svx/source/dialog/hlmarkwn.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/dialog/hlmarkwn.cxx,v
retrieving revision 1.11
retrieving revision 1.11.332.1
diff -u -p -u -p -r1.11 -r1.11.332.1
--- svx/source/dialog/hlmarkwn.cxx	21 Jan 2005 16:38:14 -0000	1.11
+++ svx/source/dialog/hlmarkwn.cxx	19 Jul 2005 11:58:27 -0000	1.11.332.1
@@ -328,11 +328,21 @@ BOOL SvxHlinkDlgMarkWnd::RefreshFromDoc(
 				uno::Reference< frame::XComponentLoader > xLoader( xDesktop, uno::UNO_QUERY );
 				if( xLoader.is() )
 				{
-					uno::Sequence< beans::PropertyValue > aArg(1);
-					aArg.getArray()[0].Name = OUString::createFromAscii( "Hidden" );
-					aArg.getArray()[0].Value <<= (sal_Bool) TRUE;
-					xComp = xLoader->loadComponentFromURL( aURL, OUString::createFromAscii( "_blank" ), 0,
-						                                   aArg );
+					try
+					{
+						uno::Sequence< beans::PropertyValue > aArg(1);
+						aArg.getArray()[0].Name = OUString::createFromAscii( "Hidden" );
+						aArg.getArray()[0].Value <<= (sal_Bool) TRUE;
+						xComp = xLoader->loadComponentFromURL( aURL, OUString::createFromAscii( "_blank" ), 0, aArg );
+					}
+					catch( const io::IOException& )
+					{
+
+					}
+					catch( const lang::IllegalArgumentException& )
+					{
+
+					}
 				}
 			}
 			else
Index: svx/source/editeng/impedit3.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/editeng/impedit3.cxx,v
retrieving revision 1.95
retrieving revision 1.95.144.1
diff -u -p -u -p -r1.95 -r1.95.144.1
--- svx/source/editeng/impedit3.cxx	30 Mar 2005 07:50:38 -0000	1.95
+++ svx/source/editeng/impedit3.cxx	19 Jul 2005 16:10:47 -0000	1.95.144.1
@@ -2860,15 +2860,39 @@ void ImpEditEngine::Paint( OutputDevice*
 		{
 			String aActualParaText;
 			pPDFExtOutDevData->BeginStructureElement( vcl::PDFWriter::Paragraph );
-			sal_uInt16 i, j, nPortions, nLines = pPortion->GetLines().Count();
+		
+			sal_uInt16 i, nLines = pPortion->GetLines().Count();
 			for ( i = 0; i < nLines; i++ )
 			{
-				pLine = pPortion->GetLines().GetObject( i );
-				nPortions = pPortion->GetTextPortions().Count();
-				for ( j = 0; j < nPortions; j++ )
+				if ( pPortion->IsVisible() )
 				{
-					TextPortion* pTextPortion = pPortion->GetTextPortions().GetObject( j );
-					aActualParaText.Append( *pPortion->GetNode() );
+					pLine = pPortion->GetLines().GetObject( i );
+					sal_uInt16 nIndex = pLine->GetStart();
+					for ( sal_uInt16 y = pLine->GetStartPortion(); y <= pLine->GetEndPortion(); y++ )
+					{
+						TextPortion* pTextPortion = pPortion->GetTextPortions().GetObject( y );
+						switch ( pTextPortion->GetKind() )
+						{
+							case PORTIONKIND_TEXT:
+							{
+								String aText( *pPortion->GetNode(), nIndex, pTextPortion->GetLen() );
+								aActualParaText.Append( aText );
+							}
+							break;
+							case PORTIONKIND_FIELD:
+							{
+								EditCharAttrib* pAttr = pPortion->GetNode()->GetCharAttribs().FindFeature( nIndex );
+								if ( pAttr && pAttr->GetItem()->ISA( SvxFieldItem ) )
+									aActualParaText.Append( ((EditCharAttribField*)pAttr)->GetFieldValue() );
+							}
+							break;
+							case PORTIONKIND_LINEBREAK :
+							{
+								aActualParaText.Append( String( (sal_Unicode)0xd ) );
+							}
+							break;
+ 						}
+					}
 				}
 			}
 			pPDFExtOutDevData->SetActualText( aActualParaText );
Index: svx/source/msfilter/escherex.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/msfilter/escherex.cxx,v
retrieving revision 1.54
retrieving revision 1.53.154.2
diff -u -p -u -p -r1.54 -r1.53.154.2
--- svx/source/msfilter/escherex.cxx	14 Jul 2005 10:49:09 -0000	1.54
+++ svx/source/msfilter/escherex.cxx	8 Aug 2005 12:19:04 -0000	1.53.154.2
@@ -218,6 +218,12 @@
 #ifndef _COM_SUN_STAR_AWT_XGRAPHICS_HPP_
 #include <com/sun/star/awt/XGraphics.hpp>
 #endif
+#ifndef _COM_SUN_STAR_AWT_FONTSLANT_HPP_
+#include <com/sun/star/awt/FontSlant.hpp>
+#endif
+#ifndef _COM_SUN_STAR_AWT_FONTWEIGHT_HPP_
+#include <com/sun/star/awt/FontWeight.hpp>
+#endif
 #ifndef _COM_SUN_STAR_DRAWING_COLORMODE_HPP_
 #include <com/sun/star/drawing/ColorMode.hpp>
 #endif
@@ -2978,6 +2984,30 @@ void EscherPropertyContainer::CreateCust
 										nTextPathFlags &=~0x1000;
 								}
 							}
+							if ( EscherPropertyValueHelper::GetPropertyValue( aAny, aXPropSet, String( RTL_CONSTASCII_USTRINGPARAM( "CharPosture" ) ), sal_True ) )
+							{
+								awt::FontSlant eFontSlant;
+								if ( aAny >>= eFontSlant )
+								{
+									nTextPathFlags |= 0x100010;
+									if ( eFontSlant != awt::FontSlant_NONE )
+										nTextPathFlags |= 0x10;
+									else
+										nTextPathFlags &=~0x10;
+								}
+							}
+							if ( EscherPropertyValueHelper::GetPropertyValue( aAny, aXPropSet, String( RTL_CONSTASCII_USTRINGPARAM( "CharWeight" ) ), sal_True ) )
+							{
+								float fFontWidth;
+								if ( aAny >>= fFontWidth )
+								{
+									nTextPathFlags |= 0x200020;
+									if ( fFontWidth > awt::FontWeight::NORMAL )
+										nTextPathFlags |= 0x20;
+									else
+										nTextPathFlags &=~0x20;
+								}
+							}
 						}
 						if ( nTextPathFlags != nTextPathFlagsOrg )
 							AddOpt( DFF_Prop_gtextFStrikethrough, nTextPathFlags );
Index: svx/source/msfilter/msdffimp.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/msfilter/msdffimp.cxx,v
retrieving revision 1.122
retrieving revision 1.120.80.4
diff -u -p -u -p -r1.122 -r1.120.80.4
--- svx/source/msfilter/msdffimp.cxx	12 Jul 2005 13:38:39 -0000	1.122
+++ svx/source/msfilter/msdffimp.cxx	8 Aug 2005 12:19:33 -0000	1.120.80.4
@@ -3750,23 +3750,47 @@ Color SvxMSDffManager::MSO_CLR_ToColor( 
 		}
 		else	// SYSCOLOR
 		{
-//			UINT16 nParameter = (BYTE)( nColorCode >> 16);		// SJ: nice compiler optimization bug on windows, though downcasting
+			const StyleSettings& rStyleSettings = Application::GetSettings().GetStyleSettings();
+
+//			UINT16 nParameter = (BYTE)( nColorCode >> 16);					// SJ: nice compiler optimization bug on windows, though downcasting
 			UINT16 nParameter = sal_uInt16(( nColorCode >> 16 ) & 0x00ff);	// the HiByte of nParameter is not zero, an exclusive AND is helping :o
 			UINT16 nFunctionBits = (UINT16)( ( nColorCode & 0x00000f00 ) >> 8 );
 			UINT16 nAdditionalFlags = (UINT16)( ( nColorCode & 0x0000f000) >> 8 );
 			UINT16 nColorIndex = sal_uInt16(nColorCode & 0x00ff);
 			UINT32 nPropColor;
 
-			sal_uInt16	nCProp = DFF_Prop_lineColor;
+			sal_uInt16	nCProp = 0;
+
 			switch ( nColorIndex )
 			{
-				case 0xf0 :	// msocolorFillColor
+				case mso_syscolorButtonFace :			aColor = rStyleSettings.GetFaceColor(); break;
+				case mso_syscolorWindowText :			aColor = rStyleSettings.GetWindowTextColor(); break;
+				case mso_syscolorMenu :					aColor = rStyleSettings.GetMenuColor(); break;
+				case mso_syscolor3DLight :				
+				case mso_syscolorButtonHighlight :
+				case mso_syscolorHighlight :			aColor = rStyleSettings.GetHighlightColor(); break;
+				case mso_syscolorHighlightText :		aColor = rStyleSettings.GetHighlightTextColor(); break;
+				case mso_syscolorCaptionText :			aColor = rStyleSettings.GetMenuTextColor(); break;
+				case mso_syscolorActiveCaption :		aColor = rStyleSettings.GetHighlightColor(); break;
+				case mso_syscolorButtonShadow :			aColor = rStyleSettings.GetShadowColor(); break;
+				case mso_syscolorButtonText :			aColor = rStyleSettings.GetButtonTextColor(); break;
+				case mso_syscolorGrayText :				aColor = rStyleSettings.GetDeactiveColor(); break;
+				case mso_syscolorInactiveCaption :		aColor = rStyleSettings.GetDeactiveColor(); break;
+				case mso_syscolorInactiveCaptionText :	aColor = rStyleSettings.GetDeactiveColor(); break;
+				case mso_syscolorInfoBackground :		aColor = rStyleSettings.GetFaceColor(); break;
+				case mso_syscolorInfoText :				aColor = rStyleSettings.GetInfoTextColor(); break;
+				case mso_syscolorMenuText :				aColor = rStyleSettings.GetMenuTextColor(); break;
+				case mso_syscolorScrollbar :			aColor = rStyleSettings.GetFaceColor(); break;
+				case mso_syscolorWindow :				aColor = rStyleSettings.GetWindowColor(); break;
+				case mso_syscolorWindowFrame :			aColor = rStyleSettings.GetWindowColor(); break;
+
+				case mso_colorFillColor :
 				{
 					nPropColor = GetPropertyValue( DFF_Prop_fillColor, 0xffffff );
 					nCProp = DFF_Prop_fillColor;
 				}
 				break;
-				case 0xf1 : // msocolorLineOrFillColor ( use the line color only if there is a line )
+				case mso_colorLineOrFillColor :		// ( use the line color only if there is a line )
 				{
 					if ( GetPropertyValue( DFF_Prop_fNoLineDrawDash ) & 8 )
 					{
@@ -3780,51 +3804,52 @@ Color SvxMSDffManager::MSO_CLR_ToColor( 
 					}
 				}
 				break;
-				case 0xf2 : // msocolorLineColor
+				case mso_colorLineColor :
 				{
 					nPropColor = GetPropertyValue( DFF_Prop_lineColor, 0 );
 					nCProp = DFF_Prop_lineColor;
 				}
 				break;
-				case 0xf3 : // msocolorShadowColor
+				case mso_colorShadowColor :
 				{
 					nPropColor = GetPropertyValue( DFF_Prop_shadowColor, 0x808080 );
 					nCProp = DFF_Prop_shadowColor;
 				}
 				break;
-				case 0xf4 : // msocolorThis	( use this color ... )
+				case mso_colorThis :				// ( use this color ... )
 				{
 					nPropColor = GetPropertyValue( DFF_Prop_fillColor, 0xffffff );	//?????????????
 					nCProp = DFF_Prop_fillColor;
 				}
 				break;
-				case 0xf5 : // msocolorFillBackColor
+				case mso_colorFillBackColor :
 				{
 					nPropColor = GetPropertyValue( DFF_Prop_fillBackColor, 0xffffff );
 					nCProp = DFF_Prop_fillBackColor;
 				}
 				break;
-				case 0xf6 : // msocolorLineBackColor
+				case mso_colorLineBackColor :
 				{
 					nPropColor = GetPropertyValue( DFF_Prop_lineBackColor, 0xffffff );
 					nCProp = DFF_Prop_lineBackColor;
 				}
 				break;
-				case 0xf7 : // msocolorFillThenLine	( use the fillcolor unless no fill and line )
+				case mso_colorFillThenLine :		// ( use the fillcolor unless no fill and line )
 				{
 					nPropColor = GetPropertyValue( DFF_Prop_fillColor, 0xffffff );	//?????????????
 					nCProp = DFF_Prop_fillColor;
 				}
 				break;
-				case 0xff : // msocolorIndexMask ( extract the color index )
+				case mso_colorIndexMask :			// ( extract the color index ) ?
 				{
 					nPropColor = GetPropertyValue( DFF_Prop_fillColor, 0xffffff );	//?????????????
 					nCProp = DFF_Prop_fillColor;
 				}
 				break;
 			}
-			if ( ( nPropColor & 0x10000000 ) == 0 )	// beware of looping recursive
+			if ( nCProp && ( nPropColor & 0x10000000 ) == 0 )		// beware of looping recursive
 				aColor = MSO_CLR_ToColor( nPropColor, nCProp );
+
 			if( nAdditionalFlags & 0x80 )			// make color gray
 			{
 				UINT8 nZwi = aColor.GetLuminance();
@@ -4890,10 +4915,7 @@ SdrObject* SvxMSDffManager::ImportShape(
 			sal_uInt32	nSpFlags = aObjData.nSpFlags;
 
 			if ( bGraphic )
-			{
-				pRet = ImportGraphic( rSt, aSet, aBoundRect, aObjData );
-				nSpFlags &=~ ( SP_FFLIPH | SP_FFLIPV );			// #68396#
-			}
+				pRet = ImportGraphic( rSt, aSet, aBoundRect, aObjData );		// SJ: #68396# is no longer true (fixed in ppt2000)
 			else
 			{
 				// Check if we are using our new as shape type. This is done by
@@ -4933,6 +4955,13 @@ SdrObject* SvxMSDffManager::ImportShape(
 								aSet.Put( SvxFontItem( aLatin.GetFamily(), aFontName, aLatin.GetStyleName() ) );
 							}
 
+							// SJ: applying fontattributes for Fontwork :
+							if ( IsHardAttribute( DFF_Prop_gtextFItalic ) )
+								aSet.Put( SvxPostureItem( ( GetPropertyValue( DFF_Prop_gtextFStrikethrough, 0 ) & 0x0010 ) != 0 ? ITALIC_NORMAL : ITALIC_NONE ) );
+
+							if ( IsHardAttribute( DFF_Prop_gtextFBold ) )							
+								aSet.Put( SvxWeightItem( ( GetPropertyValue( DFF_Prop_gtextFStrikethrough, 0 ) & 0x0020 ) != 0 ? WEIGHT_BOLD : WEIGHT_NORMAL ) );
+
 							// SJ TODO: Vertical Writing is not correct, instead this should be
 							// replaced through "CharacterRotation" by 90°, therefore a new Item has to be
 							// supported by svx core, api and xml file format
Index: svx/source/sdr/properties/customshapeproperties.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/sdr/properties/customshapeproperties.cxx,v
retrieving revision 1.5
retrieving revision 1.5.462.2
diff -u -p -u -p -r1.5 -r1.5.462.2
--- svx/source/sdr/properties/customshapeproperties.cxx	18 Nov 2004 11:03:38 -0000	1.5
+++ svx/source/sdr/properties/customshapeproperties.cxx	30 Jun 2005 10:20:22 -0000	1.5.462.2
@@ -63,6 +63,12 @@
 #include <svx/sdr/properties/customshapeproperties.hxx>
 #endif
 
+#ifndef _SFXITEMSET_HXX
+#include <svtools/itemset.hxx>
+#endif
+#ifndef _SFXSTYLE_HXX
+#include <svtools/style.hxx>
+#endif
 #ifndef _SVDOASHP_HXX
 #include <svdoashp.hxx>
 #endif
@@ -78,6 +84,9 @@
 #ifndef _SFXITEMSET_HXX
 #include <svtools/itemset.hxx>
 #endif
+#ifndef _SFXSMPLHINT_HXX
+#include <svtools/smplhint.hxx>
+#endif
 
 //////////////////////////////////////////////////////////////////////////////
 
@@ -220,6 +229,36 @@ namespace sdr
 		{
 			return *(new CustomShapeProperties(*this, rObj));
 		}
+		void CustomShapeProperties::Notify( SfxBroadcaster& rBC, const SfxHint& rHint )
+		{
+			TextProperties::Notify( rBC, rHint );
+
+			sal_Bool bRemoveRenderGeometry = sal_False;
+
+			const SfxStyleSheetHint *pStyleHint = PTR_CAST( SfxStyleSheetHint, &rHint );
+			const SfxSimpleHint *pSimpleHint = PTR_CAST( SfxSimpleHint, &rHint );
+			if ( pStyleHint && pStyleHint->GetStyleSheet() == GetStyleSheet() )
+			{
+				switch( pStyleHint->GetHint() )
+				{
+					case SFX_STYLESHEET_MODIFIED :
+					case SFX_STYLESHEET_CHANGED	 :
+						bRemoveRenderGeometry = sal_True;
+					break;
+				};
+			}
+			else if ( pSimpleHint && pSimpleHint->GetId() == SFX_HINT_DATACHANGED )
+			{
+				bRemoveRenderGeometry = sal_True;
+			}
+			if ( bRemoveRenderGeometry )
+			{
+				// local changes, removing cached objects
+				SdrObjCustomShape& rObj = (SdrObjCustomShape&)GetSdrObject();
+				rObj.InvalidateRenderGeometry();
+			}
+
+		}
 	} // end of namespace properties
 } // end of namespace sdr
 
Index: svx/source/svdraw/svdograf.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/svdraw/svdograf.cxx,v
retrieving revision 1.66
retrieving revision 1.65.364.2
diff -u -p -u -p -r1.66 -r1.65.364.2
--- svx/source/svdraw/svdograf.cxx	14 Jul 2005 11:33:56 -0000	1.66
+++ svx/source/svdraw/svdograf.cxx	8 Aug 2005 12:22:33 -0000	1.65.364.2
@@ -1093,13 +1093,18 @@ sal_Bool SdrGrafObj::DoPaintObject( XOut
 			// paint animated graphic?
 			if(rInfoRec.mbUseBitmapEx)
 			{
-				Point aDestPos = pOutDev->LogicToPixel(aLogPos);
-				Size aDestSize = pOutDev->LogicToPixel(aLogSize);
-				sal_Bool bMapModeWasEnabled(pOutDev->IsMapModeEnabled());
-
-				pOutDev->EnableMapMode(sal_False);
-				pOutDev->DrawBitmapEx(aDestPos, aDestSize, rInfoRec.maBitmapEx);
-				pOutDev->EnableMapMode(bMapModeWasEnabled);
+				if ( pOutDev->GetConnectMetaFile() )	// SJ: #i52183#
+					pOutDev->DrawBitmapEx( aLogPos, aLogSize, rInfoRec.maBitmapEx );
+				else
+				{
+					Point aDestPos = pOutDev->LogicToPixel(aLogPos);
+					Size aDestSize = pOutDev->LogicToPixel(aLogSize);
+					sal_Bool bMapModeWasEnabled(pOutDev->IsMapModeEnabled());
+
+					pOutDev->EnableMapMode(sal_False);
+					pOutDev->DrawBitmapEx(aDestPos, aDestSize, rInfoRec.maBitmapEx);
+					pOutDev->EnableMapMode(bMapModeWasEnabled);
+				}
 			}
 			else
 			{
Index: svx/source/unodraw/unoshape.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/unodraw/unoshape.cxx,v
retrieving revision 1.135
retrieving revision 1.133.114.2
diff -u -p -u -p -r1.135 -r1.133.114.2
--- svx/source/unodraw/unoshape.cxx	21 Jul 2005 15:04:29 -0000	1.135
+++ svx/source/unodraw/unoshape.cxx	8 Aug 2005 12:25:28 -0000	1.133.114.2
@@ -2497,7 +2497,7 @@ uno::Any SvxShape::_getPropertyValue( co
 				{
 					SdrOle2Obj& aObj = *(SdrOle2Obj*)pObj;
                     Graphic* pGraphic = aObj.GetGraphic();
-                    if(pGraphic)
+                    if( pGraphic )
 					{
                         BOOL bIsWMF = FALSE;
                         if ( pGraphic->IsLink() )
@@ -2510,11 +2510,22 @@ uno::Any SvxShape::_getPropertyValue( co
                                 aAny <<= aSeq;
                             }
                         }
-
                         if ( !bIsWMF )
                         {
+							GDIMetaFile aMtf;
+							if ( pGraphic->GetType() != GRAPHIC_BITMAP )
+								aMtf = aObj.GetGraphic()->GetGDIMetaFile();
+							else
+							{
+								VirtualDevice aVirDev;
+								aMtf.Record( &aVirDev );
+								pGraphic->Draw( &aVirDev, Point(),  pGraphic->GetPrefSize() );
+								aMtf.Stop();
+								aMtf.SetPrefSize( pGraphic->GetPrefSize() );
+								aMtf.SetPrefMapMode( pGraphic->GetPrefMapMode() );
+							}
                             SvMemoryStream aDestStrm( 65535, 65535 );
-                            ConvertGDIMetaFileToWMF( aObj.GetGraphic()->GetGDIMetaFile(), aDestStrm, NULL, NULL, sal_False );
+                            ConvertGDIMetaFileToWMF( aMtf, aDestStrm, NULL, NULL, sal_False );
                             uno::Sequence<sal_Int8> aSeq((sal_Int8*)aDestStrm.GetData(), aDestStrm.GetSize());
                             aAny <<= aSeq;
                         }
Index: sfx2/source/dialog/filedlghelper.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/dialog/filedlghelper.cxx,v
retrieving revision 1.115
retrieving revision 1.115.162.1
diff -u -p -u -p -r1.115 -r1.115.162.1
--- sfx2/source/dialog/filedlghelper.cxx	21 Feb 2005 16:59:45 -0000	1.115
+++ sfx2/source/dialog/filedlghelper.cxx	30 Jun 2005 08:31:31 -0000	1.115.162.1
@@ -1524,7 +1524,7 @@ ErrCode FileDialogHelper_Impl::execute( 
 			{
 				Any aValue = xCtrlAccess->getValue( ExtendedFilePickerElementIds::CHECKBOX_SELECTION, 0 );
 				sal_Bool bSelection = sal_False;
-				if ( ( aValue >>= bSelection ) && bSelection )
+				if ( aValue >>= bSelection )
 					rpSet->Put( SfxBoolItem( SID_SELECTION, bSelection ) );
 			}
 			catch( IllegalArgumentException )
Index: vcl/source/gdi/pngread.cxx
===================================================================
RCS file: /cvs/gsl/vcl/source/gdi/pngread.cxx,v
retrieving revision 1.9
retrieving revision 1.8.122.2
diff -u -p -u -p -r1.9 -r1.8.122.2
--- vcl/source/gdi/pngread.cxx	14 Jul 2005 12:04:23 -0000	1.9
+++ vcl/source/gdi/pngread.cxx	8 Aug 2005 14:02:52 -0000	1.8.122.2
@@ -669,6 +669,7 @@ void PNGReaderImpl::ImplReadTransparent(
 					mnTransRed = ImplScaleColor();
 					mnTransGreen = ImplScaleColor();
 					mnTransBlue = ImplScaleColor();
+					mbTransparent = sal_True;
 				}
 			}
 			break;
