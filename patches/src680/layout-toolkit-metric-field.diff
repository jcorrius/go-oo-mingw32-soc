Index: toolkit/source/awt/vclxwindows.cxx
===================================================================
RCS file: /cvs/gsl/toolkit/source/awt/vclxwindows.cxx,v
retrieving revision 1.63.8.1
diff -u -p -u -r1.63.8.1 vclxwindows.cxx
--- toolkit/source/awt/vclxwindows.cxx	13 Jul 2007 17:43:52 -0000	1.63.8.1
+++ toolkit/source/awt/vclxwindows.cxx	25 Jul 2007 13:44:43 -0000
@@ -4735,6 +4735,232 @@ void VCLXNumericField::setProperty( cons
 
 
 //	----------------------------------------------------
+//	class VCLXMetricField
+//	----------------------------------------------------
+
+void VCLXMetricField::ImplGetPropertyIds( std::list< sal_uInt16 > &rIds )
+{
+    PushPropertyIds( rIds,
+                     BASEPROPERTY_BACKGROUNDCOLOR,
+                     BASEPROPERTY_BORDER,
+                     BASEPROPERTY_BORDERCOLOR,
+                     BASEPROPERTY_DECIMALACCURACY,
+                     BASEPROPERTY_DEFAULTCONTROL,
+                     BASEPROPERTY_ENABLED,
+                     BASEPROPERTY_FONTDESCRIPTOR,
+                     BASEPROPERTY_HELPTEXT,
+                     BASEPROPERTY_HELPURL,
+                     BASEPROPERTY_NUMSHOWTHOUSANDSEP,
+                     BASEPROPERTY_PRINTABLE,
+                     BASEPROPERTY_READONLY,
+                     BASEPROPERTY_REPEAT,
+                     BASEPROPERTY_REPEAT_DELAY,
+                     BASEPROPERTY_SPIN,
+                     BASEPROPERTY_STRICTFORMAT,
+                     BASEPROPERTY_TABSTOP,
+                     BASEPROPERTY_ENFORCE_FORMAT,
+                     BASEPROPERTY_HIDEINACTIVESELECTION,
+                     0);
+    VCLXFormattedSpinField::ImplGetPropertyIds( rIds );
+}
+
+VCLXMetricField::VCLXMetricField()
+{
+}
+
+VCLXMetricField::~VCLXMetricField()
+{
+}
+
+MetricFormatter *VCLXMetricField::GetMetricFormatter() throw(::com::sun::star::uno::RuntimeException)
+{
+    MetricFormatter *pFormatter = (MetricFormatter *) GetFormatter();
+    if (!pFormatter)
+        throw ::com::sun::star::uno::RuntimeException();
+    return pFormatter;
+}
+
+MetricField *VCLXMetricField::GetMetricField() throw(::com::sun::star::uno::RuntimeException)
+{
+    MetricField *pField = (MetricField *) GetWindow();
+    if (!pField)
+        throw ::com::sun::star::uno::RuntimeException();
+    return pField;
+}
+
+// ::com::sun::star::uno::XInterface
+::com::sun::star::uno::Any VCLXMetricField::queryInterface( const ::com::sun::star::uno::Type & rType ) throw(::com::sun::star::uno::RuntimeException)
+{
+	::com::sun::star::uno::Any aRet = ::cppu::queryInterface( rType,
+                                                              SAL_STATIC_CAST( ::com::sun::star::awt::XMetricField*, this ) );
+	return (aRet.hasValue() ? aRet : VCLXFormattedSpinField::queryInterface( rType ));
+}
+
+// ::com::sun::star::lang::XTypeProvider
+IMPL_XTYPEPROVIDER_START( VCLXMetricField )
+	getCppuType( ( ::com::sun::star::uno::Reference< ::com::sun::star::awt::XMetricField>* ) NULL ),
+	VCLXFormattedSpinField::getTypes()
+IMPL_XTYPEPROVIDER_END
+
+// FIXME: later ...
+#define MetricUnitUnoToVcl(a) ((FieldUnit)(a))
+
+#define METRIC_MAP_PAIR(method,parent) \
+    sal_Int64 VCLXMetricField::get##method( sal_Int16 nUnit ) throw (::com::sun::star::uno::RuntimeException) \
+    { \
+    	::vos::OGuard aGuard( GetMutex() ); \
+        return GetMetric##parent()->Get##method( MetricUnitUnoToVcl( nUnit ) ); \
+    } \
+    void VCLXMetricField::set##method( sal_Int64 nValue, sal_Int16 nUnit ) throw (::com::sun::star::uno::RuntimeException) \
+    { \
+    	::vos::OGuard aGuard( GetMutex() ); \
+        GetMetric##parent()->Set##method( nValue, MetricUnitUnoToVcl( nUnit ) ); \
+    }
+
+METRIC_MAP_PAIR(Min, Formatter)
+METRIC_MAP_PAIR(Max, Formatter)
+METRIC_MAP_PAIR(First, Field)
+METRIC_MAP_PAIR(Last,  Field)
+
+#undef METRIC_MAP_SET
+#undef METRIC_MAP_GET
+
+::sal_Int64 VCLXMetricField::getValue( ::sal_Int16 nUnit ) throw (::com::sun::star::uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    return GetMetricFormatter()->GetValue( MetricUnitUnoToVcl( nUnit ) );
+}
+
+::sal_Int64 VCLXMetricField::getCorrectedValue( ::sal_Int16 nUnit ) throw (::com::sun::star::uno::RuntimeException)
+{
+    ::vos::OGuard aGuard( GetMutex() );
+    return GetMetricFormatter()->GetCorrectedValue( MetricUnitUnoToVcl( nUnit ) );
+}
+
+// FIXME: acute cut/paste evilness - move this to the parent Edit class ?
+void VCLXMetricField::CallListeners()
+{
+    // #107218# Call same listeners like VCL would do after user interaction
+    Edit* pEdit = (Edit*)GetWindow();
+    if ( pEdit )
+    {
+        SetSynthesizingVCLEvent( sal_True );
+        pEdit->SetModifyFlag();
+        pEdit->Modify();
+        SetSynthesizingVCLEvent( sal_False );
+	}
+}
+
+void VCLXMetricField::setValue( ::sal_Int64 Value, ::sal_Int16 Unit ) throw (::com::sun::star::uno::RuntimeException)
+{
+	::vos::OGuard aGuard( GetMutex() );
+    GetMetricFormatter()->SetValue( Value, MetricUnitUnoToVcl( Unit ) );
+    CallListeners();
+}
+
+void VCLXMetricField::setUserValue( ::sal_Int64 Value, ::sal_Int16 Unit ) throw (::com::sun::star::uno::RuntimeException)
+{
+	::vos::OGuard aGuard( GetMutex() );
+    GetMetricFormatter()->SetUserValue( Value, MetricUnitUnoToVcl( Unit ) );
+    CallListeners();
+}
+
+void VCLXMetricField::setStrictFormat( sal_Bool bStrict ) throw(::com::sun::star::uno::RuntimeException)
+{
+	VCLXFormattedSpinField::setStrictFormat( bStrict );
+}
+
+sal_Bool VCLXMetricField::isStrictFormat() throw(::com::sun::star::uno::RuntimeException)
+{
+	return VCLXFormattedSpinField::isStrictFormat();
+}
+
+void VCLXMetricField::setSpinSize( sal_Int64 Value ) throw(::com::sun::star::uno::RuntimeException)
+{
+	::vos::OGuard aGuard( GetMutex() );
+    GetMetricField()->SetSpinSize( Value );
+}
+
+sal_Int64 VCLXMetricField::getSpinSize() throw(::com::sun::star::uno::RuntimeException)
+{
+	::vos::OGuard aGuard( GetMutex() );
+    return GetMetricField()->GetSpinSize();
+}
+
+void VCLXMetricField::setDecimalDigits( sal_Int16 Value ) throw(::com::sun::star::uno::RuntimeException)
+{
+	::vos::OGuard aGuard( GetMutex() );
+    GetMetricFormatter()->SetDecimalDigits( Value );
+}
+
+sal_Int16 VCLXMetricField::getDecimalDigits() throw(::com::sun::star::uno::RuntimeException)
+{
+	::vos::OGuard aGuard( GetMutex() );
+
+	NumericFormatter* pNumericFormatter = (NumericFormatter*) GetFormatter();
+	return pNumericFormatter ? pNumericFormatter->GetDecimalDigits() : 0;
+}
+
+void VCLXMetricField::setProperty( const ::rtl::OUString& PropertyName, const ::com::sun::star::uno::Any& Value) throw(::com::sun::star::uno::RuntimeException)
+{
+	::vos::OGuard aGuard( GetMutex() );
+
+	if ( GetWindow() )
+	{
+		sal_Bool bVoid = Value.getValueType().getTypeClass() == ::com::sun::star::uno::TypeClass_VOID;
+
+		sal_uInt16 nPropType = GetPropertyId( PropertyName );
+		switch ( nPropType )
+		{
+			case BASEPROPERTY_DECIMALACCURACY:
+			{
+				sal_Int16 n = sal_Int16();
+				if ( Value >>= n )
+ 					setDecimalDigits( n );
+			}
+			break;
+			case BASEPROPERTY_NUMSHOWTHOUSANDSEP:
+			{
+				sal_Bool b = sal_Bool();
+				if ( Value >>= b )
+ 					((NumericField*)GetWindow())->SetUseThousandSep( b );
+			}
+			break;
+			default:
+			{
+				VCLXFormattedSpinField::setProperty( PropertyName, Value );
+			}
+		}
+	}
+}
+
+::com::sun::star::uno::Any VCLXMetricField::getProperty( const ::rtl::OUString& PropertyName ) throw(::com::sun::star::uno::RuntimeException)
+{
+	::vos::OGuard aGuard( GetMutex() );
+
+	::com::sun::star::uno::Any aProp;
+	FormatterBase* pFormatter = GetFormatter();
+	if ( pFormatter )
+	{
+		sal_uInt16 nPropType = GetPropertyId( PropertyName );
+		switch ( nPropType )
+		{
+			case BASEPROPERTY_NUMSHOWTHOUSANDSEP:
+			{
+			    aProp <<= (sal_Bool) ((NumericField*)GetWindow())->IsUseThousandSep();
+			}
+			break;
+			default:
+			{
+				aProp <<= VCLXFormattedSpinField::getProperty( PropertyName );
+			}
+		}
+	}
+	return aProp;
+}
+
+
+//	----------------------------------------------------
 //	class VCLXCurrencyField
 //	----------------------------------------------------
 
