Index: ucb/source/ucp/tdoc/tdoc_docmgr.cxx
===================================================================
RCS file: /cvs/ucb/ucb/source/ucp/tdoc/tdoc_docmgr.cxx,v
retrieving revision 1.11
diff -u -p -r1.11 tdoc_docmgr.cxx
--- ucb/source/ucp/tdoc/tdoc_docmgr.cxx	3 Nov 2005 12:39:48 -0000	1.11
+++ ucb/source/ucp/tdoc/tdoc_docmgr.cxx	25 Jan 2006 16:28:27 -0000
@@ -229,7 +229,10 @@ void SAL_CALL OfficeDocumentsManager::no
     if ( Event.EventName.equalsAsciiL(
                 RTL_CONSTASCII_STRINGPARAM( "OnLoadFinished" ) ) // document loaded
          || Event.EventName.equalsAsciiL(
-                RTL_CONSTASCII_STRINGPARAM( "OnCreate" ) ) ) // document created
+                RTL_CONSTASCII_STRINGPARAM( "OnCreate" ) ) 
+         || Event.EventName.equalsAsciiL(
+                RTL_CONSTASCII_STRINGPARAM( "OnNew" ) ) 
+    ) // document created
     {
         if ( isOfficeDocument( Event.Source ) )
         {
@@ -239,12 +242,29 @@ void SAL_CALL OfficeDocumentsManager::no
                  xModel( Event.Source, uno::UNO_QUERY );
             OSL_ENSURE( xModel.is(), "Got no frame::XModel!" );
 
-            DocumentList::const_iterator it = m_aDocs.begin();
+            DocumentList::iterator it = m_aDocs.begin();
             while ( it != m_aDocs.end() )
             {
                 if ( (*it).second.xModel == xModel )
                 {
-                    // already known.
+                    // doc is already known.
+                    // but... for templates event OnNew can signal the
+                    // new temporary storage the doc it uses, so examine
+                    // the xStorage for the Model and change it
+                    // if different from existing
+                    if ( Event.EventName.equalsAsciiL(
+                        RTL_CONSTASCII_STRINGPARAM( "OnNew" ) ) )
+                    {
+                        uno::Reference< document::XStorageBasedDocument >
+                        xDoc( Event.Source, uno::UNO_QUERY );
+                        OSL_ENSURE( xDoc.is(), "Got no document::XStorageBasedDocument!" );
+
+                        uno::Reference< embed::XStorage > xStorage
+                    	    = xDoc->getDocumentStorage();
+                        OSL_ENSURE( xDoc.is(), "Got no document storage!" );
+                        if ( ! ( xStorage == (*it).second.xStorage ) )
+                            (*it).second.xStorage  = xStorage;
+                    }
                     break;
                 }
                 ++it;
