Index: svx/source/form/fmundo.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/form/fmundo.cxx,v
retrieving revision 1.40
diff -u -p -r1.40 fmundo.cxx
--- svx/source/form/fmundo.cxx	24 Oct 2006 15:12:39 -0000	1.40
+++ svx/source/form/fmundo.cxx	21 Jun 2007 19:43:39 -0000
@@ -152,6 +152,7 @@
 #include <comphelper/stl_types.hxx>
 #endif
 
+
 using namespace ::com::sun::star::uno;
 using namespace ::com::sun::star::awt;
 using namespace ::com::sun::star::beans;
@@ -164,6 +165,90 @@ using namespace ::com::sun::star::reflec
 using namespace ::com::sun::star::form::binding;
 using namespace ::svxform;
 
+
+#include <com/sun/star/script/XScriptListener.hdl>
+#include <comphelper/processfactory.hxx>
+#include <cppuhelper/implbase1.hxx>
+
+typedef cppu::WeakImplHelper1< XScriptListener > ScriptEventListener_BASE;
+class ScriptEventListenerWrapper : public ScriptEventListener_BASE
+{
+public:
+	ScriptEventListenerWrapper( FmFormModel& _rModel) throw ( RuntimeException ) : pModel(&_rModel) 
+	{
+		Reference < XPropertySet > xProps(
+			::comphelper::getProcessServiceFactory(), UNO_QUERY );
+		if ( xProps.is() )
+		{
+			Reference< XComponentContext > xCtx( xProps->getPropertyValue(
+				rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "DefaultContext" ))), UNO_QUERY );
+			if ( xCtx.is() )
+			{
+				Reference< XMultiComponentFactory > xMFac( 
+					xCtx->getServiceManager(), UNO_QUERY );
+				if ( xMFac.is() )
+				{
+					m_vbaListener.set( xMFac->createInstanceWithContext( 
+						rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( 
+							"ooo.vba.EventListener"  ) ), xCtx ), 
+								UNO_QUERY_THROW );
+				}
+			}
+		}
+	}
+    // XEventListener
+    virtual void SAL_CALL disposing(const EventObject& ) throw( RuntimeException ){}
+
+    // XScriptListener
+    virtual void SAL_CALL firing(const  ScriptEvent& evt) throw(RuntimeException)	
+	{
+		setModel();
+		if ( m_vbaListener.is() )
+		{
+			m_vbaListener->firing( evt );	
+		}
+	}
+
+    virtual Any SAL_CALL approveFiring(const ScriptEvent& evt) throw( com::sun::star::reflection::InvocationTargetException, RuntimeException)
+	{
+		setModel();
+		if ( m_vbaListener.is() )
+		{
+			return m_vbaListener->approveFiring( evt );	
+		}
+		return Any();	
+	}
+    
+private:
+	void setModel()
+	{
+		Reference< XPropertySet > xProps( m_vbaListener, UNO_QUERY );
+		if ( xProps.is() )
+		{
+			try
+			{
+				SfxObjectShellRef xObjSh = pModel->GetObjectShell();
+				if ( xObjSh.Is() && m_vbaListener.is() )
+				{
+					Any aVal;
+					aVal <<= xObjSh->GetModel();
+					xProps->setPropertyValue( 
+						::rtl::OUString( RTL_CONSTASCII_USTRINGPARAM( "Model" ) ), 
+						aVal );
+				}
+			}
+			catch( Exception& e )
+			{
+				//swallow any errors
+			}
+		}
+	}
+    FmFormModel* pModel;
+	Reference< XScriptListener > m_vbaListener;
+
+
+};
+
 //------------------------------------------------------------------------------
 // some helper structs for caching property infos
 //------------------------------------------------------------------------------
@@ -206,6 +291,13 @@ FmXUndoEnvironment::FmXUndoEnvironment(F
                    ,m_bDisposed( false )
 {
 	DBG_CTOR(FmXUndoEnvironment,NULL);
+	try
+	{
+		m_vbaListener =  new ScriptEventListenerWrapper( _rModel );
+	}
+	catch( Exception& )
+	{
+	}
 }
 
 //------------------------------------------------------------------------------
@@ -784,9 +876,17 @@ void FmXUndoEnvironment::switchListening
 	    Reference< XEventAttacherManager > xManager( _rxContainer, UNO_QUERY );
 	    if ( xManager.is() )
             if ( _bStartListening )
+            {
 		        m_pScriptingEnv->registerEventAttacherManager( xManager );
+			if ( m_vbaListener.is() )
+				xManager->addScriptListener( m_vbaListener );
+            }
             else
+            {
 		        m_pScriptingEnv->revokeEventAttacherManager( xManager );
+			if ( m_vbaListener.is() )
+				xManager->removeScriptListener( m_vbaListener );
+            }
 
         // also handle all children of this element
 	    sal_uInt32 nCount = _rxContainer->getCount();
